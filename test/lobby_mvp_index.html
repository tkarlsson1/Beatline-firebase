<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NOTESTREAM ‚Äì0.654 (TEST)</title>
  <meta name="theme-color" content="#111827" />
  <style>
    :root { --bg:#0b1020; --fg:#e5e7eb; --mut:#9ca3af; --acc:#06b6d4; --danger:#ef4444; --panel:#0e152e; --border:#111827; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);background:var(--panel);position:sticky;top:0;z-index:10}
    h1{font-size:18px;margin:0;font-weight:600}
    main{max-width:960px;margin:0 auto;padding:16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 2px 16px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    label{display:block;font-size:12px;color:var(--mut);margin-bottom:6px}
    input,select,button{border-radius:12px;border:1px solid #1f2937;background:#0b1228;color:var(--fg);padding:10px 12px;font-size:14px}
    button.primary{background:linear-gradient(180deg,#0891b2,#0284c7);border-color:#0369a1}
    button.ghost{background:transparent;border-color:#283146}
    button:disabled{opacity:.6}
    .mut{color:var(--mut)}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;background:#0b1228;border:1px solid #1f2937;border-radius:8px;padding:2px 6px}
    .teams{display:flex;flex-wrap:wrap;gap:8px}
    .chip{background:#0b1228;border:1px solid #1f2937;border-radius:20px;padding:6px 10px;font-size:13px}
    .qr{display:grid;place-items:center;background:#0b1228;border:1px dashed #1f2937;border-radius:16px;min-height:260px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    a{color:#67e8f9;text-decoration:none}
    .ok{color:#10b981} .warn{color:#f59e0b} .err{color:#ef4444}
    /* Device modal */
    .device-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5)}
    .device-card{background:var(--panel);border:1px solid var(--border);border-radius:14px;max-width:520px;width:90%;padding:16px}
    .device-list{display:grid;gap:8px;margin-top:8px}
    .device-item{display:flex;justify-content:space-between;align-items:center;border:1px solid #1f2937;border-radius:12px;padding:10px 12px;background:#0b1228;cursor:pointer}
    .device-item:hover{background:#0d1733}
  </style>
</head>
<body>
  <header>
    <h1>üéµ Beatline ‚Äì Lobby (MVP)</h1>
    <div id="authBadge" class="mut">‚Ä¶</div>
  </header>
  <main>
    <section id="screenLobby" class="grid" style="display:none">
      <div class="card">
        <h2 style="margin:0 0 8px 0">Lobby <span class="mut mono" id="lblId"></span></h2>

        <div class="row">
          <div style="flex:1;min-width:280px">
            <label>Join-l√§nk</label>
            <div class="mono" id="joinUrl" style="word-break:break-all"></div>
            <div class="qr" style="margin-top:8px"><img id="qrImg" alt="QR"/></div>

            <div style="margin-top:16px">
              <label>Val (f√∂rhandsvy)</label>
              <div id="settingsPreview" class="mut" style="white-space:pre-line"></div>
            </div>
          </div>

          <div style="flex:1;min-width:280px">
            <label>Lag</label>
            <div id="teams" class="teams" style="min-height:42px"></div>

            <div style="margin-top:16px">
              <h3 style="margin:0 0 6px 0">Spotify</h3>
              <p id="spStatus" class="mut" style="margin:0 0 8px 0">Inte kopplad</p>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button id="btnSpotify" class="ghost">Koppla Spotify</button>
                <button id="btnPickDevice" class="ghost" disabled>V√§lj enhet</button>
              </div>
              <div id="deviceChosen" class="mut" style="margin-top:6px"></div>
            </div>

            <div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap">
              <button id="btnStart" class="primary" disabled>Starta spel</button>
              <button id="btnLeave" class="ghost">L√§mna lobby</button>
            </div>
            <p id="lobbyHint" class="mut" style="margin-top:8px">Koppla Spotify och v√§lj enhet innan start. QR-fallback finns.</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Device modal -->
  <div id="deviceModal" class="device-modal" aria-hidden="true">
    <div class="device-card" role="dialog" aria-modal="true" aria-labelledby="deviceTitle">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="deviceTitle" style="margin:0">V√§lj Connect-enhet</h3>
        <button id="btnCloseDevice" class="ghost" aria-label="St√§ng">St√§ng</button>
      </div>
      <div id="deviceList" class="device-list"></div>
    </div>
  </div>

  <script type="module">
    // ==== Firebase (RTDB) init ====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getDatabase, ref, set, get, child, onValue, update, push } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAfv4yGrI7Vj5PaX0A_XFRn0P4U--S9tFA",
      authDomain: "beatlinefirebase.firebaseapp.com",
      databaseURL: "https://notestreamfire.europe-west1.firebasedatabase.app",
      projectId: "beatlinefirebase",
      appId: "1:196231817325:web:d5603a36a9c2c5f247f764"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ==== UI helpers ====
    const $ = (id)=>document.getElementById(id);
    const screenLobby = $('screenLobby');
    const lblId = $('lblId');
    const joinUrlEl = $('joinUrl');
    const qrImg = $('qrImg');
    const teamsEl = $('teams');
    const btnStart = $('btnStart');
    const btnLeave = $('btnLeave');
    const spStatus = $('spStatus');
    const btnSpotify = $('btnSpotify');
    const btnPickDevice = $('btnPickDevice');
    const settingsPreview = $('settingsPreview');
    const deviceModal = $('deviceModal');
    const deviceList = $('deviceList');
    const btnCloseDevice = $('btnCloseDevice');
    const deviceChosen = $('deviceChosen');

    function showSection(el, on){ el.style.display = on? 'block':'none'; }
    function setAuthBadge(u){
      const el = document.getElementById('authBadge');
      if(u){ el.innerHTML = `UID: <span class="kbd">${u.uid.slice(0,8)}‚Ä¶</span>`; }
      else el.textContent = 'inte inloggad';
    }

    // ==== Routing (#pre/<id> eller #lobby/<id>) ====
    let currentMode = null; // 'pre' | 'lobby'
    let currentId = null;
    function parseHash(){
      const [p, id] = (location.hash.replace(/^#/, '')||'').split('/');
      currentMode = p || null;
      currentId = id || null;
    }
    function route(){
      parseHash();
      showSection(screenLobby, !!currentMode);
      if(currentMode === 'pre' && currentId) bindPre(currentId);
      if(currentMode === 'lobby' && currentId) bindLobby(currentId);
    }
    window.addEventListener('hashchange', route);

    // ==== Auth ====
    onAuthStateChanged(auth, (u)=>{
      setAuthBadge(u);
      if(u) route();
    });
    signInAnonymously(auth).catch(console.error);

    // ==== Bind pre-lobby ====
    let unsubPre = null;
    async function bindPre(preId){
      lblId.textContent = `#pre/${preId}`;
      const deepLink = `${location.origin}${location.pathname}#join/${preId}`; // vi anv√§nder join via preId i MVP
      joinUrlEl.textContent = deepLink;
      qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${encodeURIComponent(deepLink)}`;

      // L√§s och visa settings
      const stSnap = await get(ref(db, `prelobbies/${preId}/settings`));
      const st = stSnap.val() || {};
      const std = Array.isArray(st.standardListIds) ? st.standardListIds : [];
      const yr = `√Ör: ${st.yearMin ?? '?'}‚Äì${st.yearMax ?? '?'}`;
      const tok = `Tokens/lag: ${st.tokensPerTeam ?? 4}, Vinst: ${st.winCards ?? 11}`;
      settingsPreview.textContent = `Standardlistor (${std.length}): ${std.join(', ') || '‚Äî'}\n${yr}\n${tok}`;

      // Start-knapp aktiv direkt (host kr√§vs f√∂r start, men vi l√•ser upp UI)
      btnStart.disabled = false;

      // ‚ÄúL√§mna‚Äù bara back
      btnLeave.onclick = ()=> history.back();

      // Teams ‚Äì i MVP listar vi inte per pre, utan f√∂rst n√§r det blivit game
      teamsEl.innerHTML = '<span class="mut">Lag visas efter start (i games/*).</span>';
    }

    // ==== Promote pre ‚Üí game och starta ====
    async function promotePreToGame(preId){
      const u = auth.currentUser; if(!u) throw new Error('Inte inloggad');
      const preSnap = await get(ref(db, `prelobbies/${preId}/settings`));
      if(!preSnap.exists()) throw new Error('prelobby saknas');
      const settings = preSnap.val() || {};

      const newRef = push(ref(db, 'games'));
      const gameId = newRef.key;
      await set(newRef, {
        phase: 'lobby',
        hostId: u.uid,
        settings,
        teams: {}
      });

      // Byt URL till #lobby/<gameId> och bind nya lobbyn
      location.hash = `lobby/${gameId}`;
      return gameId;
    }

    // ==== Bind lobby ====
    let unsubLobby = null;
    async function bindLobby(gameId){
      lblId.textContent = `#lobby/${gameId}`;
      const deepLink = `${location.origin}${location.pathname}#join/${gameId}`;
      joinUrlEl.textContent = deepLink;
      qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${encodeURIComponent(deepLink)}`;

      if(unsubLobby) unsubLobby();
      const base = ref(db, `games/${gameId}`);
      unsubLobby = onValue(base, snap=>{
        const g = snap.val() || {};
        // teams
        teamsEl.innerHTML = '';
        const teams = g.teams ? Object.entries(g.teams) : [];
        for(const [tid,t] of teams){
          const div = document.createElement('div');
          div.className = 'chip';
          div.textContent = `${t.name || '??'}${t.tokens!=null?' ‚Ä¢ '+t.tokens+' tok':''}`;
          teamsEl.appendChild(div);
        }
        // settings preview
        const st = g.settings || {};
        const std = Array.isArray(st.standardListIds) ? st.standardListIds : [];
        const yr = `√Ör: ${st.yearMin ?? '?'}‚Äì${st.yearMax ?? '?'}`;
        const tok = `Tokens/lag: ${st.tokensPerTeam ?? 4}, Vinst: ${st.winCards ?? 11}`;
        settingsPreview.textContent = `Standardlistor (${std.length}): ${std.join(', ') || '‚Äî'}\n${yr}\n${tok}`;

        // host kan starta om minst 1 lag (valfritt krav i MVP)
        const isHost = auth.currentUser && g.hostId === auth.currentUser.uid;
        btnStart.disabled = !isHost;
      });

      btnLeave.onclick = ()=> history.back();
    }

    // ==== Starta spel (hanterar b√•de #pre och #lobby) ====
    async function startGame(){
      const u = auth.currentUser; if(!u) throw new Error('Inte inloggad');
      const token = await u.getIdToken();

      parseHash();
      let gameId = currentId;

      if(currentMode === 'pre'){
        // 1) Skapa games/<id> fr√•n prelobby
        gameId = await promotePreToGame(currentId);
        // route() triggas automatiskt via hash-√§ndring, men vi forts√§tter direkt
      }

      // 2) ropa hostStartHttp
      const url = `https://europe-west1-beatlinefirebase.cloudfunctions.net/hostStartHttp?gameId=${encodeURIComponent(gameId)}`;
      const resp = await fetch(url, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token },
        body: '{}'
      });
      const j = await resp.json();
      if(!resp.ok) throw new Error(JSON.stringify(j));

      alert(`Spelet startades! Kort i lek: ${j.deckCount}. Server s√§tter phase=playing.`);
      // Navigera till game-sidan
      location.href = `${location.origin}/test/game_mvp.html#game/${gameId}`;
    }

    btnStart.addEventListener('click', ()=> startGame().catch(e=>{
      console.error(e);
      alert('Kunde inte starta spel: ' + (e.message || e));
    }));

    // ==== Spotify PKCE + enhetsval ====
    const SPOTIFY_CLIENT_ID = '3033344ef55647b8b70ef1dccfa7e65f';
    const REDIRECT = location.origin + location.pathname; // √•ter till samma sida
    const SPOTIFY_SCOPES = 'streaming user-read-email user-read-private user-modify-playback-state user-read-playback-state';

    function b64url(buf){return btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');}
    async function sha256(txt){const data=new TextEncoder().encode(txt);return await crypto.subtle.digest('SHA-256',data)}
    function randStr(len){const arr=new Uint8Array(len);crypto.getRandomValues(arr);return Array.from(arr).map(b=>('0'+(b%36).toString(36)).slice(-1)).join('');}

    async function withSpToken(){
      const raw = localStorage.getItem('sp_token'); if(!raw) throw new Error('Ej inloggad mot Spotify');
      const tok = JSON.parse(raw);
      if(Date.now() < tok.expires_at) return tok.access_token;
      const res = await fetch('https://accounts.spotify.com/api/token',{
        method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:new URLSearchParams({ grant_type:'refresh_token', refresh_token:tok.refresh_token, client_id:SPOTIFY_CLIENT_ID })
      });
      const j = await res.json();
      tok.access_token = j.access_token; tok.expires_at = Date.now() + (j.expires_in*1000 - 60000);
      localStorage.setItem('sp_token', JSON.stringify(tok));
      return tok.access_token;
    }

    // Koppla Spotify
    btnSpotify.addEventListener('click', async ()=>{
      const verifier = randStr(64);
      const challenge = b64url(await sha256(verifier));
      sessionStorage.setItem('sp_verifier', verifier);
      const url = new URL('https://accounts.spotify.com/authorize');
      url.searchParams.set('client_id', SPOTIFY_CLIENT_ID);
      url.searchParams.set('response_type', 'code');
      url.searchParams.set('redirect_uri', REDIRECT);
      url.searchParams.set('code_challenge_method', 'S256');
      url.searchParams.set('code_challenge', challenge);
      url.searchParams.set('scope', SPOTIFY_SCOPES);
      url.searchParams.set('show_dialog', 'true');
      location.href = url.toString();
    });

    // Hantera callback (om ?code=‚Ä¶)
    (async function handleSpotifyCallback(){
      const code = new URLSearchParams(location.search).get('code');
      if(!code) {
        // Om token redan finns ‚Äì visa status och f√∂rs√∂k enhetslista direkt
        if(localStorage.getItem('sp_token')){
          spStatus.innerHTML = '<span class="ok">Spotify kopplad</span>';
          btnPickDevice.disabled = false;
          try { await openDeviceModal(true); } catch(_) {}
        }
        return;
      }
      const verifier = sessionStorage.getItem('sp_verifier');
      if(!verifier){ spStatus.textContent = 'Spotify: saknar verifier'; return; }
      try{
        const tokenRes = await fetch('https://accounts.spotify.com/api/token',{
          method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body: new URLSearchParams({ grant_type:'authorization_code', code, client_id: SPOTIFY_CLIENT_ID, redirect_uri: REDIRECT, code_verifier: verifier })
        });
        const token = await tokenRes.json();
        if(!token.access_token) throw new Error(JSON.stringify(token));
        localStorage.setItem('sp_token', JSON.stringify({ access_token: token.access_token, refresh_token: token.refresh_token, expires_at: Date.now() + (token.expires_in*1000 - 60000) }));
        history.replaceState({},'', location.origin + location.pathname + location.hash); // ta bort ?code men beh√•ll hash
        spStatus.innerHTML = '<span class="ok">Spotify kopplad</span>';
        btnPickDevice.disabled = false;
        await openDeviceModal(true);
      }catch(e){ spStatus.innerHTML = '<span class="err">Spotify-koppling misslyckades</span>'; console.error(e); }
    })();

    // Enhetsval (modal + klick)
    btnPickDevice.addEventListener('click', ()=> openDeviceModal());

    async function openDeviceModal(autoOpen=false){
      try{
        const at = await withSpToken();
        const r = await fetch('https://api.spotify.com/v1/me/player/devices',{ headers:{ Authorization: 'Bearer '+at }});
        const j = await r.json();
        deviceList.innerHTML = '';
        if(!j.devices || !j.devices.length){
          deviceList.innerHTML = '<div class="mut">Inga Connect-enheter hittades. √ñppna Spotify p√• en enhet och f√∂rs√∂k igen.</div>';
        }else{
          for(const d of j.devices){
            const row = document.createElement('div');
            row.className = 'device-item';
            row.innerHTML = `<div>${d.name} <span class="mut">(${d.type})${d.is_active?' ‚Ä¢ aktiv':''}</span></div><div class="kbd">${d.id.slice(0,6)}‚Ä¶</div>`;
            row.addEventListener('click', async ()=>{
              try{
                // transfer playback
                const put = await fetch('https://api.spotify.com/v1/me/player',{
                  method:'PUT',
                  headers:{ Authorization: 'Bearer '+at, 'Content-Type':'application/json' },
                  body: JSON.stringify({ device_ids:[d.id], play:false })
                });
                if(put.status===204){
                  localStorage.setItem('sp_device_id', d.id);
                  deviceChosen.innerHTML = `Enhet vald: <span class="kbd">${d.name}</span>`;
                  closeDeviceModal();
                }else{
                  alert('Kunde inte v√§lja enhet ('+put.status+')');
                }
              }catch(err){ console.error(err); alert('Fel vid val av enhet'); }
            });
            deviceList.appendChild(row);
          }
        }
        deviceModal.style.display = 'flex';
        deviceModal.setAttribute('aria-hidden','false');
        if(!autoOpen) btnCloseDevice.focus();
      }catch(e){
        console.error(e);
        alert('Kunde inte h√§mta enheter');
      }
    }
    function closeDeviceModal(){
      deviceModal.style.display = 'none';
      deviceModal.setAttribute('aria-hidden','true');
    }
    btnCloseDevice.addEventListener('click', closeDeviceModal);
    deviceModal.addEventListener('click', (e)=>{ if(e.target===deviceModal) closeDeviceModal(); });

    // ==== Boot ====
    // Visa lobbyvy direkt om hash finns
    showSection(screenLobby, true);
    route();
  </script>
</body>
</html>
