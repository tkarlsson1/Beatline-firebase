<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NOTESTREAM ‚Äì0.646 (TEST)</title>
  <meta name="theme-color" content="#111827" />
  <style>
    :root { --bg:#0b1020; --fg:#e5e7eb; --mut:#9ca3af; --acc:#06b6d4; --danger:#ef4444; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #111827;background:#0e152e;position:sticky;top:0;z-index:10}
    h1{font-size:18px;margin:0;font-weight:600}
    main{max-width:900px;margin:0 auto;padding:16px}
    .card{background:#0e152e;border:1px solid #111827;border-radius:14px;padding:16px;box-shadow:0 2px 16px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    label{display:block;font-size:12px;color:var(--mut);margin-bottom:6px}
    input,select,button{border-radius:12px;border:1px solid #1f2937;background:#0b1228;color:var(--fg);padding:10px 12px;font-size:14px}
    input:disabled,button:disabled{opacity:.55}
    button.primary{background:linear-gradient(180deg,#0891b2,#0284c7);border-color:#0369a1}
    button.ghost{background:transparent;border-color:#283146}
    .mut{color:var(--mut)}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;background:#0b1228;border:1px solid #1f2937;border-radius:8px;padding:2px 6px}
    .teams{display:flex;flex-wrap:wrap;gap:8px}
    .chip{background:#0b1228;border:1px solid #1f2937;border-radius:20px;padding:6px 10px;font-size:13px}
    .qr{display:grid;place-items:center;background:#0b1228;border:1px dashed #1f2937;border-radius:16px;min-height:260px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    a{color:#67e8f9;text-decoration:none}
    .ok{color:#10b981} .warn{color:#f59e0b} .err{color:#ef4444}
    .device-list{display:grid;gap:8px;margin-top:8px}
    .device-list button{width:100%;text-align:left;padding:10px 12px;border-radius:12px;border:1px solid #2a3553;background:#0b1228}
    .device-list button:hover{border-color:#3a4a78}
  </style>
</head>
<body>
  <header>
    <h1>üéµ Beatline ‚Äì Lobby (MVP)</h1>
    <div id="authBadge" class="mut">‚Ä¶</div>
  </header>
  <main>
    <!-- START / screen -->
    <section id="screenStart" class="grid" style="display:none">
      <div class="card grid cols-2">
        <div>
          <h2 style="margin:0 0 8px 0">Skapa lobby</h2>
          <p class="mut">L√•tlistor kommer via pre-lobby-token fr√•n startsidan.</p>

          <!-- Sammanfattning av val fr√•n startsidan (pre-lobby) -->
          <div id="preSummary" class="card" style="margin:12px 0; display:none;">
            <h3 style="margin:0 0 6px 0">Val fr√•n startsidan</h3>
            <div id="preSummaryBody" class="mut">Laddar‚Ä¶</div>
          </div>

          <div class="grid cols-2">
            <div>
              <label>Fr√•n √•r</label>
              <input id="yearMin" type="number" min="1900" max="2099" value="1960" />
            </div>
            <div>
              <label>Till √•r</label>
              <input id="yearMax" type="number" min="1900" max="2099" value="2025" />
            </div>
            <div>
              <label>Drag-tid (sek)</label>
              <input id="tDrag" type="number" min="15" max="300" value="90" />
            </div>
            <div>
              <label>Utmaningsf√∂nster (sek)</label>
              <input id="tClaim" type="number" min="5" max="60" value="10" />
            </div>
            <div>
              <label>Opp-drag (sek)</label>
              <input id="tOpp" type="number" min="5" max="120" value="20" />
            </div>
            <div>
              <label>Tokens / lag</label>
              <input id="tokensPerTeam" type="number" min="0" max="20" value="4" />
            </div>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button id="btnCreate" class="primary">Skapa lobby</button>
            <button id="btnGotoJoin" class="ghost">G√• till join-vy</button>
          </div>
          <p class="mut" style="margin-top:8px">Max 8 lag ‚Ä¢ Vinst: 11 kort ‚Ä¢ Sen ankomst: ej till√•ten</p>
        </div>
        <div>
          <h3 style="margin:0 0 8px 0">Spotify (host)</h3>
          <p id="spStatus" class="mut">Inte kopplad</p>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btnSpotify" class="ghost">Koppla Spotify</button>
            <button id="btnPickDevice" class="ghost" disabled>V√§lj enhet</button>
          </div>
          <div id="deviceArea" class="device-list"></div>
          <p class="mut" style="margin-top:8px">Scopes: streaming, read email/private, modify/read playback</p>
        </div>
      </div>
    </section>

    <!-- LOBBY / screen -->
    <section id="screenLobby" class="grid" style="display:none">
      <div class="card">
        <h2 style="margin:0 0 8px 0">Lobby <span class="mut mono" id="lblGameId"></span></h2>
        <div class="row">
          <div style="flex:1">
            <label>Join-l√§nk</label>
            <div class="mono" id="joinUrl" style="word-break:break-all"></div>
            <div class="qr" style="margin-top:8px"><img id="qrImg" alt="QR"/></div>
          </div>
          <div style="flex:1">
            <label>Lag</label>
            <div id="teams" class="teams"></div>
            <div style="margin-top:12px;display:flex;gap:8px">
              <button id="btnStart" class="primary" disabled>Starta spel</button>
              <button id="btnLeave" class="ghost">L√§mna lobby</button>
            </div>
            <p id="lobbyHint" class="mut">Koppla Spotify och v√§lj enhet innan start f√∂r uppspelning via Connect. QR-fallback finns.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- JOIN / screen -->
    <section id="screenJoin" class="grid" style="display:none">
      <div class="card">
        <h2 style="margin:0 0 8px 0">G√• med i spel</h2>
        <p class="mut">Skriv lagnamn f√∂r att g√• med i <span id="joinGameId" class="mono"></span></p>
        <div class="row">
          <input id="inpTeamName" placeholder="Lagnamn" maxlength="24" style="flex:1" />
          <button id="btnJoin" class="primary">G√• med</button>
        </div>
        <p id="joinMsg" class="mut"></p>
      </div>
    </section>
  </main>

  <script type="module">
    // ==== Firebase (RTDB) init ====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getDatabase, ref, set, get, child, onValue, update, push } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAfv4yGrI7Vj5PaX0A_XFRn0P4U--S9tFA",
      authDomain: "beatlinefirebase.firebaseapp.com",
      databaseURL: "https://notestreamfire.europe-west1.firebasedatabase.app",
      projectId: "beatlinefirebase",
      appId: "1:196231817325:web:d5603a36a9c2c5f247f764"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ==== Spotify helpers ====
    function getStoredToken(){
      const raw = localStorage.getItem('sp_token');
      if(!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }
    function isTokenValid(tok){
      return tok && typeof tok.expires_at === 'number' && Date.now() < tok.expires_at;
    }

    // ==== Pre-lobby state ====
    let preId = null;
    let preSettings = null;

    async function loadPreSettings(id) {
      preId = id;
      preSettings = null;

      const box = document.getElementById('preSummary');
      const body = document.getElementById('preSummaryBody');
      if (box && body) { box.style.display = 'block'; body.textContent = 'Laddar‚Ä¶'; }

      try {
        const snap = await get(ref(db, `prelobbies/${id}/settings`));
        if (!snap.exists()) {
          if (body) body.innerHTML = '<span class="err">Kunde inte hitta pre-lobby-inst√§llningar.</span>';
          return;
        }
        preSettings = snap.val() || {};
        const lists = []
          .concat(preSettings.standardListIds || [])
          .concat(preSettings.userPlaylistIds || []);
        const yearMin = preSettings.yearMin ?? '‚Äì';
        const yearMax = preSettings.yearMax ?? '‚Äì';
        const tokens = preSettings.tokensPerTeam ?? '‚Äì';
        const win = preSettings.winCards ?? '‚Äì';
        if (body) {
          body.innerHTML = `
            <div>Listor: <span class="mono">${lists.length ? lists.join(', ') : '‚Äì'}</span></div>
            <div>√Örtal: <span class="mono">${yearMin}‚Äì${yearMax}</span></div>
            <div>Tokens/lag: <span class="mono">${tokens}</span> ‚Ä¢ Vinst vid: <span class="mono">${win}</span></div>
            <div class="mut" style="margin-top:4px">√Ñgare (UID): <span class="mono">${preSettings.ownerUid || '‚Äì'}</span></div>
          `;
        }
      } catch (e) {
        console.error('prelobby load error', e);
        const body = document.getElementById('preSummaryBody');
        if (body) body.innerHTML = '<span class="err">Fel vid h√§mtning av pre-lobby.</span>';
      }
    }

    // ==== Routing (hash) ====
    function showSection(id, on){ document.getElementById(id).style.display = on?"block":"none"; }

    async function route() {
      const hash = location.hash.replace(/^#/, "");
      const [path, id] = hash.split("/");
      const isPre = path === "pre";
      const showStart = (!path || isPre);

      showSection("screenStart", showStart);
      showSection("screenLobby", path === "lobby");
      showSection("screenJoin", path === "join");

      // Visa Spotify-kopplad status om token redan finns
      if (showStart) {
        const spStatus = document.getElementById('spStatus');
        const pickBtn = document.getElementById('btnPickDevice');
        const tok = getStoredToken();
        if (isTokenValid(tok)) { spStatus.innerHTML = '<span class="ok">Spotify kopplad</span>'; pickBtn.disabled = false; }
      }

      // Om vi √§r i pre-lobby-l√§ge, ladda sammanfattning
      if (isPre && id) {
        await loadPreSettings(id);
      } else {
        const box = document.getElementById('preSummary');
        if (box) box.style.display = 'none';
      }

      if (!path) return;
      if (path === "lobby" && id) loadLobby(id);
      if (path === "join" && id) setupJoin(id);
    }
    window.addEventListener("hashchange", route);

    // ==== Auth badge ====
    onAuthStateChanged(auth, (u)=>{
      const el = document.getElementById('authBadge');
      if(u){ el.innerHTML = `UID: <span class="kbd">${u.uid.slice(0,8)}‚Ä¶</span>`; route(); }
      else el.textContent = 'inte inloggad';
    });
    signInAnonymously(auth).catch(console.error);

    // ==== Create Lobby (skapar games/<gameId> fr√•n preSettings) ====
    const btnCreate = document.getElementById('btnCreate');
    const btnGotoJoin = document.getElementById('btnGotoJoin');
    const btnSpotify = document.getElementById('btnSpotify');
    const btnPickDevice = document.getElementById('btnPickDevice');
    const deviceArea = document.getElementById('deviceArea');

    btnCreate.addEventListener('click', async ()=>{
      try{
        const u = auth.currentUser;
        if(!u) return alert('Inte inloggad');

        // Vi kr√§ver preSettings (kommit hit via #pre/<id>)
        if(!preSettings){
          return alert('Hittar inte val fr√•n startsidan (pre-lobby saknas). G√• tillbaka och skapa lobby fr√•n startsidan.');
        }

        // H√§mta lokala UI-v√§rden (√•r & timers kan justeras h√§r i lobbyn f√∂re skap)
        const yearMin = +document.getElementById('yearMin').value;
        const yearMax = +document.getElementById('yearMax').value;
        const tDrag = +document.getElementById('tDrag').value;
        const tClaim = +document.getElementById('tClaim').value;
        const tOpp = +document.getElementById('tOpp').value;
        const tokensPerTeam = +document.getElementById('tokensPerTeam').value;

        const mergedSettings = {
          // Val fr√•n pre-lobby
          allowLateJoin: preSettings.allowLateJoin ?? false,
          dedupeKey: preSettings.dedupeKey ?? 'spotifyId',
          winCards: preSettings.winCards ?? 11,
          standardListIds: preSettings.standardListIds || [],
          userPlaylistIds: preSettings.userPlaylistIds || [],
          ownerUid: preSettings.ownerUid || u.uid,

          // Justeringar fr√•n UI i denna vy
          yearMin, yearMax,
          tokensPerTeam,
          timers: { dragSec: tDrag, challengePromptSec: tClaim, oppDragSec: tOpp }
        };

        const gameId = (await push(ref(db, 'games'))).key;
        const base = ref(db, `games/${gameId}`);

        await set(child(base, 'phase'), 'lobby');
        await set(child(base, 'hostId'), u.uid);
        await set(child(base, 'settings'), mergedSettings);

        // Hoppa till lobby/<gameId>
        location.hash = `lobby/${gameId}`;
      }catch(e){
        console.error(e);
        alert('Kunde inte skapa lobby. Se console f√∂r detaljer.');
      }
    });

    btnGotoJoin.addEventListener('click', ()=>{
      const gid = prompt('Ange gameId att joina:');
      if(gid) location.hash = `join/${gid}`;
    });

    // ==== Starta spel ‚Üí Cloud Function hostStart ====
    async function startGame(gameId){
      try{
        const u = auth.currentUser;
        if(!u) throw new Error('Inte inloggad');

        const idToken = await u.getIdToken(/* forceRefresh */ true);
        const res = await fetch('https://europe-west1-beatlinefirebase.cloudfunctions.net/hostStart', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + idToken
          },
          body: JSON.stringify({ gameId })
        });

        if(!res.ok){
          const t = await res.text().catch(()=> '');
          throw new Error(t || ('HTTP '+res.status));
        }

        // Vid lyckad start f√∂rv√§ntas servern s√§tta phase="playing".
        // Klienten stannar kvar i lobbyn; UI kan lyssna p√• phase och navigera senare.
        alert('Spelet startades! (phase s√§tts till playing n√§r deck √§r byggt)');
      }catch(e){
        console.error(e);
        // Visa serverfel snyggt om det kommer en kod som t.ex. "deck/empty"
        const msg = (''+e.message || '').trim();
        alert('Kunde inte starta spel: ' + msg);
      }
    }

    // ==== Lobby view ====
    let lobbyUnsub = null;
    async function loadLobby(gameId){
      document.getElementById('lblGameId').textContent = gameId;
      const joinUrl = `${location.origin}${location.pathname}#join/${gameId}`;
      document.getElementById('joinUrl').textContent = joinUrl;
      document.getElementById('qrImg').src = `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${encodeURIComponent(joinUrl)}`;

      const startBtn = document.getElementById('btnStart');
      const leaveBtn = document.getElementById('btnLeave');
      leaveBtn.onclick = ()=> history.back();

      if(lobbyUnsub) lobbyUnsub();
      const base = ref(db, `games/${gameId}`);
      lobbyUnsub = onValue(base, snap=>{
        const v = snap.val()||{};

        // visa lag
        const teamsEl = document.getElementById('teams');
        teamsEl.innerHTML = '';
        const teams = v.teams? Object.entries(v.teams):[];
        for(const [tid,t] of teams){
          const div = document.createElement('div');
          div.className = 'chip';
          div.textContent = `${t.name || '??'}${t.tokens!=null?' ‚Ä¢ '+t.tokens+' tok':''}`;
          teamsEl.appendChild(div);
        }

        const isHost = auth.currentUser && v.hostId === auth.currentUser.uid;
        startBtn.disabled = !(isHost && teams.length>=1);

        // Om server redan har startat (phase=playing), kan vi senare auto-navigera till spelsidan
        // (l√§mnar navigation f√∂r ett senare steg)
        if (v.phase === 'playing') {
          // t.ex.: location.hash = `game/${gameId}`;
        }

        startBtn.onclick = ()=> startGame(gameId);
      });
    }

    // ==== Join view ====
    async function setupJoin(gameId){
      document.getElementById('joinGameId').textContent = gameId;
      const joinBtn = document.getElementById('btnJoin');
      const nameInp = document.getElementById('inpTeamName');
      const msg = document.getElementById('joinMsg');
      joinBtn.onclick = async ()=>{
        const u = auth.currentUser; if(!u) return alert('Inte inloggad');
        const name = (nameInp.value||'').trim();
        if(!name) { msg.textContent = 'Ange lagnamn'; return; }
        const tRef = ref(db, `games/${gameId}/teams/${u.uid}`);
        await set(tRef, { name, tokens: 4, score: 0, joinedAt: Date.now() });
        msg.innerHTML = `Klart! Du √§r med som <span class="mono">${name}</span>.`;
      };
    }

    // ==== Spotify PKCE (bevarar hash via state) ====
    const SPOTIFY_CLIENT_ID = '3033344ef55647b8b70ef1dccfa7e65f';
    const REDIRECT = location.origin + location.pathname;
    const SPOTIFY_SCOPES = 'streaming user-read-email user-read-private user-modify-playback-state user-read-playback-state';

    function b64url(buf){return btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');}
    async function sha256(txt){const data=new TextEncoder().encode(txt);return await crypto.subtle.digest('SHA-256',data)}
    function randStr(len){const arr=new Uint8Array(len);crypto.getRandomValues(arr);return Array.from(arr).map(b=>('0'+(b%36).toString(36)).slice(-1)).join('');}

    btnSpotify.addEventListener('click', async ()=>{
      const verifier = randStr(64);
      const challenge = b64url(await sha256(verifier));
      sessionStorage.setItem('sp_verifier', verifier);

      const currentHash = location.hash || '';
      sessionStorage.setItem('sp_hash', currentHash);

      const url = new URL('https://accounts.spotify.com/authorize');
      url.searchParams.set('client_id', SPOTIFY_CLIENT_ID);
      url.searchParams.set('response_type', 'code');
      url.searchParams.set('redirect_uri', REDIRECT);
      url.searchParams.set('code_challenge_method', 'S256');
      url.searchParams.set('code_challenge', challenge);
      url.searchParams.set('scope', SPOTIFY_SCOPES);
      url.searchParams.set('show_dialog', 'true');
      url.searchParams.set('state', encodeURIComponent(currentHash));
      location.href = url.toString();
    });

    (async function handleSpotifyCallback(){
      const params = new URLSearchParams(location.search);
      const code = params.get('code');
      if(!code) return;

      const spStatus = document.getElementById('spStatus');
      const verifier = sessionStorage.getItem('sp_verifier');
      if(!verifier){ if(spStatus) spStatus.textContent = 'Spotify: saknar verifier'; return; }

      try{
        const tokenRes = await fetch('https://accounts.spotify.com/api/token',{
          method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body: new URLSearchParams({
            grant_type:'authorization_code', code,
            client_id: SPOTIFY_CLIENT_ID, redirect_uri: REDIRECT, code_verifier: verifier
          })
        });
        const token = await tokenRes.json();
        if(!token.access_token) throw new Error(JSON.stringify(token));
        localStorage.setItem('sp_token', JSON.stringify({
          access_token: token.access_token,
          refresh_token: token.refresh_token,
          expires_at: Date.now() + (token.expires_in*1000 - 60000)
        }));
        history.replaceState({},'', location.origin + location.pathname);
        const stateHash = decodeURIComponent(params.get('state') || '') || sessionStorage.getItem('sp_hash') || '';
        if (stateHash) location.hash = stateHash;

        if(spStatus) spStatus.innerHTML = '<span class="ok">Spotify kopplad</span>';
        const pickBtn = document.getElementById('btnPickDevice');
        if(pickBtn) pickBtn.disabled = false;
      }catch(e){
        if(spStatus) spStatus.innerHTML = '<span class="err">Spotify-koppling misslyckades</span>';
        console.error(e);
      }
    })();

    // ==== Boot ====
    route();
  </script>
</body>
</html>
