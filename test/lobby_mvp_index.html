<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NOTESTREAM ‚Äì0.622 (TEST)</title>
  <meta name="theme-color" content="#111827" />
  <style>
    :root { --bg:#0b1020; --fg:#e5e7eb; --mut:#9ca3af; --acc:#06b6d4; --danger:#ef4444; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #111827;background:#0e152e;position:sticky;top:0;z-index:10}
    h1{font-size:18px;margin:0;font-weight:600}
    main{max-width:900px;margin:0 auto;padding:16px}
    .card{background:#0e152e;border:1px solid #111827;border-radius:14px;padding:16px;box-shadow:0 2px 16px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    label{display:block;font-size:12px;color:var(--mut);margin-bottom:6px}
    input,select,button{border-radius:12px;border:1px solid #1f2937;background:#0b1228;color:var(--fg);padding:10px 12px;font-size:14px}
    input:disabled,button:disabled{opacity:.55}
    button.primary{background:linear-gradient(180deg,#0891b2,#0284c7);border-color:#0369a1}
    button.ghost{background:transparent;border-color:#283146}
    .mut{color:var(--mut)}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;background:#0b1228;border:1px solid #1f2937;border-radius:8px;padding:2px 6px}
    .teams{display:flex;flex-wrap:wrap;gap:8px}
    .chip{background:#0b1228;border:1px solid #1f2937;border-radius:20px;padding:6px 10px;font-size:13px}
    .qr{display:grid;place-items:center;background:#0b1228;border:1px dashed #1f2937;border-radius:16px;min-height:260px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    a{color:#67e8f9;text-decoration:none}
    .ok{color:#10b981} .warn{color:#f59e0b} .err{color:#ef4444}
  </style>
</head>
<body>
  <header>
    <h1>üéµ Beatline ‚Äì Lobby (MVP)</h1>
    <div id="authBadge" class="mut">‚Ä¶</div>
  </header>
  <main>
    <!-- START / screen -->
    <section id="screenStart" class="grid" style="display:none">
      <div class="card grid cols-2">
        <div>
          <h2 style="margin:0 0 8px 0">Skapa lobby</h2>
          <p class="mut">V√§lj √•r och timers. L√•tlistor kopplas p√• startsidan senare ‚Äì detta √§r en lobby-MVP.</p>
          <div class="grid cols-2">
            <div>
              <label>Fr√•n √•r</label>
              <input id="yearMin" type="number" min="1900" max="2099" value="1960" />
            </div>
            <div>
              <label>Till √•r</label>
              <input id="yearMax" type="number" min="1900" max="2099" value="2025" />
            </div>
            <div>
              <label>Drag-tid (sek)</label>
              <input id="tDrag" type="number" min="15" max="300" value="90" />
            </div>
            <div>
              <label>Utmaningsf√∂nster (sek)</label>
              <input id="tClaim" type="number" min="5" max="60" value="10" />
            </div>
            <div>
              <label>Opp-drag (sek)</label>
              <input id="tOpp" type="number" min="5" max="120" value="20" />
            </div>
            <div>
              <label>Tokens / lag</label>
              <input id="tokensPerTeam" type="number" min="0" max="20" value="4" />
            </div>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button id="btnCreate" class="primary">Skapa lobby</button>
            <button id="btnGotoJoin" class="ghost">G√• till join-vy</button>
          </div>
          <p class="mut" style="margin-top:8px">Max 8 lag ‚Ä¢ Vinst: 11 kort ‚Ä¢ Sen ankomst: ej till√•ten</p>
        </div>
        <div>
          <h3 style="margin:0 0 8px 0">Spotify (host)</h3>
          <p id="spStatus" class="mut">Inte kopplad</p>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="btnSpotify" class="ghost">Koppla Spotify</button>
            <button id="btnPickDevice" class="ghost" disabled>V√§lj enhet</button>
          </div>
          <p class="mut" style="margin-top:8px">Scopes: streaming, read email/private, modify/read playback</p>
          <div id="deviceList" class="grid" style="margin-top:8px; gap:8px"></div>
        </div>
      </div>
    </section>

    <!-- LOBBY / screen -->
    <section id="screenLobby" class="grid" style="display:none">
      <div class="card">
        <h2 style="margin:0 0 8px 0">Lobby <span class="mut mono" id="lblGameId"></span></h2>
        <div class="row">
          <div style="flex:1">
            <label>Join-l√§nk</label>
            <div class="mono" id="joinUrl" style="word-break:break-all"></div>
            <div class="qr" style="margin-top:8px"><img id="qrImg" alt="QR"/></div>
          </div>
          <div style="flex:1">
            <label>Lag</label>
            <div id="teams" class="teams"></div>
            <div style="margin-top:12px;display:flex;gap:8px">
              <button id="btnStart" class="primary" disabled>Starta spel</button>
              <button id="btnLeave" class="ghost">L√§mna lobby</button>
            </div>
            <p id="lobbyHint" class="mut">Koppla Spotify och v√§lj enhet innan start f√∂r uppspelning via Connect. QR-fallback finns.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- JOIN / screen -->
    <section id="screenJoin" class="grid" style="display:none">
      <div class="card">
        <h2 style="margin:0 0 8px 0">G√• med i spel</h2>
        <p class="mut">Skriv lagnamn f√∂r att g√• med i <span id="joinGameId" class="mono"></span></p>
        <div class="row">
          <input id="inpTeamName" placeholder="Lagnamn" maxlength="24" style="flex:1" />
          <button id="btnJoin" class="primary">G√• med</button>
        </div>
        <p id="joinMsg" class="mut"></p>
      </div>
    </section>
  </main>

  <script type="module">
    // ==== Firebase (RTDB) init ====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getDatabase, ref, set, child, onValue, push } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAfv4yGrI7Vj5PaX0A_XFRn0P4U--S9tFA",
      authDomain: "beatlinefirebase.firebaseapp.com",
      databaseURL: "https://notestreamfire.europe-west1.firebasedatabase.app",
      projectId: "beatlinefirebase",
      appId: "1:196231817325:web:d5603a36a9c2c5f247f764"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ==== Routing (hash) ====
    function route() {
      const hash = location.hash.replace(/^#/, "");
      const [path, id] = hash.split("/");
      showSection("screenStart", !path);
      showSection("screenLobby", path === "lobby");
      showSection("screenJoin", path === "join");
      if (!path) return;
      if (path === "lobby" && id) loadLobby(id);
      if (path === "join" && id) setupJoin(id);
    }
    window.addEventListener("hashchange", route);

    function showSection(id, on) { document.getElementById(id).style.display = on ? "block" : "none"; }

    // ==== Auth badge ====
    onAuthStateChanged(auth, (u) => {
      const el = document.getElementById("authBadge");
      if (u) { el.innerHTML = `UID: <span class="kbd">${u.uid.slice(0,8)}‚Ä¶</span>`; route(); }
      else el.textContent = "inte inloggad";
    });
    signInAnonymously(auth).catch(console.error);

    // ==== Create Lobby ====
    const btnCreate = document.getElementById("btnCreate");
    const btnGotoJoin = document.getElementById("btnGotoJoin");
    const btnSpotify = document.getElementById("btnSpotify");
    const btnPickDevice = document.getElementById("btnPickDevice");

    if (btnCreate) {
      btnCreate.addEventListener("click", async () => {
        const u = auth.currentUser; if (!u) return alert("Inte inloggad");
        const yearMin = +document.getElementById("yearMin").value;
        const yearMax = +document.getElementById("yearMax").value;
        const tDrag = +document.getElementById("tDrag").value;
        const tClaim = +document.getElementById("tClaim").value;
        const tOpp = +document.getElementById("tOpp").value;
        const tokensPerTeam = +document.getElementById("tokensPerTeam").value;

        const gameId = (await push(ref(db, "games"))).key;
        const base = ref(db, `games/${gameId}`);
        await set(child(base, "phase"), "lobby");
        await set(child(base, "hostId"), u.uid);
        await set(child(base, "settings"), {
          yearMin, yearMax,
          timers: { dragSec: tDrag, challengePromptSec: tClaim, oppDragSec: tOpp },
          tokensPerTeam, winCards: 11, allowLateJoin: false, dedupeKey: "spotifyId"
        });
        location.hash = `lobby/${gameId}`;
      });
    }

    if (btnGotoJoin) {
      btnGotoJoin.addEventListener("click", () => {
        const gid = prompt("Ange gameId att joina:");
        if (gid) location.hash = `join/${gid}`;
      });
    }

    // ==== Lobby view ====
    let lobbyUnsub = null;
    async function loadLobby(gameId) {
      document.getElementById("lblGameId").textContent = gameId;
      const joinUrl = `${location.origin}${location.pathname}#join/${gameId}`;
      document.getElementById("joinUrl").textContent = joinUrl;
      document.getElementById("qrImg").src =
        `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${encodeURIComponent(joinUrl)}`;

      const startBtn = document.getElementById("btnStart");
      const leaveBtn = document.getElementById("btnLeave");
      if (leaveBtn) leaveBtn.onclick = () => history.back();

      if (lobbyUnsub) lobbyUnsub();
      const base = ref(db, `games/${gameId}`);
      lobbyUnsub = onValue(base, (snap) => {
        const v = snap.val() || {};
        // teams list
        const teamsEl = document.getElementById("teams");
        teamsEl.innerHTML = "";
        const teams = v.teams ? Object.entries(v.teams) : [];
        for (const [, t] of teams) {
          const div = document.createElement("div");
          div.className = "chip";
          div.textContent = `${t.name || "??"}${t.tokens != null ? " ‚Ä¢ " + t.tokens + " tok" : ""}`;
          teamsEl.appendChild(div);
        }
        const isHost = auth.currentUser && v.hostId === auth.currentUser.uid;
        if (startBtn) {
          startBtn.disabled = !(isHost && teams.length >= 1);
          startBtn.onclick = async () => {
            const ok = await transferToSelectedDevice(false); // auto-transfer at game start
            if (!ok) return;
            alert("Starta spel ‚Üí (Cloud Function hostStart() kommer i n√§sta steg)");
          };
        }
      });
    }

    // ==== Join view ====
    async function setupJoin(gameId) {
      document.getElementById("joinGameId").textContent = gameId;
      const joinBtn = document.getElementById("btnJoin");
      const nameInp = document.getElementById("inpTeamName");
      const msg = document.getElementById("joinMsg");
      if (joinBtn) {
        joinBtn.onclick = async () => {
          const u = auth.currentUser; if (!u) return alert("Inte inloggad");
          const name = (nameInp.value || "").trim();
          if (!name) { msg.textContent = "Ange lagnamn"; return; }
          const tRef = ref(db, `games/${gameId}/teams/${u.uid}`);
          await set(tRef, { name, tokens: 4, score: 0, joinedAt: Date.now() });
          msg.innerHTML = `Klart! Du √§r med som <span class="mono">${name}</span>.`;
        };
      }
    }

    // ==== Spotify PKCE (host) ‚Äì minimal ====
    const SPOTIFY_CLIENT_ID = "3033344ef55647b8b70ef1dccfa7e65f";
    const REDIRECT = location.origin + location.pathname; // return to same page (avoid 404 on static hosting)
    const SPOTIFY_SCOPES =
      "streaming user-read-email user-read-private user-modify-playback-state user-read-playback-state";

    function b64url(buf) {
      return btoa(String.fromCharCode(...new Uint8Array(buf)))
        .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/,"");
    }
    async function sha256(txt) {
      const data = new TextEncoder().encode(txt);
      return await crypto.subtle.digest("SHA-256", data);
    }
    function randStr(len) {
      const arr = new Uint8Array(len); crypto.getRandomValues(arr);
      return Array.from(arr).map(b => ("0"+(b%36).toString(36)).slice(-1)).join("");
    }

    if (btnSpotify) {
      btnSpotify.addEventListener("click", async () => {
        const verifier = randStr(64);
        const challenge = b64url(await sha256(verifier));
        sessionStorage.setItem("sp_verifier", verifier);
        const url = new URL("https://accounts.spotify.com/authorize");
        url.searchParams.set("client_id", SPOTIFY_CLIENT_ID);
        url.searchParams.set("response_type", "code");
        url.searchParams.set("redirect_uri", REDIRECT);
        url.searchParams.set("code_challenge_method", "S256");
        url.searchParams.set("code_challenge", challenge);
        url.searchParams.set("scope", SPOTIFY_SCOPES);
        url.searchParams.set("show_dialog", "true");
        location.href = url.toString();
      });
    }

    // Handle Spotify callback on ANY path (since we redirect back to same page)
    (async function handleSpotifyCallback() {
      const params = new URLSearchParams(location.search);
      const code = params.get("code");
      if (!code) return;
      const verifier = sessionStorage.getItem("sp_verifier");
      const spStatus = document.getElementById("spStatus");
      if (!verifier) { if (spStatus) spStatus.textContent = "Spotify: saknar verifier"; return; }
      try {
        const tokenRes = await fetch("https://accounts.spotify.com/api/token", {
          method: "POST",
          headers: { "Content-Type":"application/x-www-form-urlencoded" },
          body: new URLSearchParams({
            grant_type: "authorization_code",
            code,
            client_id: SPOTIFY_CLIENT_ID,
            redirect_uri: REDIRECT,
            code_verifier: verifier
          })
        });
        const token = await tokenRes.json();
        if (!token.access_token) throw new Error(JSON.stringify(token));
        localStorage.setItem("sp_token", JSON.stringify({
          access_token: token.access_token,
          refresh_token: token.refresh_token,
          expires_at: Date.now() + (token.expires_in * 1000 - 60000)
        }));
        history.replaceState({}, "", location.origin + location.pathname); // drop ?code
        if (spStatus) spStatus.innerHTML = '<span class="ok">Spotify kopplad</span>';
        if (btnPickDevice) btnPickDevice.disabled = false;
      } catch (e) {
        if (spStatus) spStatus.innerHTML = '<span class="err">Spotify-koppling misslyckades</span>';
        console.error(e);
      }
    })();

    if (btnPickDevice) {
      btnPickDevice.addEventListener("click", async () => {
        try {
          const at = await withToken();
          const r = await fetch("https://api.spotify.com/v1/me/player/devices", {
            headers: { Authorization: "Bearer " + at }
          });
          const j = await r.json();

          const listEl = document.getElementById("deviceList");
          if (listEl) listEl.innerHTML = "";

          if (!j.devices || !j.devices.length) {
            if (listEl) {
              listEl.innerHTML =
                '<span class="mut">Inga Connect-enheter hittades. √ñppna Spotify p√• enheten du vill anv√§nda och f√∂rs√∂k igen.</span>';
            }
            return;
          }

          const selectedId = localStorage.getItem("sp_device_id");
          j.devices.forEach((d) => {
            const btn = document.createElement("button");
            btn.className = "ghost";
            btn.style.display = "block";
            btn.style.width = "100%";
            btn.style.textAlign = "left";
            btn.textContent = `${d.name} (${d.type})${d.is_active ? " ‚úì" : ""}`;

            if (d.id === selectedId) btn.style.borderColor = "#10b981";

            btn.addEventListener("click", () => {
              localStorage.setItem("sp_device_id", d.id);
              const st = document.getElementById("spStatus");
              if (st) st.innerHTML = `Enhet vald: <span class="kbd">${d.name}</span>`;
              if (listEl) Array.from(listEl.children).forEach(el => el.style.borderColor = "#283146");
              btn.style.borderColor = "#10b981";
            });

            if (listEl) listEl.appendChild(btn);
          });
        } catch (e) {
          alert("Kunde inte h√§mta enheter");
          console.error(e);
        }
      });
    }

    async function withToken() {
      const raw = localStorage.getItem("sp_token");
      if (!raw) throw new Error("Ej inloggad mot Spotify");
      const tok = JSON.parse(raw);
      if (Date.now() < tok.expires_at) return tok.access_token;
      const res = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type":"application/x-www-form-urlencoded" },
        body: new URLSearchParams({
          grant_type: "refresh_token",
          refresh_token: tok.refresh_token,
          client_id: SPOTIFY_CLIENT_ID
        })
      });
      const j = await res.json();
      tok.access_token = j.access_token;
      tok.expires_at = Date.now() + (j.expires_in * 1000 - 60000);
      localStorage.setItem("sp_token", JSON.stringify(tok));
      return tok.access_token;
    }

    // Transfer playback to the selected device (called at Starta spel)
    async function transferToSelectedDevice(play = false) {
      try {
        const deviceId = localStorage.getItem("sp_device_id");
        if (!deviceId) { alert("V√§lj en Connect-enhet f√∂rst"); return false; }
        const at = await withToken();
        const res = await fetch("https://api.spotify.com/v1/me/player", {
          method: "PUT",
          headers: { Authorization: "Bearer " + at, "Content-Type": "application/json" },
          body: JSON.stringify({ device_ids: [deviceId], play })
        });
        if (!res.ok) {
          const t = await res.text();
          alert("Kunde inte ansluta till vald enhet.\n" + t);
          return false;
        }
        return true;
      } catch (e) {
        console.error(e);
        alert("Fel vid anslutning till enhet");
        return false;
      }
    }

    // ==== Boot ====
    route();
  </script>
</body>
</html>
