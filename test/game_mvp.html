<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NOTESTREAM ‚Äì0.651 (TEST)</title>
  <meta name="theme-color" content="#111827" />
  <style>
    :root { --bg:#0b1020; --fg:#e5e7eb; --mut:#9ca3af; --acc:#06b6d4; --danger:#ef4444; --ok:#10b981; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #111827;background:#0e152e;position:sticky;top:0;z-index:10}
    h1{font-size:18px;margin:0;font-weight:600}
    main{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:#0e152e;border:1px solid #111827;border-radius:14px;padding:16px;box-shadow:0 2px 16px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .mut{color:var(--mut)}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .team-strip{display:flex;gap:8px;flex-wrap:wrap}
    .team{border:1px solid #1f2937;background:#0b1228;border-radius:12px;padding:8px 10px}
    .team.active{outline:2px solid var(--acc)}
    .grid{display:grid;gap:12px}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;background:#0b1228;border:1px solid #1f2937;border-radius:8px;padding:2px 6px}
    button{border-radius:12px;border:1px solid #1f2937;background:#0b1228;color:var(--fg);padding:10px 12px;font-size:14px}
    button.primary{background:linear-gradient(180deg,#0891b2,#0284c7);border-color:#0369a1}
    button:disabled{opacity:.55}
    .spoiler{font-style:italic;color:#9aa3b5}

    /* === Timeline / DnD === */
    .timeline{min-height:240px;border:1px dashed #283146;border-radius:14px;background:#0b1228;position:relative;overflow:hidden;padding:14px}
    .slots{position:absolute;left:14px;right:14px;top:50%;height:64px;transform:translateY(-50%);display:flex;gap:10px;align-items:stretch}
    .slot{flex:1;border:1px dashed #2a3553;border-radius:10px;background:rgba(10,18,40,.35);position:relative;transition:border-color .15s, background .15s}
    .slot.active{border-color:#3a4a78;background:rgba(10,18,40,.55)}
    .marker{position:absolute;bottom:100%;height:14px;width:2px;background:#3a4a78;left:50%;transform:translateX(-50%)}
    .marker-label{position:absolute;bottom:100%;transform:translate(-50%,-6px);left:50%;font-size:11px;color:#8aa0bf;white-space:nowrap}
    .card-drag{position:absolute;top:16px;left:16px;width:120px;height:160px;border:1px solid #344160;border-radius:12px;background:#0b1228;display:grid;place-items:center;user-select:none;touch-action:none;box-shadow:0 6px 16px rgba(0,0,0,.35)}
    .card-drag.floating{pointer-events:none}
    .card-face{font-size:48px;color:#c7d2fe}
    .drop-hint{position:absolute;bottom:16px;left:16px;color:#9aa3b5;font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>üéµ Beatline ‚Äì Game (MVP)</h1>
    <div id="authBadge" class="mut">‚Ä¶</div>
  </header>
  <main>
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <div class="mut">GameID</div>
          <div id="lblGameId" class="mono"></div>
        </div>
        <div>
          <div class="mut">Runda</div>
          <div id="lblRound" class="mono">‚Äì</div>
        </div>
        <div>
          <div class="mut">Dragindex</div>
          <div id="lblDraw" class="mono">‚Äì</div>
        </div>
        <div>
          <div class="mut">Tur</div>
          <div id="lblTurn" class="mono">‚Äì</div>
        </div>
        <div>
          <button id="btnBackLobby">‚üµ Till lobby</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px 0">Lag</h3>
      <div id="teamStrip" class="team-strip"></div>
      <div id="teamEmpty" class="mut" style="display:none">Inga lag √§nnu ‚Äì √∂ppna lobby och l√§gg till minst ett.</div>
    </section>

    <section class="card grid">
      <div>
        <div class="mut">Aktuellt kort</div>
        <div id="nowPlaying" class="spoiler">Spelar l√•t ‚Ä¶ (spoilerfri)</div>
        <div id="nowYear" class="mut" style="margin-top:4px"></div>
      </div>
      <div class="row">
        <button id="btnLock" class="primary" disabled>L√•s gissning</button>
        <button id="btnSkip" disabled>Byt l√•t (‚àí1 token)</button>
        <span id="chosenSlotLbl" class="mut"></span>
      </div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">Tidslinje (DnD ‚Äì f√∂rsta version)</h3>
      <div id="timeline" class="timeline">
        <div id="slots" class="slots"></div>
        <div id="dragCard" class="card-drag" aria-grabbed="false">
          <div class="card-face">?</div>
        </div>
        <div class="drop-hint">Dra ?-kortet till r√§tt plats i tidslinjen</div>
      </div>
      <p class="mut" style="margin-top:8px">
        Den h√§r vyn uppdateras i realtid fr√•n RTDB. Vi skriver ingenting √§n ‚Äì ‚ÄúL√•s gissning‚Äù visar bara vilket slot-index som skulle skickas.
      </p>
    </section>
  </main>

  <script type="module">
    // ==== Firebase init ====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAfv4yGrI7Vj5PaX0A_XFRn0P4U--S9tFA",
      authDomain: "beatlinefirebase.firebaseapp.com",
      databaseURL: "https://notestreamfire.europe-west1.firebasedatabase.app",
      projectId: "beatlinefirebase",
      appId: "1:196231817325:web:d5603a36a9c2c5f247f764"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ==== Helpers ====
    const $ = (id)=>document.getElementById(id);
    const parseHash = ()=>{
      const m = (location.hash || '').match(/^#game\/([^\/]+)$/);
      return m ? m[1] : null;
    };

    // ==== Routing / load ====
    let gameId = parseHash();
    $('lblGameId').textContent = gameId || '‚Äì';
    console.log('[Game] Loaded with hash:', location.hash, '‚Üí gameId =', gameId);

    window.addEventListener('hashchange', ()=>{
      gameId = parseHash();
      $('lblGameId').textContent = gameId || '‚Äì';
      console.log('[Game] hashchange ‚Üí', gameId);
      if (gameId) bindGame(gameId);
    });

    onAuthStateChanged(auth, (u)=>{
      $('authBadge').textContent = u ? `UID: ${u.uid.slice(0,8)}‚Ä¶` : 'inte inloggad';
      console.log('[Game] auth state:', u?.uid);
      if (gameId) bindGame(gameId); // l√§s √§ven anonymt (reglerna √§r √∂ppna i test)
    });
    signInAnonymously(auth).catch(console.error);

    // ==== State f√∂r DnD (klient-lokalt) ====
    let currentGame = null;
    let activeTeamId = null;
    let chosenSlotIndex = null; // s√§tts n√§r man sl√§pper kortet

    // ==== Bind game state ====
    let unsub = null;
    function bindGame(id){
      if (!id) return;
      if (unsub) unsub();
      const gRef = ref(db, `games/${id}`);
      console.log('[Game] binding to', `games/${id}`);
      unsub = onValue(gRef, snap=>{
        if(!snap.exists()){
          console.warn('[Game] games/'+id+' not found');
          $('nowPlaying').textContent = 'Spelet hittades inte.';
          $('teamStrip').innerHTML = '';
          $('teamEmpty').style.display = 'block';
          return;
        }
        const v = snap.val() || {};
        currentGame = v;
        renderGame(v, id);
        renderTimeline(v);
      });
    }

    function renderGame(g, id){
      // Top labels
      $('lblRound').textContent = g.round != null ? String(g.round) : '‚Äì';
      $('lblDraw').textContent  = g.drawIndex != null ? String(g.drawIndex) : '‚Äì';
      $('lblTurn').textContent  = g.turn || '‚Äì';
      activeTeamId = g.turn || null;

      // Teams strip
      const strip = $('teamStrip');
      strip.innerHTML = '';
      const teams = g.teams ? Object.entries(g.teams) : [];
      $('teamEmpty').style.display = teams.length ? 'none' : 'block';
      teams.forEach(([tid, t])=>{
        const div = document.createElement('div');
        div.className = 'team' + (g.turn === tid ? ' active' : '');
        const tokens = (t && typeof t.tokens === 'number') ? t.tokens : '‚Äì';
        const score  = (t && typeof t.score  === 'number') ? t.score  : 0;
        const startY = (g.startYears && g.startYears[tid]) ? g.startYears[tid] : '‚Äì';
        div.innerHTML = `
          <div><strong>${t?.name || 'Lag'}</strong></div>
          <div class="mut">Tokens: <span class="mono">${tokens}</span> ‚Ä¢ Po√§ng: <span class="mono">${score}</span></div>
          <div class="mut">Start√•r: <span class="mono">${startY}</span></div>
        `;
        strip.appendChild(div);
      });

      // Now playing (spoilerfri)
      const di = g.drawIndex || 0;
      const deck = Array.isArray(g.deck) ? g.deck : [];
      $('nowPlaying').textContent = deck.length
        ? `Spelar l√•t #${di + 1} av ${deck.length} (spoilerfri)`
        : 'Ingen lek ‚Äì skapa fr√•n lobbyn.';
      $('nowYear').textContent = (g.settings && g.settings.yearMin != null && g.settings.yearMax != null)
        ? `√Örsintervall: ${g.settings.yearMin}‚Äì${g.settings.yearMax}` : '';

      // Knappar ‚Äì placeholder tills vi kopplar state-maskin
      $('btnLock').disabled = (chosenSlotIndex == null);
      $('btnSkip').disabled = true;
    }

    // ==== Timeline render (slots + markers) ====
    function renderTimeline(g){
      const slotsEl = $('slots');
      slotsEl.innerHTML = '';

      // H√§mta befintliga placerade kort f√∂r aktiva laget (om finns)
      const placed = (g.timelines && activeTeamId && Array.isArray(g.timelines[activeTeamId]))
        ? g.timelines[activeTeamId] : [];
      const placedYears = placed.map(x=>x?.year).filter(y=>typeof y==='number');

      // Antal slots = placerade + 1, minst 1
      const slotCount = Math.max(1, placedYears.length + 1);

      for(let i=0;i<slotCount;i++){
        const s = document.createElement('div');
        s.className = 'slot';
        s.dataset.index = String(i);
        slotsEl.appendChild(s);
      }

      // Rita ut mark√∂rer √∂ver slots som guidance (om vi har placerade √•r)
      // Vi distribuerar dem mellan slotkanter f√∂r enkel visning
      if (placedYears.length){
        const rect = slotsEl.getBoundingClientRect();
        const w = rect.width;
        placedYears.forEach((year, idx)=>{
          const x = (w / (slotCount)) * (idx+1); // ungef√§rlig placering
          const marker = document.createElement('div');
          marker.className = 'marker';
          marker.style.left = `${(x / w) * 100}%`;
          slotsEl.appendChild(marker);

          const label = document.createElement('div');
          label.className = 'marker-label';
          label.style.left = `${(x / w) * 100}%`;
          label.textContent = String(year);
          slotsEl.appendChild(label);
        });
      }

      // N√§r state uppdateras rensar vi val
      chosenSlotIndex = null;
      $('chosenSlotLbl').textContent = '';
      $('btnLock').disabled = true;
    }

    // ==== DnD-kort ====
    const dragEl = $('dragCard');
    const timeline = $('timeline');
    const slotsEl = $('slots');

    let dragging = false;
    let startX = 0, startY = 0;
    let cardX = 16, cardY = 16;

    function setCardPos(x,y){
      dragEl.style.transform = `translate(${x}px, ${y}px)`;
    }
    setCardPos(cardX, cardY);

    function slotIndexFromPointer(clientX){
      const r = slotsEl.getBoundingClientRect();
      const x = Math.max(0, Math.min(clientX - r.left, r.width));
      const children = Array.from(slotsEl.children).filter(c=>c.classList.contains('slot'));
      if (!children.length) return 0;
      const slotW = r.width / children.length;
      let idx = Math.floor(x / slotW);
      if (idx < 0) idx = 0;
      if (idx >= children.length) idx = children.length - 1;
      return idx;
    }

    function highlightSlot(idx){
      const children = Array.from(slotsEl.children).filter(c=>c.classList.contains('slot'));
      children.forEach((c,i)=> c.classList.toggle('active', i===idx));
    }

    function clearHighlight(){
      const children = Array.from(slotsEl.children).filter(c=>c.classList.contains('slot'));
      children.forEach((c)=> c.classList.remove('active'));
    }

    dragEl.addEventListener('pointerdown', (ev)=>{
      dragging = true;
      dragEl.setPointerCapture(ev.pointerId);
      dragEl.classList.add('floating');
      startX = ev.clientX - cardX;
      startY = ev.clientY - cardY;
      dragEl.setAttribute('aria-grabbed', 'true');
    });

    dragEl.addEventListener('pointermove', (ev)=>{
      if(!dragging) return;
      cardX = ev.clientX - startX;
      cardY = ev.clientY - startY;
      setCardPos(cardX, cardY);

      // highlight n√§r vi √§r √∂ver slots
      const idx = slotIndexFromPointer(ev.clientX);
      highlightSlot(idx);
    });

    function dropAtCurrent(ev){
      const idx = slotIndexFromPointer(ev.clientX);
      chosenSlotIndex = idx;
      $('chosenSlotLbl').textContent = `Vald plats: slot ${idx}`;
      $('btnLock').disabled = (chosenSlotIndex == null);
      console.log('[DnD] Dropped at slot', idx);

      // Snappa tillbaka kortet visuellt till toppen (vi l√•ter highlight ligga kvar kort)
      cardX = 16; cardY = 16;
      setCardPos(cardX, cardY);
      dragEl.classList.remove('floating');
      dragEl.setAttribute('aria-grabbed', 'false');
      clearHighlight();
    }

    dragEl.addEventListener('pointerup', (ev)=>{
      if(!dragging) return;
      dragging = false;
      dropAtCurrent(ev);
    });
    dragEl.addEventListener('pointercancel', ()=>{
      if(!dragging) return;
      dragging = false;
      // Avbrutet drag ‚Üí reset
      cardX = 16; cardY = 16; setCardPos(cardX, cardY);
      dragEl.classList.remove('floating');
      dragEl.setAttribute('aria-grabbed', 'false');
      clearHighlight();
    });

    // ‚ÄúL√•s gissning‚Äù ‚Äì bara logga vad vi skulle skicka
    $('btnLock').addEventListener('click', ()=>{
      if (chosenSlotIndex == null) return;
      console.log('[Lock] Would submit:', {
        gameId,
        teamId: activeTeamId,
        drawIndex: currentGame?.drawIndex ?? 0,
        slotIndex: chosenSlotIndex
      });
      alert(`(Demo) L√•s gissning: slot ${chosenSlotIndex}\n(det h√§r skriver √§nnu inte till DB)`);
    });

    // ==== Nav back ====
    $('btnBackLobby').addEventListener('click', ()=> history.back());

    // Boot
    if (gameId) bindGame(gameId);
  </script>
</body>
</html>
