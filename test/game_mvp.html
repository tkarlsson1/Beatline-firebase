<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NOTESTREAM ‚Äì0.650 (TEST)</title>
  <meta name="theme-color" content="#111827" />
  <style>
    :root { --bg:#0b1020; --fg:#e5e7eb; --mut:#9ca3af; --acc:#06b6d4; --danger:#ef4444; --ok:#10b981; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #111827;background:#0e152e;position:sticky;top:0;z-index:10}
    h1{font-size:18px;margin:0;font-weight:600}
    main{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:#0e152e;border:1px solid #111827;border-radius:14px;padding:16px;box-shadow:0 2px 16px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .mut{color:var(--mut)}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .team-strip{display:flex;gap:8px;flex-wrap:wrap}
    .team{border:1px solid #1f2937;background:#0b1228;border-radius:12px;padding:8px 10px}
    .team.active{outline:2px solid var(--acc)}
    .grid{display:grid;gap:12px}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;background:#0b1228;border:1px solid #1f2937;border-radius:8px;padding:2px 6px}
    button{border-radius:12px;border:1px solid #1f2937;background:#0b1228;color:var(--fg);padding:10px 12px;font-size:14px}
    button.primary{background:linear-gradient(180deg,#0891b2,#0284c7);border-color:#0369a1}
    button:disabled{opacity:.55}
    .spoiler{font-style:italic;color:#9aa3b5}
    .timeline{min-height:220px;border:1px dashed #283146;border-radius:14px;background:#0b1228;display:grid;place-items:center}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #2a3553;background:#0b1228}
  </style>
</head>
<body>
  <header>
    <h1>üéµ Beatline ‚Äì Game (MVP)</h1>
    <div id="authBadge" class="mut">‚Ä¶</div>
  </header>
  <main>
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <div class="mut">GameID</div>
          <div id="lblGameId" class="mono"></div>
        </div>
        <div>
          <div class="mut">Runda</div>
          <div id="lblRound" class="mono">‚Äì</div>
        </div>
        <div>
          <div class="mut">Dragindex</div>
          <div id="lblDraw" class="mono">‚Äì</div>
        </div>
        <div>
          <div class="mut">Tur</div>
          <div id="lblTurn" class="mono">‚Äì</div>
        </div>
        <div>
          <button id="btnBackLobby">‚üµ Till lobby</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px 0">Lag</h3>
      <div id="teamStrip" class="team-strip"></div>
      <div id="teamEmpty" class="mut" style="display:none">Inga lag √§nnu ‚Äì √∂ppna lobby och l√§gg till minst ett.</div>
    </section>

    <section class="card grid">
      <div>
        <div class="mut">Aktuellt kort</div>
        <div id="nowPlaying" class="spoiler">Spelar l√•t ‚Ä¶ (spoilerfri)</div>
        <div id="nowYear" class="mut" style="margin-top:4px"></div>
      </div>
      <div class="row">
        <button id="btnLock" class="primary" disabled>L√•s gissning</button>
        <button id="btnSkip" disabled>Byt l√•t (‚àí1 token)</button>
      </div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">Tidslinje (placeholder)</h3>
      <div id="timeline" class="timeline">
        DnD-tidslinje kommer h√§r (n√§sta steg)
      </div>
      <p class="mut" style="margin-top:8px">
        Den h√§r vyn uppdateras i realtid fr√•n RTDB. Vi visar inte titel/artist innan ‚Äúreveal‚Äù.
      </p>
    </section>
  </main>

  <script type="module">
    // ==== Firebase init ====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAfv4yGrI7Vj5PaX0A_XFRn0P4U--S9tFA",
      authDomain: "beatlinefirebase.firebaseapp.com",
      databaseURL: "https://notestreamfire.europe-west1.firebasedatabase.app",
      projectId: "beatlinefirebase",
      appId: "1:196231817325:web:d5603a36a9c2c5f247f764"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ==== Helpers ====
    const $ = (id)=>document.getElementById(id);
    const parseHash = ()=>{
      const m = (location.hash || '').match(/^#game\/([^\/]+)$/);
      return m ? m[1] : null;
    };

    // ==== Routing / load ====
    let gameId = parseHash();
    $('lblGameId').textContent = gameId || '‚Äì';
    console.log('[Game] Loaded with hash:', location.hash, '‚Üí gameId =', gameId);

    window.addEventListener('hashchange', ()=>{
      gameId = parseHash();
      $('lblGameId').textContent = gameId || '‚Äì';
      console.log('[Game] hashchange ‚Üí', gameId);
      if (gameId) bindGame(gameId);
    });

    onAuthStateChanged(auth, (u)=>{
      $('authBadge').textContent = u ? `UID: ${u.uid.slice(0,8)}‚Ä¶` : 'inte inloggad';
      console.log('[Game] auth state:', u?.uid);
      if (gameId) bindGame(gameId); // l√§s √§ven anonymt (reglerna √§r √∂ppna i test)
    });
    signInAnonymously(auth).catch(console.error);

    // ==== Bind game state ====
    let unsub = null;
    function bindGame(id){
      if (!id) return;
      if (unsub) unsub();
      const gRef = ref(db, `games/${id}`);
      console.log('[Game] binding to', `games/${id}`);
      unsub = onValue(gRef, snap=>{
        if(!snap.exists()){
          console.warn('[Game] games/'+id+' not found');
          $('nowPlaying').textContent = 'Spelet hittades inte.';
          $('teamStrip').innerHTML = '';
          $('teamEmpty').style.display = 'block';
          return;
        }
        const v = snap.val() || {};
        console.log('[Game] state:', v);
        renderGame(v, id);
      });
    }

    function renderGame(g, id){
      // Top labels
      $('lblRound').textContent = g.round != null ? String(g.round) : '‚Äì';
      $('lblDraw').textContent  = g.drawIndex != null ? String(g.drawIndex) : '‚Äì';
      $('lblTurn').textContent  = g.turn || '‚Äì';

      // Teams strip
      const strip = $('teamStrip');
      strip.innerHTML = '';
      const teams = g.teams ? Object.entries(g.teams) : [];
      $('teamEmpty').style.display = teams.length ? 'none' : 'block';
      teams.forEach(([tid, t])=>{
        const div = document.createElement('div');
        div.className = 'team' + (g.turn === tid ? ' active' : '');
        const tokens = (t && typeof t.tokens === 'number') ? t.tokens : '‚Äì';
        const score  = (t && typeof t.score  === 'number') ? t.score  : 0;
        const startY = (g.startYears && g.startYears[tid]) ? g.startYears[tid] : '‚Äì';
        div.innerHTML = `
          <div><strong>${t?.name || 'Lag'}</strong></div>
          <div class="mut">Tokens: <span class="mono">${tokens}</span> ‚Ä¢ Po√§ng: <span class="mono">${score}</span></div>
          <div class="mut">Start√•r: <span class="mono">${startY}</span></div>
        `;
        strip.appendChild(div);
      });

      // Now playing (spoilerfri)
      const di = g.drawIndex || 0;
      const deck = Array.isArray(g.deck) ? g.deck : [];
      $('nowPlaying').textContent = deck.length
        ? `Spelar l√•t #${di + 1} av ${deck.length} (spoilerfri)`
        : 'Ingen lek ‚Äì skapa fr√•n lobbyn.';
      $('nowYear').textContent = (g.settings && g.settings.yearMin != null && g.settings.yearMax != null)
        ? `√Örsintervall: ${g.settings.yearMin}‚Äì${g.settings.yearMax}` : '';

      // Knappar ‚Äì placeholder tills vi kopplar state-maskin
      const amHostTurn = true;
      $('btnLock').disabled = !amHostTurn;
      $('btnSkip').disabled = !amHostTurn;
    }

    // ==== Nav back ====
    $('btnBackLobby').addEventListener('click', ()=> history.back());

    // Boot
    if (gameId) bindGame(gameId);
  </script>
</body>
</html>
