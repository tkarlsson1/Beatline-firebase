<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="description" content="Årsquiz om låtar – spela, gissa och redigera årtal.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#111111">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta property="og:title" content="Låtårsquiz">
  <meta property="og:description" content="Gissa vilket år låten släpptes.">
  <meta name="twitter:card" content="summary_large_image">
  
  <title>NOTESTREAM v0.663</title>
  
  <!-- Favicon and manifest -->
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700&display=swap" rel="stylesheet" />
  
  <!-- External CSS -->
  <link rel="stylesheet" href="styles.css">
  
  <!-- QRCode library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
  <!-- ============================================ -->
  <!-- LOGIN MODAL -->
  <!-- ============================================ -->
  <div id="loginModal" style="display: none;" class="modal" role="dialog" aria-modal="true">
    <div id="loginBox">
      <h2>Logga in</h2>
      <input type="email" id="emailInput" placeholder="Ange e-post" />
      <input type="password" id="passwordInput" placeholder="Ange lösenord" />
      <a href="#" id="forgotPasswordLink" style="font-size: 0.85rem; text-decoration: underline; color: #0b939c; display: block; margin-bottom: 1rem;">Glömt lösenord?</a>
      <button id="loginButton">Logga in</button>
      <p id="loginError" class="error">Fel e-post eller lösenord!</p>
      <button id="showRegister" style="margin-top: 1rem;">Skapa konto</button>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- REGISTER MODAL -->
  <!-- ============================================ -->
  <div id="registerModal" style="display:none;">
    <div id="registerBox">
      <h2>Registrera dig</h2>
      <input type="email" id="regEmail" placeholder="Ange din e-post" />
      <input type="password" id="regPassword" placeholder="Ange ditt lösenord" />
      <button id="registerButton">Registrera</button>
      <p id="registerError" class="error">Registrering misslyckades!</p>
      <p>Har du redan ett konto? <button id="showLogin">Logga in</button></p>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- MAIN CONTAINER -->
  <!-- ============================================ -->
  <div class="container" id="mainContent">
    <img src="logga.png" alt="Notestream-beta logo" class="logo" />
    
    <!-- ============================================ -->
    <!-- FILTER PAGE -->
    <!-- ============================================ -->
    <div id="filter-page">
      <div id="source-checkbox-container"></div>
      <div style="display: flex; justify-content: center; gap: 1rem;">
        <div style="display: flex; flex-direction: column; align-items: center;">
          <label for="startYear">Från år:</label>
          <select id="startYear"></select>
        </div>
        <div style="display: flex; flex-direction: column; align-items: center;">
          <label for="endYear">Till år:</label>
          <select id="endYear"></select>
        </div>
      </div>
      
      <!-- Spotify import -->
      <div id="spotify-import">
        <h3>Lägg till Spotify-spellista</h3>
        <input type="text" id="playlistLinkInput" placeholder="Klistra in Spotify-länken" style="margin-right: 2px" style="margin-left: 2px">
        <input type="text" id="playlistNameInput" placeholder="Spellistans namn">
        <button id="addPlaylistButton">Lägg till</button>
      </div>
      
      <p id="selectedSongCount" style="text-align:center; color:#fff; margin-top:0.5rem;">Valda låtar: 0</p>
      <button id="startButton" onclick="applyFilter()" class="start-button">Starta spel</button>
    </div>
    
    <!-- ============================================ -->
    <!-- RESULT PAGE -->
    <!-- ============================================ -->
    <div id="result-page">
      <div id="song-display"></div>
      <button onclick="nextSong()" class="next-song-button">Nästa låt</button>
      <p id="playlist-info" style="display: none; text-align: center; font-size: 0.85rem; color: #fff; margin-top: 0.2rem;"></p>
    </div>
    
    <!-- ============================================ -->
    <!-- README MODAL -->
    <!-- ============================================ -->
    <div id="readmeModal" class="modal" role="dialog" aria-modal="true">
      <div id="readmeContent">
        <span class="closeBtn">&times;</span>
        <h2>NOTESTREAM-BETA</h2>
        <p>
          Test och säg vad du tycker!<br>
          Tankar kring allt från färg på text till funktioner uppskattas. 
        </p>
        <p>
          För att spela får du först göra några val:<br>
          • Vilka förinställda spellistor vill du inkludera?<br>
          • Vilka av dina egna spellistor vill du inkludera låtar från?<br>
          • Vilka årtal vill du inkludera låtar från?<br>
          Utifrån dina val väljs sedan låtar ut, och ingen låt kommer att återkomma under samma session.
        </p>
        <p>
          Du kan lägga till egna spellistor, de hamnar under Egna spellistor
        </p>
        <p>
          När du lägger till en lista, namnge den och klistra in länken som du kopierat från Spotify.<br>
          För att hämta en länk i Spotify, tryck på Dela och Kopiera spellistelänk.<br>
          Tänk på:<br>
          • Spelet hämtar årtal direkt från det unika Spotify-ID låten har som du har i listan. Låtar från samlingsalbum kommer alltså ha årtal därefter<br>
          • Spotify-genererade listor för dig stämmer oftast bra i årtal<br>
          • Spotify-genererade listor behöver först sparas som en av dina listor för att kunna laddas in. Lägg till i annan lista -> skapa ny<br>
        </p>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- EDIT YEAR MODAL -->
  <!-- ============================================ -->
  <div id="editYearModal" class="modal" style="display: none;" role="dialog" aria-modal="true">
    <div class="modal-content">
      <span id="closeModal" class="close">&times;</span>
      <h3>Redigera årtal</h3>
      <input id="newYearInput" type="text" placeholder="Ange nytt årtal">
      <button id="saveYearButton">Spara</button>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- MANAGE PLAYLISTS MODAL -->
  <!-- ============================================ -->
  <div id="managePlaylistsModal" class="modal" role="dialog" aria-modal="true" style="display:none; text-align:left; padding:8px;">
    <div class="modal-content" style="width:min(92vw, 600px); max-width:600px; margin:6vh auto; background:#111; color:#fff; padding:20px; border-radius:12px; box-sizing:border-box; max-height:80vh; overflow:auto;">
      <span id="closeManagePlaylists" class="closeBtn" aria-label="Stäng">&times;</span>
      <h2>Hantera spellistor</h2>
      <p id="managePlaylistsInfo" style="opacity:.9; margin-top:.5rem;"></p>
      <div id="managePlaylistsList" style="margin-top: 1rem;"></div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- FIREBASE MODULE SCRIPT -->
  <!-- ============================================ -->
  <script type="module" src="firebase-config.js"></script>

  <!-- ============================================ -->
  <!-- SPOTIFY INTEGRATION -->
  <!-- ============================================ -->
  <script>
    async function getBackendSpotifyToken() {
      console.log("getBackendSpotifyToken: Kontrollerar om cachat token finns...");
      const cachedToken = localStorage.getItem('spotifyToken');
      const tokenExpiry = localStorage.getItem('spotifyTokenExpiry');
      if (cachedToken && tokenExpiry && Date.now() < Number(tokenExpiry)) {
        console.log("Använder cachad token från backend:", cachedToken);
        return cachedToken;
      }
      try {
        console.log("Begär nytt token via backend...");
        const response = await fetch('https://api-grl2mze3sa-uc.a.run.app/getSpotifyToken', {
          method: 'POST'
        });
        if (!response.ok) {
          throw new Error(`HTTP-fel: ${response.status}`);
        }
        const data = await response.json();
        const token = data.access_token;
        const expiresIn = data.expires_in;
        const expiryTime = Date.now() + (expiresIn * 1000) - (60 * 1000);
        localStorage.setItem('spotifyToken', token);
        localStorage.setItem('spotifyTokenExpiry', expiryTime.toString());
        console.log("Hämtat nytt token via backend:", token);
        return token;
      } catch (error) {
        console.error("Fel vid hämtning av token via backend:", error);
        return null;
      }
    }
    
    async function fetchSpotifyPlaylist(playlistUrl) {
      console.log("fetchSpotifyPlaylist: Playlist URL mottagen:", playlistUrl);
      const playlistId = playlistUrl.split("/playlist/")[1].split("?")[0];
      console.log("fetchSpotifyPlaylist: Extraherat playlist-ID:", playlistId);
      const token = await getBackendSpotifyToken();
      let tracks = {};
      let nextUrl = `https://api.spotify.com/v1/playlists/${playlistId}/tracks`;
      while (nextUrl) {
        const response = await fetch(nextUrl, {
          headers: { "Authorization": `Bearer ${token}` }
        });
        const data = await response.json();
        data.items.forEach(item => {
          const trackId = item.track.id;
          tracks[trackId] = {
            title: item.track.name,
            artist: item.track.artists.map(artist => artist.name).join(", "),
            year: item.track.album.release_date ? item.track.album.release_date.substring(0, 4) : null
          };
        });
        nextUrl = data.next;
      }
      return tracks;
    }
    
    async function addPlaylistToFirebase(playlistName, playlistUrl) {
      try {
        console.log("Försöker hämta spellista:", playlistName);
        const tracks = await fetchSpotifyPlaylist(playlistUrl);
        
        if (!tracks || Object.keys(tracks).length === 0) {
          alert("Ingen data hämtades från spellistan. Kontrollera att länken är korrekt!");
          return;
        }
        
        const userId = window.auth.currentUser.uid;
        const userPlaylistsRef = window.firebaseRef(window.firebaseDb, `userPlaylists/${userId}/${playlistName}`);
        await window.firebaseSet(userPlaylistsRef, { songs: tracks });
        
        alert(`Spellistan "${playlistName}" har lagts till i dina spellistor!`);
      } catch (error) {
        console.error("Fel vid lagring av spellista:", error);
        alert("Något gick fel vid lagring av spellistan.");
      }
    }
    
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("addPlaylistButton").addEventListener("click", async () => {
        const playlistName = document.getElementById("playlistNameInput").value.trim();
        const playlistLink = document.getElementById("playlistLinkInput").value.trim();
        
        if (!playlistName || !playlistLink) {
          alert("Fyll i både spellistans namn och länk!");
          return;
        }
        
        await addPlaylistToFirebase(playlistName, playlistLink);
      });
    });
  </script>

  <!-- ============================================ -->
  <!-- UTILITY FUNCTIONS -->
  <!-- ============================================ -->
  <script src="utils.js"></script>

  <!-- ============================================ -->
  <!-- UI EVENT HANDLERS -->
  <!-- ============================================ -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Modal toggle handlers
      const showRegisterBtn = document.getElementById("showRegister");
      const showLoginBtn = document.getElementById("showLogin");
      if (showRegisterBtn) {
        showRegisterBtn.addEventListener("click", () => {
          document.getElementById("loginModal").style.display = "none";
          document.getElementById("registerModal").style.display = "flex";
        });
      }
      if (showLoginBtn) {
        showLoginBtn.addEventListener("click", () => {
          document.getElementById("registerModal").style.display = "none";
          document.getElementById("loginModal").style.display = "flex";
        });
      }
      
      // Readme Modal
      const readmeModal = document.getElementById("readmeModal");
      const closeBtn = document.querySelector(".closeBtn");
      closeBtn.addEventListener("click", function() {
        readmeModal.style.display = "none";
      });
      window.addEventListener("click", function(event) {
        if (event.target == readmeModal) {
          readmeModal.style.display = "none";
        }
      });
      
      // Edit Year Modal handlers
      document.getElementById("saveYearButton").addEventListener("click", function() {
        const newYear = document.getElementById("newYearInput").value.trim();
        if (!/^\d{4}$/.test(newYear)) {
          alert("Ange ett giltigt årtal med 4 siffror.");
          return;
        }
        updateCustomYear(window.currentPlaylistName, window.currentSpotifyID, newYear)
          .then(() => {
            closeEditYearModal();
          })
          .catch((error) => {
            console.error("Fel vid uppdatering av customYear:", error);
          });
      });
      
      document.getElementById("closeModal").addEventListener("click", function() {
        closeEditYearModal();
      });
    });
  </script>

  <!-- ============================================ -->
  <!-- HAMBURGER MENU -->
  <!-- ============================================ -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const menuContainer = document.createElement("div");
      menuContainer.id = "menuContainer";
      menuContainer.style.position = "fixed";
      menuContainer.style.top = "10px";
      menuContainer.style.right = "2vw";
      menuContainer.style.zIndex = "9999";
      menuContainer.style.width = "60px";
      
      const menuButton = document.createElement("button");
      menuButton.id = "menuButton";
      menuButton.innerHTML = "&#9776;";
      menuButton.style.background = "none";
      menuButton.style.border = "none";
      menuButton.style.color = "#fff";
      menuButton.style.fontSize = "2rem";
      menuButton.style.cursor = "pointer";
      menuButton.style.zIndex = "9999";
      menuContainer.appendChild(menuButton);
      
      const dropdownMenu = document.createElement("div");
      dropdownMenu.id = "dropdownMenu";
      dropdownMenu.style.display = "none";
      dropdownMenu.style.position = "absolute";
      dropdownMenu.style.right = "0";
      dropdownMenu.style.top = "2.5rem";
      dropdownMenu.style.background = "#032934";
      dropdownMenu.style.border = "1px solid #fff";
      dropdownMenu.style.borderRadius = "4px";
      dropdownMenu.style.zIndex = "9999";
      dropdownMenu.style.width = "max-content";
      
      const lasForstLink = document.createElement("a");
      lasForstLink.href = "#";
      lasForstLink.textContent = "Läs först";
      lasForstLink.addEventListener("click", (e) => {
        e.preventDefault();
        document.getElementById("readmeModal").style.display = "block";
        dropdownMenu.style.display = "none";
      });
      dropdownMenu.appendChild(lasForstLink);
      
      const startpageLink = document.createElement("a");
      startpageLink.href = "#";
      startpageLink.textContent = "Startsida";
      startpageLink.addEventListener("click", (e) => {
        e.preventDefault();
        goToFilter();
        dropdownMenu.style.display = "none";
      });
      dropdownMenu.appendChild(startpageLink);
      
      const managePlaylistsLink = document.createElement("a");
      managePlaylistsLink.href = "#";
      managePlaylistsLink.textContent = "Hantera spellistor";
      managePlaylistsLink.addEventListener("click", (e) => {
        e.preventDefault();
        window.openManagePlaylists && window.openManagePlaylists();
        dropdownMenu.style.display = "none";
      });
      dropdownMenu.appendChild(managePlaylistsLink);
      
      const logoutLink = document.createElement("a");
      logoutLink.href = "#";
      logoutLink.textContent = "Logga ut";
      logoutLink.addEventListener("click", (e) => {
        e.preventDefault();
        window.firebaseSignOut(window.auth)
          .then(() => {
            console.log("Utloggad!");
            document.getElementById("loginModal").style.display = "flex";
            dropdownMenu.style.display = "none";
          })
          .catch((error) => {
            console.error("Fel vid utloggning:", error);
          });
      });
      dropdownMenu.appendChild(logoutLink);
      
      menuContainer.appendChild(dropdownMenu);
      document.body.appendChild(menuContainer);
      
      menuButton.addEventListener("click", () => {
        dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
      });
      
      document.addEventListener("click", (event) => {
        if (!menuContainer.contains(event.target)) {
          dropdownMenu.style.display = "none";
        }
      });
    });
  </script>

  <!-- ============================================ -->
  <!-- MANAGE PLAYLISTS MODAL LOGIC -->
  <!-- ============================================ -->
  <script>
    (function(){
      function qs(id){ return document.getElementById(id); }
      function show(el){ el.style.display = 'block'; el.dispatchEvent(new CustomEvent('modal:open', {bubbles:true})); }
      function hide(el){ el.style.display = 'none'; el.dispatchEvent(new CustomEvent('modal:close', {bubbles:true})); }
      
      async function fetchUserPlaylists(){
        if (!window.auth || !window.auth.currentUser) return null;
        return new Promise((resolve, reject) => {
          const userId = window.auth.currentUser.uid;
          const userRef = window.firebaseRef(window.firebaseDb, 'userPlaylists/' + userId);
          window.firebaseOnValue(userRef, (snap) => {
            const val = snap.val() || {};
            resolve(val);
          }, (err) => reject(err), { onlyOnce: true });
        });
      }
      
      function renderPlaylists(listMap){
        const container = qs('managePlaylistsList');
        container.innerHTML = '';
        container.style.textAlign = "left";
        
        const keys = Object.keys(listMap || {});
        if (!keys.length){
          container.innerHTML = '<p>Du har inga egna spellistor ännu.</p>';
          return;
        }
        keys.forEach((name) => {
          const item = document.createElement('div');
          item.className = 'playlist-row';
          item.style.display = 'flex';
          item.style.width = '100%';
          item.style.alignItems = 'center';
          item.style.justifyContent = 'space-between';
          item.style.gap = '1rem';
          item.style.padding = '.6rem .4rem';
          item.style.borderBottom = '1px solid rgba(255,255,255,.1)';
          
          const left = document.createElement('div');
          left.style.display = 'flex';
          left.style.alignItems = 'flex-start';
          left.style.textAlign = 'left';
          left.style.flexDirection = 'column';
          const title = document.createElement('strong');
          title.style.display = 'block';
          title.style.textAlign = 'left';
          title.textContent = name;
          left.appendChild(title);
          const meta = document.createElement('span');
          meta.style.display = 'block';
          meta.style.textAlign = 'left';
          const songCount = listMap[name] && listMap[name].songs ? Object.keys(listMap[name].songs).length : 0;
          meta.textContent = songCount + ' låtar';
          meta.style.opacity = '.8';
          meta.style.fontSize = '.9rem';
          left.appendChild(meta);
          
          const del = document.createElement('button');
          del.type = 'button';
          del.textContent = 'Ta bort';
          del.className = 'btn-delete-playlist';
          del.style.padding = '.4rem .7rem';
          del.style.borderRadius = '8px';
          del.style.border = '1px solid rgba(255,255,255,.2)';
          del.style.background = 'transparent';
          del.style.color = '#fff';
          del.style.cursor = 'pointer';
          del.addEventListener('click', async () => {
            if (!confirm('Ta bort spellistan "' + name + '"? Detta går inte att ångra.')) return;
            try {
              const userId = window.auth.currentUser.uid;
              const refToList = window.firebaseRef(window.firebaseDb, 'userPlaylists/' + userId + '/' + name);
              await window.firebaseSet(refToList, null);
              item.remove();
              if (!qs('managePlaylistsList').children.length){
                qs('managePlaylistsList').innerHTML = '<p>Du har inga egna spellistor ännu.</p>';
              }
            } catch(e){
              console.error('Kunde inte ta bort:', e);
              alert('Kunde inte ta bort. Kolla nätverk och behörigheter.');
            }
          });
          item.appendChild(left);
          item.appendChild(del);
          container.appendChild(item);
        });
      }
      
      window.openManagePlaylists = async function(){
        const modal = qs('managePlaylistsModal');
        const info = qs('managePlaylistsInfo');
        info.textContent = '';
        if (!window.auth || !window.auth.currentUser){
          info.textContent = 'Du behöver vara inloggad för att hantera dina spellistor.';
          qs('managePlaylistsList').innerHTML = '';
          show(modal);
          return;
        }
        try {
          info.textContent = 'Hämtar dina spellistor...';
          const data = await fetchUserPlaylists();
          info.textContent = '';
          renderPlaylists(data);
          show(modal);
        } catch(e){
          console.error(e);
          info.textContent = 'Kunde inte hämta spellistor just nu.';
          show(modal);
        }
      };
      
      document.addEventListener('click', function(e){
        if (e.target && (e.target.id === 'closeManagePlaylists')){
          hide(qs('managePlaylistsModal'));
        }
        if (e.target && e.target.id === 'managePlaylistsModal'){
          hide(qs('managePlaylistsModal'));
        }
      });
    })();
  </script>

  <!-- ============================================ -->
  <!-- ACCESSIBILITY: MODAL FOCUS TRAP & ESC -->
  <!-- ============================================ -->
  <script>
    (function(){
      let __scrollY = 0;
      function getFocusable(container){
        return container.querySelectorAll('a[href], button, input, select, textarea, [tabindex]:not([tabindex="-1"])');
      }
      function lockBody(){
        __scrollY = window.scrollY || window.pageYOffset || 0;
        document.body.classList.add('modal-open');
        document.body.style.top = `-${__scrollY}px`;
      }
      function unlockBody(){
        document.body.classList.remove('modal-open');
        const y = __scrollY || 0;
        document.body.style.top = '';
        window.scrollTo(0, y);
      }
      document.addEventListener('modal:open', function(e){
        const modal = e.target.closest('.modal');
        if (!modal) return;
        lockBody();
        const nodes = getFocusable(modal);
        if (nodes.length){
          const first = nodes[0];
          const last = nodes[nodes.length-1];
          function onKey(ev){
            if (ev.key === 'Escape'){ 
              modal.style.display = 'none';
              unlockBody();
              modal.dispatchEvent(new CustomEvent('modal:close', {bubbles:true}));
            } else if (ev.key === 'Tab'){
              if (ev.shiftKey && document.activeElement === first){ ev.preventDefault(); last.focus(); }
              else if (!ev.shiftKey && document.activeElement === last){ ev.preventDefault(); first.focus(); }
            }
          }
          modal.__trapKeyHandler = onKey;
          modal.addEventListener('keydown', onKey);
          (modal.querySelector('[autofocus]') || first).focus();
        }
      });
      document.addEventListener('modal:close', function(e){
        const modal = e.target.closest('.modal');
        if (!modal) return;
        if (modal.__trapKeyHandler){
          modal.removeEventListener('keydown', modal.__trapKeyHandler);
          modal.__trapKeyHandler = null;
        }
        unlockBody();
      });
    })();
  </script>

  <!-- ============================================ -->
  <!-- VIEWPORT HEIGHT FIX FOR MOBILE -->
  <!-- ============================================ -->
  <script>
    (function(){
      function setVH(){ 
        document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px'); 
      }
      setVH(); 
      window.addEventListener('resize', setVH);
    })();
  </script>

  <!-- ============================================ -->
  <!-- SERVICE WORKER REGISTRATION -->
  <!-- ============================================ -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/service-worker.js")
        .then(registration => {
          console.log("Service Worker registrerad med scope:", registration.scope);
        })
        .catch(error => {
          console.error("Service Worker misslyckades:", error);
        });
    }
  </script>

</body>
</html>