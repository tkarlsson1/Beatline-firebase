
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="description" content="Årsquiz om låtar – spela, gissa och redigera årtal.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NOTESTREAM – 0.606</title>

  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111">

  <!-- QR code lib -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :where(a,button,[role="button"],.answer-button,.edit-icon):focus{outline:3px solid rgba(0,0,0,.6);outline-offset:2px}
    html, body { overflow-x: hidden; }
    body {
      font-family: 'Manrope', sans-serif;
      background: url('background.jpg') no-repeat center center fixed;
      background-size: cover;
      margin: 0; padding: 0;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
    }
    .container { padding: 2rem; max-width: 500px; width: 100%; margin: 2rem 1rem; position: relative; z-index: 1; }
    .logo { display:block; margin:0 auto 1.5rem auto; max-width:80%; height:auto; }
    select, button { padding: .5rem; font-size:1rem; margin-bottom:1rem; background:#032934; color:#fff; border:none; border-radius:4px; font-family:'Manrope', sans-serif; }
    #startYear, #endYear { width: 80px; }
    .qrcode { width:160px; height:160px; border:5px solid black; border-radius:10px; display:block; margin:0 auto 1rem auto; }
    #result-page { display:none; position:relative; padding-bottom:10px; }
    #source-checkbox-container { display:flex; flex-wrap:wrap; justify-content:center; gap:1.7rem .5rem; margin-bottom:2rem; }
    .checkbox-pill { position:relative; display:inline-block; }
    .checkbox-pill input[type="checkbox"]{ display:none; }
    .checkbox-pill label{
      cursor:pointer; padding:.5rem .5rem; border:3px solid #032934; border-radius:8px; background:#032934; color:#fff; transition:.25s; font-size:1rem;
    }
    .checkbox-pill input[type="checkbox"]:checked + label{ background:#0b939c; border-color:#0b939c; }
    .divider { height:2px; background:#fff; width:100%; margin:.5rem 0; }
    .subheading{ display:block; width:100%; text-align:center; font-size:.8rem; color:#fff; margin:.5rem 0; }
    .next-song-button, .answer-button { display:block; margin:0 auto; width:128px; background:#032934; color:#fff; border:none; border-radius:4px; font-size:1rem; cursor:pointer; }
    .start-button {
      background: linear-gradient(to right, #fb1820, #ff6310);
      border: none; border-radius: 8px; padding: 12px 24px;
      font-size: 18px; font-weight: bold; color: white; cursor: pointer; transition: all .2s ease-in-out; display:block; margin:0 auto;
    }
    .start-button:hover { transform: scale(1.03); }

    /* Modaler */
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; justify-content:center; align-items:center; z-index:5000; }
    .modal-content { background:#fff; padding:1.5rem; border-radius:8px; width:min(92vw, 600px); max-height:80vh; overflow:auto; box-sizing:border-box; }
    .closeBtn, .close { color:#333; font-weight:bold; cursor:pointer; font-size:1.5rem; position:absolute; top:10px; right:20px; }

    /* Meny */
    #menuContainer{ position:fixed; top:10px; right:10px; z-index:3000; }
    #menuButton{ background:none; border:none; font-size:2rem; color:#fff; cursor:pointer; }
    #dropdownMenu{ display:none; position:absolute; right:0; top:2.5rem; background:#032934; border:1px solid #fff; border-radius:4px; }
    #dropdownMenu a{ display:block; padding:.5rem 1rem; color:#fff; text-decoration:none; }

    /* Lobby/Game header */
    #teams-header .chip{
      display:inline-block; padding:.35rem .6rem; margin:.2rem; border-radius:999px;
      border:1px solid rgba(255,255,255,.6); color:#fff;
    }

    /* Debug badge */
    #envBadge {
      position: fixed; bottom: 8px; right: 8px;
      background: rgba(0,0,0,.7); color: #fff;
      padding: 6px 10px; border-radius: 8px; font-size: 12px;
      z-index: 9999; pointer-events: none;
    }
  </style>
</head>

<body>
  <div id="envBadge" aria-live="polite"></div>

  <!-- Inloggningsmodal -->
  <div id="loginModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content" style="text-align:center;">
      <span class="closeBtn" id="loginClose">&times;</span>
      <h2>Logga in</h2>
      <input type="email" id="emailInput" placeholder="Ange e-post" style="width:80%;padding:.5rem;margin:.3rem auto;display:block;" />
      <input type="password" id="passwordInput" placeholder="Ange lösenord" style="width:80%;padding:.5rem;margin:.3rem auto;display:block;" />
      <a href="#" id="forgotPasswordLink" style="font-size:.9rem;text-decoration:underline;color:#0b939c;display:block;margin:.6rem 0;">Glömt lösenord?</a>
      <button id="loginButton">Logga in</button>
      <p id="loginError" style="color:red;display:none;">Fel e‑post eller lösenord!</p>
      <button id="showRegister" style="margin-top: .8rem;">Skapa konto</button>
    </div>
  </div>

  <!-- Registreringsmodal -->
  <div id="registerModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content" style="text-align:center;">
      <span class="closeBtn" id="registerClose">&times;</span>
      <h2>Registrera dig</h2>
      <input type="email" id="regEmail" placeholder="Ange din e‑post" style="width:80%;padding:.5rem;margin:.3rem auto;display:block;" />
      <input type="password" id="regPassword" placeholder="Ange ditt lösenord" style="width:80%;padding:.5rem;margin:.3rem auto;display:block;" />
      <button id="registerButton">Registrera</button>
      <p id="registerError" style="color:red;display:none;">Registrering misslyckades!</p>
      <p>Har du redan ett konto? <button id="showLogin">Logga in</button></p>
    </div>
  </div>

  <div class="container" id="mainContent">
    <img src="logga.png" alt="Notestream logo" class="logo" />

    <!-- Filter/Startsida -->
    <div id="filter-page">
      <div id="source-checkbox-container"></div>

      <div style="display:flex; justify-content:center; gap:1rem;">
        <div style="display:flex; flex-direction:column; align-items:center;">
          <label for="startYear" style="color:#fff;">Från år:</label>
          <select id="startYear"></select>
        </div>
        <div style="display:flex; flex-direction:column; align-items:center;">
          <label for="endYear" style="color:#fff;">Till år:</label>
          <select id="endYear"></select>
        </div>
      </div>

      <!-- Spotify-spellisteimport -->
      <div id="spotify-import" style="margin-bottom:2rem;text-align:center;color:#fff;">
        <h3>Lägg till Spotify‑spellista</h3>
        <input type="text" id="playlistLinkInput" placeholder="Klistra in Spotify‑länken" style="width:40%; padding:.5rem;">
        <input type="text" id="playlistNameInput" placeholder="Spellistans namn" style="width:40%; padding:.5rem;">
        <button id="addPlaylistButton">Lägg till</button>
      </div>

      <p id="selectedSongCount" style="text-align:center;color:#fff;margin-top:.5rem;">Valda låtar: 0</p>
      <button id="startButton" class="start-button">Starta spel</button>
    </div>

    <!-- Resultatsida (solo-läge kvar för bakåtkomp.) -->
    <div id="result-page">
      <div id="song-display"></div>
      <button id="nextSongSolo" class="next-song-button">Nästa låt</button>
      <p id="playlist-info" style="display:none; text-align:center; font-size:.9rem; color:#fff; margin-top:.2rem;"></p>
    </div>

    <!-- Lobby -->
    <div id="lobby-page" style="display:none; text-align:center;">
      <h2 style="color:#fff;">Lobby</h2>
      <div id="lobby-qr" class="qrcode" aria-label="QR-kod för att gå med"></div>
      <p id="lobby-link" style="color:#fff; font-size:.9rem; word-break:break-all;"></p>
      <h3 style="color:#fff; margin-top:1rem;">Lag</h3>
      <div id="team-list" style="max-width:400px; margin:0 auto;"></div>
      <button id="startGameButton" class="start-button" style="margin-top:1rem;">Starta spel</button>
    </div>

    <!-- Join -->
    <div id="join-page" style="display:none; text-align:center;">
      <h2 style="color:#fff;">Gå med i spel</h2>
      <input id="joinTeamName" type="text" placeholder="Lagnamn" style="width:60%; padding:.5rem; margin:.5rem auto; background:#032934; color:#fff; border:0; border-radius:6px;">
      <button id="joinSubmit" class="start-button">Gå med</button>
    </div>

    <!-- Game -->
    <div id="game-page" style="display:none;">
      <div id="teams-header" style="text-align:center; margin:.4rem 0;"></div>
      <div id="game-song-display" style="text-align:center; margin:1rem 0;"></div>
      <div id="host-controls" style="text-align:center; margin-top:.8rem; display:none;">
        <button id="revealButton" class="answer-button" style="display:inline-block; margin-right:.4rem;">Visa svar</button>
        <button id="awardActiveButton" class="answer-button" style="display:inline-block; margin-right:.4rem;">Ge låten till aktivt lag</button>
        <button id="nextSongButtonGame" class="next-song-button" style="display:inline-block;">Nästa låt</button>
      </div>
    </div>

    <!-- Readme Modal -->
    <div id="readmeModal" class="modal">
      <div class="modal-content">
        <span class="closeBtn" id="readmeClose">&times;</span>
        <h2>NOTESTREAM – BETA</h2>
        <p>Välj standard- och/eller egna listor + årtal. Låtar väljs ur dessa – inga dubletter i samma session.</p>
      </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="modal">
      <div class="modal-content">
        <span class="closeBtn" id="feedbackClose">&times;</span>
        <h2>Lämna feedback</h2>
        <textarea id="feedbackText" placeholder="Skriv din feedback här..." style="width:100%;height:150px;"></textarea>
        <button id="submitFeedback">Skicka feedback</button>
      </div>
    </div>
  </div>

 <script type="module">
  /* ===========================
     Firebase (single module)
     =========================== */
  import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getDatabase, ref, onValue, set, push, update, get } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

  // 🔧 Peka alltid på TEST-instansen (notestreamfire)
  const RTDB_URL = "https://notestreamfire.europe-west1.firebasedatabase.app";

  // ✅ Enda configen (ingen prod/test-växel)
  const firebaseConfig = {
    apiKey: "AIzaSyAfv4yGrI7Vj5PaX0A_XFRn0P4U--S9tFA",
    authDomain: "beatlinefirebase.firebaseapp.com",
    databaseURL: RTDB_URL, // <-- viktigt
    projectId: "beatlinefirebase",
    storageBucket: "beatlinefirebase.firebasestorage.app",
    messagingSenderId: "196231817325",
    appId: "1:196231817325:web:d5603a36a9c2c5f247f764"
  };

  // ✅ Init
  const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const db  = getDatabase(app, RTDB_URL); // <-- tvinga rätt RTDB-instans
  const auth = getAuth(app);

  // 🏷️ Liten badge så du ser att du kör mot rätt DB
  document.getElementById("envBadge").textContent = `RTDB: ${RTDB_URL}`;

    // Debug badge + globals
    const opts = getApp().options || {};
    document.getElementById("envBadge").textContent = `ENV: ${useTest?'test':'prod'} • projectId: ${opts.projectId||'-'} • RTDB: ${opts.databaseURL||'-'}`;
    console.log("ENV", { env: useTest?'test':'prod', options: opts });
    window.firebaseDb = db;
    window.firebaseRef = ref;
    window.firebaseSet = set;
    window.firebaseUpdate = update;
    window.firebasePush = push;
    window.firebaseAuth = auth;
    window.firebaseOptions = opts;

    /* ===========================
       Tillstånd & util
       =========================== */
    let standardSongs = [];
    let userPlaylistSongs = [];
    let songs = [];
    let sourceFilteredSongs = [];
    let currentFilteredSongs = [];
    let shownSongs = [];
    let currentSong = null;

    // Multiplayer state
    window.isHost = false;
    window.sessionId = null;

    function setPage(id){
      ["filter-page","result-page","lobby-page","join-page","game-page"].forEach(pid=>{
        const el = document.getElementById(pid);
        if (el) el.style.display = (pid===id) ? "block" : "none";
      });
    }

    function joinURL(sessionId){
    const url = new URL(location.href);
    url.searchParams.set("join", sessionId);
    return url.origin + url.pathname + "?" + url.searchParams.toString();
  }

    function currentStartEndYears(){
      const s = document.getElementById("startYear");
      const e = document.getElementById("endYear");
      const startYear = s ? parseInt(s.value) : 1950;
      const endYear   = e ? parseInt(e.value) : new Date().getFullYear();
      return {startYear, endYear};
    }

    /* ===========================
       Auth UI
       =========================== */
    function show(el){ el.style.display = 'flex'; }
    function hide(el){ el.style.display = 'none'; }

    document.getElementById("showRegister").addEventListener("click", ()=>{ hide(document.getElementById("loginModal")); show(document.getElementById("registerModal")); });
    document.getElementById("showLogin").addEventListener("click", ()=>{ hide(document.getElementById("registerModal")); show(document.getElementById("loginModal")); });
    document.getElementById("loginClose").addEventListener("click", ()=> hide(document.getElementById("loginModal")));
    document.getElementById("registerClose").addEventListener("click", ()=> hide(document.getElementById("registerModal")));

    document.getElementById("loginButton").addEventListener("click", () => {
      const email = document.getElementById("emailInput").value.trim();
      const password = document.getElementById("passwordInput").value;
      signInWithEmailAndPassword(auth, email, password)
        .then(() => document.getElementById("loginError").style.display = "none")
        .catch(() => document.getElementById("loginError").style.display = "block");
    });

    document.getElementById("registerButton").addEventListener("click", () => {
      const email = document.getElementById("regEmail").value.trim();
      const password = document.getElementById("regPassword").value;
      createUserWithEmailAndPassword(auth, email, password)
        .then(() => hide(document.getElementById("registerModal")))
        .catch((error) => {
          const el = document.getElementById("registerError");
          el.textContent = error.message || "Registrering misslyckades"; el.style.display = "block";
        });
    });

    document.getElementById("forgotPasswordLink").addEventListener("click", (e) => {
      e.preventDefault();
      const email = document.getElementById("emailInput").value.trim();
      if (!email) return alert("Ange din e‑postadress.");
      sendPasswordResetEmail(auth, email)
        .then(() => alert("Återställningslänk skickad."))
        .catch(err => alert("Fel: " + err.message));
    });

    /* ===========================
       Data: läs spellistor
       =========================== */
    function initDataListeners() {
      // Standardlistor (offentliga)
      onValue(ref(db, 'standardLists'), (snapshot) => {
        standardSongs = [];
        if (snapshot.exists()) {
          const raw = snapshot.val();
          for (const playlistName in raw) {
            const playlistData = raw[playlistName];
            if (playlistData.songs) {
              for (const trackId in playlistData.songs) {
                standardSongs.push({ qr: trackId, ...playlistData.songs[trackId], source: [playlistName] });
              }
            }
          }
        }
        mergeSongs();
      });

      // Egna listor (privata per user)
      const uid = auth.currentUser.uid;
      onValue(ref(db, `userPlaylists/${uid}`), (snap) => {
        userPlaylistSongs = [];
        if (snap.exists()) {
          const data = snap.val();
          for (const playlistName in data) {
            const pl = data[playlistName];
            if (pl.songs) {
              for (const trackId in pl.songs) {
                userPlaylistSongs.push({ qr: trackId, ...pl.songs[trackId], source: [playlistName] });
              }
            }
          }
        }
        mergeSongs();
      });
    }

    onAuthStateChanged(auth, (user) => {
      if (user) {
        hide(document.getElementById("loginModal"));
        hide(document.getElementById("registerModal"));
        initDataListeners();
        maybeAutoJoinFromURL();
      } else {
        show(document.getElementById("loginModal"));
      }
    });

    /* ===========================
       UI bygg: källor + årtal
       =========================== */
    function populateSourceCheckboxes() {
      const container = document.getElementById("source-checkbox-container");
      container.innerHTML = "";

      // "Alla"
      const allDiv = document.createElement("div");
      allDiv.className = "checkbox-pill";
      const cbAll = document.createElement("input"); cbAll.type = "checkbox"; cbAll.name="source"; cbAll.value="alla"; cbAll.id="source-alla";
      const lbAll = document.createElement("label"); lbAll.setAttribute("for","source-alla"); lbAll.textContent = "Alla låtar";
      cbAll.addEventListener("change", function(){
        container.querySelectorAll('input[name="source"]').forEach(chk => { if (chk!==cbAll) chk.checked = cbAll.checked; });
        updateYearSelection();
      });
      allDiv.appendChild(cbAll); allDiv.appendChild(lbAll); container.appendChild(allDiv);

      const stdHeading = document.createElement("p"); stdHeading.className = "subheading"; stdHeading.textContent = "Standardlistor";
      container.appendChild(stdHeading);

      const stdSources = Array.from(new Set(standardSongs.map(s => s.source[0]))).sort();
      stdSources.forEach(source => {
        const wrap = document.createElement("div"); wrap.className = "checkbox-pill";
        const cb = document.createElement("input"); cb.type="checkbox"; cb.name="source"; cb.value=source; cb.id="std-"+source.replace(/\s+/g,'-').toLowerCase();
        const lb = document.createElement("label"); lb.setAttribute("for", cb.id); lb.textContent = source;
        cb.addEventListener("change", updateYearSelection);
        wrap.appendChild(cb); wrap.appendChild(lb); container.appendChild(wrap);
      });

      container.appendChild(document.createElement("div")).className="divider";

      const userHeading = document.createElement("p"); userHeading.className="subheading"; userHeading.textContent="Egna spellistor";
      container.appendChild(userHeading);

      const usrSources = Array.from(new Set(userPlaylistSongs.map(s => s.source[0]))).filter(x => !stdSources.includes(x)).sort();
      usrSources.forEach(source => {
        const wrap = document.createElement("div"); wrap.className = "checkbox-pill";
        const cb = document.createElement("input"); cb.type="checkbox"; cb.name="source"; cb.value=source; cb.id="usr-"+source.replace(/\s+/g,'-').toLowerCase();
        const lb = document.createElement("label"); lb.setAttribute("for", cb.id); lb.textContent = source;
        cb.addEventListener("change", updateYearSelection);
        wrap.appendChild(cb); wrap.appendChild(lb); container.appendChild(wrap);
      });

      // År-dropdowns
      const startDD = document.getElementById("startYear");
      const endDD = document.getElementById("endYear");
      startDD.innerHTML = ""; endDD.innerHTML = "";
      const thisYear = new Date().getFullYear();
      for (let y = 1950; y <= thisYear; y++){
        const o1 = document.createElement("option"); o1.value=y; o1.textContent=y; if (y===1950) o1.selected=true;
        const o2 = document.createElement("option"); o2.value=y; o2.textContent=y; if (y===thisYear) o2.selected=true;
        startDD.appendChild(o1); endDD.appendChild(o2);
      }
      updateSongCount();
    }

    function mergeSongs(){
      const merged = {};
      standardSongs.forEach(s => { merged[s.qr] = { ...s, source:[...s.source] }; });
      userPlaylistSongs.forEach(s => {
        if (merged[s.qr]) merged[s.qr].source = [...new Set([...merged[s.qr].source, ...s.source])];
        else merged[s.qr] = { ...s, year: s.customYear ?? s.year, source:[...s.source] };
      });
      songs = Object.values(merged);
      window.songs = songs;
      populateSourceCheckboxes();
    }

    function updateSongCount(){
      const startYear = parseInt(document.getElementById("startYear").value);
      const endYear   = parseInt(document.getElementById("endYear").value);
      const cnt = sourceFilteredSongs.filter(s => +s.year >= startYear && +s.year <= endYear).length;
      document.getElementById("selectedSongCount").textContent = `Valda låtar: ${cnt}`;
    }

    window.updateYearSelection = function(){
      const checked = Array.from(document.querySelectorAll('input[name="source"]:checked')).map(x => x.value);
      let selected = checked.includes("alla")
        ? Array.from(new Set([...new Set(standardSongs.map(s=>s.source[0])), ...new Set(userPlaylistSongs.map(s=>s.source[0])), "alla"]))
        : checked;

      sourceFilteredSongs = songs.filter(song => song.source.some(src => selected.includes(src)));
      window.sourceFilteredSongs = sourceFilteredSongs;
      updateSongCount();
    };

    function displaySong(song){
      const year = song.customYear ?? song.year;
      const songDisplay = document.getElementById("song-display");
      songDisplay.innerHTML = `
        <div id="qrcode-${song.qr}" class="qrcode"></div>
        <button class="answer-button" id="revealBtnSolo">Visa svar</button>
        <div id="song-details" style="display:none; margin-top:1rem; font-weight:bold;">
          <div class="year-container" style="text-align:center; width:100%;">
            <span class="year-text" style="font-size:3em; color:#fff; text-shadow:0 0 8px #000;">${year||""}</span>
          </div>
          <div class="info" style="font-size:1.2em; color:#fff; text-shadow:0 0 8px #000;">${song.artist||""}<br>${song.title||""}</div>
        </div>
      `;
      // QR till Spotify
      const el = document.getElementById(`qrcode-${song.qr}`);
      el.innerHTML = "";
      new QRCode(el, { text: `https://open.spotify.com/track/${song.qr}`, width:160, height:160 });

      document.getElementById("revealBtnSolo").addEventListener("click", ()=>{
        document.getElementById("song-details").style.display = "block";
        document.getElementById("playlist-info").style.display = "block";
      });
      const info = document.getElementById("playlist-info");
      if (info) info.textContent = "Spellistor: " + (song.source||[]).join(", ");
    }

    window.filterSongs = function(){
      const startYear = parseInt(document.getElementById("startYear").value);
      const endYear   = parseInt(document.getElementById("endYear").value);
      currentFilteredSongs = sourceFilteredSongs.filter(s => +s.year >= startYear && +s.year <= endYear);
      window.currentFilteredSongs = currentFilteredSongs;
      shownSongs = [];
      if (!currentFilteredSongs.length){
        alert("Inga låtar i det här intervallet. Välj andra källor/årtal eller lägg till en spellista.");
        return false;
      }
      // solo: välj första, men sidan visas inte i multiplayerflödet
      nextSong();
      return true;
    };

    function nextSong(){
      const rem = currentFilteredSongs.filter(s => !shownSongs.includes(s));
      if (!rem.length){ alert("Inga fler låtar."); return; }
      const idx = Math.floor(Math.random() * rem.length);
      currentSong = rem[idx];
      shownSongs.push(currentSong);
      displaySong(currentSong);
    }
    document.getElementById("nextSongSolo").addEventListener("click", nextSong);

    /* ===========================
       Spotify import (enkel)
       =========================== */
    async function getBackendSpotifyToken(){
      const cached = localStorage.getItem('spotifyToken');
      const exp = +localStorage.getItem('spotifyTokenExpiry');
      if (cached && exp && Date.now() < exp) return cached;
      const r = await fetch('https://api-grl2mze3sa-uc.a.run.app/getSpotifyToken', { method:'POST' });
      if (!r.ok) return null;
      const data = await r.json();
      const token = data.access_token; const expiresIn = data.expires_in;
      localStorage.setItem('spotifyToken', token);
      localStorage.setItem('spotifyTokenExpiry', (Date.now()+expiresIn*1000-60000).toString());
      return token;
    }

    async function fetchSpotifyPlaylist(playlistUrl){
      const playlistId = playlistUrl.split("/playlist/")[1]?.split("?")[0];
      if (!playlistId) throw new Error("Ogiltig playlist‑länk.");
      const token = await getBackendSpotifyToken();
      let tracks = {}, nextUrl = `https://api.spotify.com/v1/playlists/${playlistId}/tracks`;
      while (nextUrl){
        const resp = await fetch(nextUrl, { headers:{ Authorization:`Bearer ${token}` }});
        const data = await resp.json();
        (data.items||[]).forEach(item=>{
          const t = item.track; if (!t || !t.id) return;
          tracks[t.id] = { title: t.name, artist: t.artists.map(a=>a.name).join(", "), year: t.album.release_date?.slice(0,4) ?? "" };
        });
        nextUrl = data.next;
      }
      return tracks;
    }

    document.getElementById("addPlaylistButton").addEventListener("click", async ()=>{
      try{
        const name = document.getElementById("playlistNameInput").value.trim();
        const link = document.getElementById("playlistLinkInput").value.trim();
        if (!name || !link) return alert("Fyll i både namn och länk.");
        const tracks = await fetchSpotifyPlaylist(link);
        const uid = auth.currentUser?.uid;
        if (!uid) return alert("Logga in först.");
        await set(ref(db, `userPlaylists/${uid}/${name}`), { songs: tracks });
        alert(`Spellistan "${name}" har lagts till.`);
      }catch(e){ console.error(e); alert("Kunde inte lägga till spellistan."); }
    });

    /* ===========================
       Lobby / Multiplayer
       =========================== */
    async function createSessionFromFilter(){
      if (!auth.currentUser) throw new Error("Inte inloggad.");
      const list = window.currentFilteredSongs || [];
      if (!list.length) throw new Error("Inga filtrerade låtar.");
      const {startYear, endYear} = currentStartEndYears();

      const deck = list.map(s => s.qr);
      const songMap = {};
      list.forEach(s => {
        const yr = s.customYear ?? s.year;
        songMap[s.qr] = { title: s.title||"", artist: s.artist||"", year: yr||"" };
      });

      const sessionRef = push(ref(db, 'sessions'));
      const sid = sessionRef.key;
      await set(sessionRef, {
        createdAt: Date.now(),
        status: "lobby",
        hostId: auth.currentUser.uid,
        settings: { startYear, endYear },
        songMap,
        deck,
        shown: {},
        current: null,
        teams: {},
        turn: { order: [], activeIndex: 0 }
      });
      window.sessionId = sid;
      window.isHost = true;
      localStorage.setItem("sessionId", sid);
      localStorage.setItem("role", "host");
      return sid;
    }

    function renderLobbyTeams(session){
      const list = document.getElementById("team-list");
      list.innerHTML = "";
      const teams = session.teams ? Object.entries(session.teams) : [];
      if (!teams.length) list.innerHTML = "<p style='color:#fff'>Inga lag ännu – scanna QR och gå med.</p>";
      teams.forEach(([tid, t])=>{
        const item = document.createElement("div");
        item.style.padding=".4rem .6rem"; item.style.marginBottom=".3rem"; item.style.background="rgba(3,41,52,.6)"; item.style.color="#fff"; item.style.borderRadius="8px";
        item.textContent = `${t.name}` + (t.score ? ` • ${t.score}p` : "");
        list.appendChild(item);
      });
    }

    function listenToSession(sid){
      onValue(ref(db, `sessions/${sid}`), snap => {
        if (!snap.exists()) return;
        const session = snap.val();
        renderLobbyTeams(session);
        if (session.status === "lobby"){
          setPage("lobby-page");
        } else {
          renderGame(session);
          setPage("game-page");
        }
      });
    }

    function showLobby(sid){
      setPage("lobby-page");
      window.sessionId = sid;
      window.isHost = true;

      const q = document.getElementById("lobby-qr");
      q.innerHTML = "";
      new QRCode(q, { text: joinURL(sid), width: 160, height: 160 });
      document.getElementById("lobby-link").textContent = joinURL(sid);

      const btn = document.getElementById("startGameButton");
      if (!btn._bound){
        btn._bound = true;
        btn.addEventListener("click", async ()=>{
          try{ await startGameHost(); }catch(e){ alert("Kunde inte starta spelet."); }
        });
      }
      listenToSession(sid);
    }

    function showJoinPage(sid){
      setPage("join-page");
      window.sessionId = sid;
      window.isHost = false;
      localStorage.setItem("role","player");
      const btn = document.getElementById("joinSubmit");
      if (!btn._bound){
        btn._bound = true;
        btn.addEventListener("click", async ()=>{
          const name = (document.getElementById("joinTeamName").value||"").trim();
          if (!name) return alert("Ange lagnamn.");
          const teamRef = push(ref(db, `sessions/${sid}/teams`));
          const teamId = teamRef.key;
          await set(teamRef, { name, tokens: 3, score: 0, timeline: [] });
          localStorage.setItem("teamId", teamId);
          listenToSession(sid);
        });
      }
    }

    function maybeAutoJoinFromURL(){
      const p = new URLSearchParams(location.search);
      const sid = p.get("join");
      if (!sid) return;
      if (localStorage.getItem("sessionId") === sid){ listenToSession(sid); return; }
      showJoinPage(sid);
    }

    async function startGameHost(){
      const sid = window.sessionId;
      const teamsSnap = await get(ref(db, `sessions/${sid}/teams`));
      const teams = teamsSnap.val() || {};
      const order = Object.keys(teams);
      if (!order.length) return alert("Minst ett lag krävs.");

      const sessSnap = await get(ref(db, `sessions/${sid}`));
      const sess = sessSnap.val();
      const deck = sess.deck || [];
      const shown = sess.shown || {};
      const nextId = deck.find(id => !shown[id]);
      if (!nextId) return alert("Deck tomt.");

      const updates = {};
      updates[`sessions/${sid}/status`] = "playing";
      updates[`sessions/${sid}/turn`] = { order, activeIndex: 0 };
      updates[`sessions/${sid}/current`] = { trackId: nextId, revealed: false };
      updates[`sessions/${sid}/shown/${nextId}`] = true;
      await update(ref(db), updates);
    }

    function renderGame(session){
      renderTeamsHeader(session);
      renderActiveSong(session);
      renderHostControls(session);
    }

    function renderTeamsHeader(session){
      const wrap = document.getElementById("teams-header");
      wrap.innerHTML = "";
      const order = (session.turn && session.turn.order) || Object.keys(session.teams||{});
      const activeIdx = session.turn ? session.turn.activeIndex : 0;
      order.forEach((tid, idx)=>{
        const t = session.teams[tid];
        const chip = document.createElement("div");
        chip.className="chip";
        chip.style.background = idx===activeIdx ? "#0b939c" : "rgba(3,41,52,.7)";
        chip.textContent = `${t.name} • ${t.score||0}p • 🔥${t.tokens??3}`;
        wrap.appendChild(chip);
      });
    }

    function displaySongGame(song, revealed){
      const cont = document.getElementById("game-song-display");
      cont.innerHTML = `
        <div id="game-qrcode-${song.qr}" class="qrcode"></div>
        <button class="answer-button" id="gameRevealBtn" ${revealed?"style='display:none'":""}>Visa svar</button>
        <div id="game-song-details" style="display:${revealed?"block":"none"}; margin-top: 1rem; font-weight: bold;">
          <div class="year-container" style="text-align:center; width:100%;">
            <span class="year-text" style="font-size: 3em; color:#fff; text-shadow:0 0 8px #000;">${song.year||""}</span>
          </div>
          <div class="info" style="font-size:1.2em; color:#fff; text-shadow:0 0 8px #000;">
            ${song.artist||""}<br>${song.title||""}
          </div>
        </div>
      `;
      const el = document.getElementById(`game-qrcode-${song.qr}`);
      el.innerHTML = ""; new QRCode(el, { text: `https://open.spotify.com/track/${song.qr}`, width:160, height:160 });
      document.getElementById("gameRevealBtn")?.addEventListener("click", ()=>{
        if (window.isHost) document.getElementById("revealButton")?.click();
      });
    }

    function renderActiveSong(session){
      const cur = session.current;
      if (!cur || !cur.trackId){
        document.getElementById("game-song-display").innerHTML = "<p style='color:#fff;text-align:center;'>Ingen låt vald ännu.</p>";
        return;
      }
      const meta = session.songMap?.[cur.trackId] || { title:"", artist:"", year:"" };
      const song = { qr: cur.trackId, title: meta.title, artist: meta.artist, year: meta.year, source:["spel"] };
      displaySongGame(song, !!cur.revealed);
    }

    function renderHostControls(session){
      const hc = document.getElementById("host-controls");
      hc.style.display = window.isHost ? "block" : "none";
      if (!window.isHost) return;

      if (!document.getElementById("revealButton")._bound){
        document.getElementById("revealButton")._bound = true;
        document.getElementById("revealButton").addEventListener("click", async ()=>{
          const sid = window.sessionId;
          const curSnap = await get(ref(db, `sessions/${sid}/current`));
          if (!curSnap.exists()) return;
          await update(ref(db, `sessions/${sid}/current`), { revealed: true });
        });
      }
      if (!document.getElementById("awardActiveButton")._bound){
        document.getElementById("awardActiveButton")._bound = true;
        document.getElementById("awardActiveButton").addEventListener("click", async ()=>{
          const sid = window.sessionId;
          const sSnap = await get(ref(db, `sessions/${sid}`)); if (!sSnap.exists()) return;
          const sess = sSnap.val();
          const order = sess.turn.order; const activeIdx = sess.turn.activeIndex; const activeTid = order[activeIdx];
          const trackId = sess.current?.trackId; if (!activeTid || !trackId) return;
          const yr = sess.songMap?.[trackId]?.year || "";
          const teamPath = `sessions/${sid}/teams/${activeTid}`;
          const team = sess.teams[activeTid];
          const updates = {};
          updates[`${teamPath}/score`] = (team.score||0)+1;
          const tl = team.timeline || []; tl.push({ trackId, year: yr });
          updates[`${teamPath}/timeline`] = tl;
          await update(ref(db), updates);
        });
      }
      if (!document.getElementById("nextSongButtonGame")._bound){
        document.getElementById("nextSongButtonGame")._bound = true;
        document.getElementById("nextSongButtonGame")._bound = true;
        document.getElementById("nextSongButtonGame").addEventListener("click", hostNextSong);
      }
    }

    async function hostNextSong(){
      const sid = window.sessionId;
      const sSnap = await get(ref(db, `sessions/${sid}`)); if (!sSnap.exists()) return;
      const sess = sSnap.val();
      const deck = sess.deck || []; const shown = sess.shown || {};
      const nextId = deck.find(id => !shown[id]);
      const order = sess.turn.order;
      const nextIdx = (sess.turn.activeIndex + 1) % order.length;
      const updates = {};
      if (nextId){
        updates[`sessions/${sid}/current`] = { trackId: nextId, revealed: false };
        updates[`sessions/${sid}/shown/${nextId}`] = true;
      } else {
        updates[`sessions/${sid}/status`] = "finished";
      }
      updates[`sessions/${sid}/turn/activeIndex`] = nextIdx;
      await update(ref(db), updates);
    }

    /* ===========================
       Starta spel (override)
       =========================== */
    async function onStartGame(){
      // Auto-välj 'Alla låtar' om inget är valt
      if (!document.querySelectorAll("input[name='source']:checked").length){
        const alla = document.getElementById("source-alla");
        if (alla) alla.checked = true;
      }
      window.updateYearSelection?.();
      if (!window.filterSongs()) return;

      try{
        const sid = await createSessionFromFilter();
        showLobby(sid);
      }catch(e){
        console.error(e);
        if (String(e).includes("PERMISSION_DENIED")) {
          alert("Behörighetsfel i Realtime Database. Tillåt inloggade att skriva under sessions/* i testmiljön (se reglerna).");
        } else {
          alert("Kunde inte skapa session. Kontrollera att du är inloggad och har låtar i urvalet.");
        }
      }
    }
    document.getElementById("startButton").addEventListener("click", onStartGame);

    /* ===========================
       Meny & debug
       =========================== */
    (function buildMenu(){
      const menuContainer = document.createElement("div"); menuContainer.id="menuContainer";
      const btn = document.createElement("button"); btn.id="menuButton"; btn.innerHTML="&#9776;";
      const dd = document.createElement("div"); dd.id="dropdownMenu";
      const a1=document.createElement("a"); a1.href="#"; a1.textContent="Läs först"; a1.onclick=(e)=>{e.preventDefault(); document.getElementById("readmeModal").style.display="flex"; dd.style.display="none";}
      const a2=document.createElement("a"); a2.href="#"; a2.textContent="Startsida"; a2.onclick=(e)=>{e.preventDefault(); setPage("filter-page"); dd.style.display="none";}
      const a3=document.createElement("a"); a3.href="#"; a3.textContent="Logga ut";  a3.onclick=(e)=>{e.preventDefault(); signOut(auth).catch(()=>{}); dd.style.display="none";}
      const a4=document.createElement("a"); a4.href="#"; a4.textContent="Skrivtest sessions/*"; a4.onclick=async (e)=>{
        e.preventDefault();
        try{
          await set(ref(db, `sessions/__smoketest__`), { ok:true, ts: Date.now(), uid: auth.currentUser?.uid || null });
          alert("Skrivtest OK – regler tillåter write i sessions/*.");
        }catch(err){
          alert("Skrivtest FAIL: " + (err?.message||err));
          console.error("Skrivtest FAIL", err);
        } finally { dd.style.display="none"; }
      };
      dd.appendChild(a1); dd.appendChild(a2); dd.appendChild(a3); dd.appendChild(a4);
      menuContainer.appendChild(btn); menuContainer.appendChild(dd);
      document.body.appendChild(menuContainer);
      btn.addEventListener("click", ()=>{ dd.style.display = dd.style.display==="block" ? "none" : "block"; });
      document.addEventListener("click", (ev)=>{ if (!menuContainer.contains(ev.target)) dd.style.display="none"; });
    })();

    // PWA service worker
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/service-worker.js").catch(()=>{});
    }

  </script>
</body>
</html>
