<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="description" content="Årsquiz om låtar – spela, gissa och redigera årtal.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#111111">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta property="og:title" content="Låtårsquiz">
  <meta property="og:description" content="Gissa vilket år låten släpptes.">
  <meta name="twitter:card" content="summary_large_image">
  
  <title>NOTESTREAM v0.762</title>
  
  <!-- Favicon and manifest -->
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700&display=swap" rel="stylesheet" />
  
  <!-- External CSS -->
  <link rel="stylesheet" href="styles.css">
  
  <!-- QRCode library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
  <!-- ============================================ -->
  <!-- LOGIN MODAL -->
  <!-- ============================================ -->
  <div id="loginModal" style="display: none;" class="modal" role="dialog" aria-modal="true">
    <div id="loginBox">
      <h2>Logga in</h2>
      <input type="email" id="emailInput" placeholder="Ange e-post" />
      <input type="password" id="passwordInput" placeholder="Ange lösenord" />
      <a href="#" id="forgotPasswordLink" style="font-size: 0.85rem; text-decoration: underline; color: #0b939c; display: block; margin-bottom: 1rem;">Glömt lösenord?</a>
      <button id="loginButton">Logga in</button>
      <p id="loginError" class="error">Fel e-post eller lösenord!</p>
      <button id="showRegister" style="margin-top: 1rem;">Skapa konto</button>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- REGISTER MODAL -->
  <!-- ============================================ -->
  <div id="registerModal" style="display:none;">
    <div id="registerBox">
      <h2>Registrera dig</h2>
      <input type="email" id="regEmail" placeholder="Ange din e-post" />
      <input type="password" id="regPassword" placeholder="Ange ditt lösenord" />
      <button id="registerButton">Registrera</button>
      <p id="registerError" class="error">Registrering misslyckades!</p>
      <p>Har du redan ett konto? <button id="showLogin">Logga in</button></p>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- MAIN CONTAINER -->
  <!-- ============================================ -->
  <div class="container" id="mainContent">
    <img src="logga.png" alt="Notestream-beta logo" class="logo" />
    
    <!-- ============================================ -->
    <!-- FILTER PAGE -->
    <!-- ============================================ -->
    <div id="filter-page">
      <div id="source-checkbox-container"></div>
      <div style="display: flex; justify-content: center; gap: 1rem;">
        <div style="display: flex; flex-direction: column; align-items: center;">
          <label for="startYear">Från år:</label>
          <select id="startYear"></select>
        </div>
        <div style="display: flex; flex-direction: column; align-items: center;">
          <label for="endYear">Till år:</label>
          <select id="endYear"></select>
        </div>
      </div>
      
      <!-- Spotify import -->
      <div id="spotify-import">
        <h3>Lägg till Spotify-spellista</h3>
        <input type="text" id="playlistLinkInput" placeholder="Klistra in Spotify-länken" style="margin-right: 2px" style="margin-left: 2px">
        <input type="text" id="playlistNameInput" placeholder="Spellistans namn">
        <button id="addPlaylistButton">Lägg till</button>
      </div>
      
      <p id="selectedSongCount" style="text-align:center; color:#fff; margin-top:0.5rem;">Valda låtar: 0</p>
      <button id="createLobbyButton" class="start-button">Skapa lobby</button>
    </div>
    
    <!-- ============================================ -->
    <!-- RESULT PAGE -->
    <!-- ============================================ -->
    <div id="result-page">
      <div id="song-display"></div>
      <button onclick="nextSong()" class="next-song-button">Nästa låt</button>
      <p id="playlist-info" style="display: none; text-align: center; font-size: 0.85rem; color: #fff; margin-top: 0.2rem;"></p>
    </div>
    
    <!-- ============================================ -->
    <!-- README MODAL -->
    <!-- ============================================ -->
    <div id="readmeModal" class="modal" role="dialog" aria-modal="true">
      <div id="readmeContent">
        <span class="closeBtn">&times;</span>
        <h2>NOTESTREAM-BETA</h2>
        <p>
          Test och säg vad du tycker!<br>
          Tankar kring allt från färg på text till funktioner uppskattas. 
        </p>
        <p>
          För att spela får du först göra några val:<br>
          • Vilka förinställda spellistor vill du inkludera?<br>
          • Vilka av dina egna spellistor vill du inkludera låtar från?<br>
          • Vilka årtal vill du inkludera låtar från?<br>
          Utifrån dina val väljs sedan låtar ut, och ingen låt kommer att återkomma under samma session.
        </p>
        <p>
          Du kan lägga till egna spellistor, de hamnar under Egna spellistor
        </p>
        <p>
          När du lägger till en lista, namnge den och klistra in länken som du kopierat från Spotify.<br>
          För att hämta en länk i Spotify, tryck på Dela och Kopiera spellistelänk.<br>
          Tänk på:<br>
          • Spelet hämtar årtal direkt från det unika Spotify-ID låten har som du har i listan. Låtar från samlingsalbum kommer alltså ha årtal därefter<br>
          • Spotify-genererade listor för dig stämmer oftast bra i årtal<br>
          • Spotify-genererade listor behöver först sparas som en av dina listor för att kunna laddas in. Lägg till i annan lista -> skapa ny<br>
        </p>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- EDIT YEAR MODAL -->
  <!-- ============================================ -->
  <div id="editYearModal" class="modal" style="display: none;" role="dialog" aria-modal="true">
    <div class="modal-content">
      <span id="closeModal" class="close">&times;</span>
      <h3>Redigera årtal</h3>
      <input id="newYearInput" type="text" placeholder="Ange nytt årtal">
      <button id="saveYearButton">Spara</button>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- MANAGE PLAYLISTS MODAL -->
  <!-- ============================================ -->
  <div id="managePlaylistsModal" class="modal" role="dialog" aria-modal="true" style="display:none; text-align:left; padding:8px;">
    <div class="modal-content" style="width:min(92vw, 600px); max-width:600px; margin:6vh auto; background:#111; color:#fff; padding:20px; border-radius:12px; box-sizing:border-box; max-height:80vh; overflow:auto;">
      <span id="closeManagePlaylists" class="closeBtn" aria-label="Stäng">&times;</span>
      <h2>Hantera spellistor</h2>
      <p id="managePlaylistsInfo" style="opacity:.9; margin-top:.5rem;"></p>
      <div id="managePlaylistsList" style="margin-top: 1rem;"></div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- CREATE LOBBY MODAL -->
  <!-- ============================================ -->
  <div id="createLobbyModal" class="modal" style="display: none;" role="dialog" aria-modal="true">
    <div class="modal-content" style="background:#fff; padding:2rem; border-radius:8px; text-align:center; max-width:400px; width:90%;">
      <span id="closeLobbyModal" class="close" style="color:#333;">&times;</span>
      <h2 style="color:#333; margin-top:0;">Skapa lobby</h2>
      <p style="color:#666; margin-bottom:1.5rem;">Välj ditt lagnamn för att skapa lobbyn</p>
      <input 
        type="text" 
        id="hostTeamNameInput" 
        placeholder="Skriv ditt lagnamn..." 
        maxlength="20"
        style="width:100%; padding:0.8rem; border:1px solid #ccc; border-radius:4px; font-size:1rem; margin-bottom:1rem; box-sizing:border-box;"
      />
      <p id="lobbyNameError" class="error" style="display:none; color:#EA4335; font-size:0.9rem; margin-bottom:1rem;">Lagnamn kan inte vara tomt</p>
      <button 
        id="confirmCreateLobby" 
        style="width:100%; padding:0.8rem; background:#4285F4; color:white; border:none; border-radius:4px; font-size:1rem; font-weight:bold; cursor:pointer;"
      >
        Skapa lobby
      </button>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- JAVASCRIPT FILES -->
  <!-- ============================================ -->
  
  <!-- Lobby Helper Functions -->
  <script src="lobby.js"></script>
  
  <!-- Firebase (module) -->
  <script type="module" src="firebase-config.js"></script>
  
  <!-- Utils -->
  <script src="utils.js"></script>

  <!-- Spotify OAuth Authentication -->
  <script src="spotify-auth.js"></script>

  <!-- Spotify Web Playback SDK Player -->
  <script src="spotify-player.js"></script>

  <!-- Spotify Integration (Playlist Import) -->
  <script src="spotify.js"></script>

  <!-- UI Event Handlers -->
  <script src="ui-events.js"></script>
  
  <!-- Menu -->
  <script src="menu.js"></script>
  
  <!-- Manage Playlists -->
  <script src="manage-playlists.js"></script>
  
  <!-- Initialization (Accessibility, Viewport, Service Worker) -->
  <script src="init.js"></script>

  <!-- Spotify Web Playback SDK -->
  <script src="https://sdk.scdn.co/spotify-player.js"></script>

  <!-- Handle Spotify Connection Status -->
  <script>
    // Check if user just connected Spotify
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('spotify') === 'connected') {
      // Show a subtle notification or update UI
      console.log('Spotify connected successfully');
      // Clean URL
      window.history.replaceState({}, document.title, window.location.pathname);
    }
  </script>

  <!-- ============================================ -->
  <!-- CREATE LOBBY BUTTON HANDLER -->
  <!-- ============================================ -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const createLobbyButton = document.getElementById('createLobbyButton');
      const createLobbyModal = document.getElementById('createLobbyModal');
      const closeLobbyModal = document.getElementById('closeLobbyModal');
      const hostTeamNameInput = document.getElementById('hostTeamNameInput');
      const confirmCreateLobby = document.getElementById('confirmCreateLobby');
      const lobbyNameError = document.getElementById('lobbyNameError');

      // Open modal when "Skapa lobby" button is clicked
      createLobbyButton.addEventListener('click', () => {
        console.log('[Index] Create lobby button clicked');
        
        // Validate that at least one playlist is selected (same validation as before)
        const checkedBoxes = document.querySelectorAll('input[name="source"]:checked');
        
        if (checkedBoxes.length === 0) {
          alert('Välj minst en spellista!');
          return;
        }
        
        // Note: Song count validation will happen in createLobby() function
        
        // Open modal
        createLobbyModal.style.display = 'flex';
        hostTeamNameInput.value = '';
        lobbyNameError.style.display = 'none';
        hostTeamNameInput.focus();
        
        // Dispatch modal open event for accessibility
        createLobbyModal.dispatchEvent(new CustomEvent('modal:open', {bubbles: true}));
      });

      // Close modal when X is clicked
      closeLobbyModal.addEventListener('click', () => {
        console.log('[Index] Closing lobby modal');
        createLobbyModal.style.display = 'none';
        createLobbyModal.dispatchEvent(new CustomEvent('modal:close', {bubbles: true}));
      });

      // Close modal when clicking outside
      createLobbyModal.addEventListener('click', (e) => {
        if (e.target === createLobbyModal) {
          console.log('[Index] Closing lobby modal (clicked outside)');
          createLobbyModal.style.display = 'none';
          createLobbyModal.dispatchEvent(new CustomEvent('modal:close', {bubbles: true}));
        }
      });

      // Handle Enter key in input
      hostTeamNameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          confirmCreateLobby.click();
        }
      });

      // Confirm and create lobby
      confirmCreateLobby.addEventListener('click', () => {
        const teamName = hostTeamNameInput.value.trim();
        
        console.log('[Index] Confirm create lobby clicked, team name:', teamName);
        
        // Validate team name
        if (!teamName || teamName.length === 0) {
          lobbyNameError.textContent = 'Lagnamn kan inte vara tomt';
          lobbyNameError.style.display = 'block';
          return;
        }
        
        if (teamName.length > 20) {
          lobbyNameError.textContent = 'Lagnamn max 20 tecken';
          lobbyNameError.style.display = 'block';
          return;
        }
        
        // Hide error
        lobbyNameError.style.display = 'none';
        
        // Close modal
        createLobbyModal.style.display = 'none';
        
        // Call createLobby function (will be defined in firebase-config.js)
        if (typeof window.createLobby === 'function') {
          console.log('[Index] Calling createLobby with team name:', teamName);
          window.createLobby(teamName);
        } else {
          console.error('[Index] createLobby function not found!');
          alert('Något gick fel. Ladda om sidan och försök igen.');
        }
      });
    });
  </script>

</body>
</html>
