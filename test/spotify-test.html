<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spotify Web Playback Test</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background: #191414;
      color: #fff;
    }

    h1 {
      text-align: center;
      color: #1DB954;
    }

    .status-box {
      background: #282828;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .status-item {
      margin: 10px 0;
      padding: 10px;
      background: #333;
      border-radius: 4px;
    }

    .status-label {
      font-weight: bold;
      color: #1DB954;
    }

    button {
      background: #1DB954;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 24px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin: 10px 5px;
      transition: background 0.3s;
    }

    button:hover {
      background: #1ed760;
    }

    button:disabled {
      background: #535353;
      cursor: not-allowed;
    }

    .controls {
      text-align: center;
      margin: 20px 0;
    }

    .now-playing {
      background: #1DB954;
      color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin: 20px 0;
      display: none;
    }

    .error {
      background: #E22134;
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      display: none;
    }

    .success {
      background: #1DB954;
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      display: none;
    }
  </style>
</head>
<body>
  <h1>üéµ Spotify Web Playback Test</h1>

  <!-- Connection Status -->
  <div class="status-box">
    <h2>Connection Status</h2>
    <div class="status-item">
      <span class="status-label">Authentication:</span>
      <span id="authStatus">Not Connected</span>
    </div>
    <div class="status-item">
      <span class="status-label">Player:</span>
      <span id="playerStatus">Not Ready</span>
    </div>
    <div class="status-item">
      <span class="status-label">Device ID:</span>
      <span id="deviceId">-</span>
    </div>
    <div class="status-item">
      <span class="status-label">Premium Account:</span>
      <span id="premiumStatus">Unknown</span>
    </div>
  </div>

  <!-- Token Debug Info -->
  <div class="status-box">
    <h2>üîç Token Debug Info</h2>
    <div class="status-item">
      <span class="status-label">Token Status:</span>
      <span id="tokenStatus">-</span>
    </div>
    <div class="status-item">
      <span class="status-label">Token Preview:</span>
      <span id="tokenPreview" style="font-family: monospace; font-size: 0.85rem;">-</span>
    </div>
    <div class="status-item">
      <span class="status-label">Refresh Token:</span>
      <span id="refreshTokenPreview" style="font-family: monospace; font-size: 0.85rem;">-</span>
    </div>
    <div class="status-item">
      <span class="status-label">Expires At:</span>
      <span id="tokenExpiry">-</span>
    </div>
    <div class="status-item">
      <span class="status-label">Time Until Expiry:</span>
      <span id="timeUntilExpiry">-</span>
    </div>
    <div class="status-item">
      <span class="status-label">Current Time:</span>
      <span id="currentTime">-</span>
    </div>
    <div style="text-align: center; margin-top: 15px;">
      <button onclick="refreshDebugInfo()" style="background: #4285F4;">Refresh Debug Info</button>
      <button onclick="clearTokens()" style="background: #E22134;">Clear All Tokens</button>
      <button onclick="viewFullDebug()" style="background: #9C27B0;">View Full Debug (Console)</button>
    </div>
  </div>

  <!-- Now Playing Indicator -->
  <div id="nowPlaying" class="now-playing">
    ‚ô™ Now Playing...
  </div>

  <!-- Messages -->
  <div id="errorMessage" class="error"></div>
  <div id="successMessage" class="success"></div>

  <!-- Playback State -->
  <div class="status-box">
    <h2>Playback State</h2>
    <div class="status-item">
      <span class="status-label">Playing:</span>
      <span id="isPlaying">No</span>
    </div>
    <div class="status-item">
      <span class="status-label">Position:</span>
      <span id="position">0:00</span>
    </div>
    <div class="status-item">
      <span class="status-label">Duration:</span>
      <span id="duration">0:00</span>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <h2>Controls</h2>
    <button id="connectBtn" onclick="connectSpotify()">Connect Spotify</button>
    <br>
    <button id="playTestBtn" onclick="playTestTrack()" disabled>Play Test Track</button>
    <button id="pauseBtn" onclick="pausePlayback()" disabled>Pause</button>
    <button id="resumeBtn" onclick="resumePlayback()" disabled>Resume</button>
    <button id="nextBtn" onclick="skipTrack()" disabled>Next</button>
  </div>

  <!-- Spotify Web Playback SDK -->
  <script src="https://sdk.scdn.co/spotify-player.js"></script>

  <!-- Spotify Auth and Player Scripts -->
  <script src="spotify-auth.js"></script>
  <script src="spotify-player.js"></script>

  <script>
    // Test track ID: "Mr. Brightside" by The Killers
    const TEST_TRACK_ID = '3n3Ppam7vgaVa1iaRUc9Lp';

    // ============================================
    // UPDATE UI STATUS
    // ============================================
    function updateStatus() {
      // Check authentication
      const isAuth = window.spotifyAuth && window.spotifyAuth.isAuthenticated();
      document.getElementById('authStatus').textContent = isAuth ? 'Connected ‚úì' : 'Not Connected';
      document.getElementById('authStatus').style.color = isAuth ? '#1DB954' : '#E22134';

      // Check player
      const deviceId = window.spotifyPlayer && window.spotifyPlayer.getDeviceId();
      document.getElementById('playerStatus').textContent = deviceId ? 'Ready ‚úì' : 'Not Ready';
      document.getElementById('playerStatus').style.color = deviceId ? '#1DB954' : '#E22134';
      document.getElementById('deviceId').textContent = deviceId || '-';

      // Update buttons
      const playerReady = isAuth && deviceId;
      document.getElementById('playTestBtn').disabled = !playerReady;
      document.getElementById('pauseBtn').disabled = !playerReady;
      document.getElementById('resumeBtn').disabled = !playerReady;
      document.getElementById('nextBtn').disabled = !playerReady;

      // Update connect button
      if (isAuth) {
        document.getElementById('connectBtn').textContent = 'Disconnect Spotify';
        document.getElementById('connectBtn').style.background = '#E22134';
      } else {
        document.getElementById('connectBtn').textContent = 'Connect Spotify';
        document.getElementById('connectBtn').style.background = '#1DB954';
      }
    }

    // ============================================
    // CONNECT/DISCONNECT SPOTIFY
    // ============================================
    async function connectSpotify() {
      const isAuth = window.spotifyAuth && window.spotifyAuth.isAuthenticated();

      if (isAuth) {
        // Disconnect
        if (confirm('Are you sure you want to disconnect?')) {
          window.spotifyAuth.logout();
          if (window.spotifyPlayer) {
            window.spotifyPlayer.disconnect();
          }
          showSuccess('Disconnected from Spotify');
          updateStatus();
        }
      } else {
        // Connect
        if (window.spotifyAuth) {
          // Set flag so callback knows to return to test page
          sessionStorage.setItem('spotifyTestMode', 'true');
          window.spotifyAuth.authorize();
        } else {
          showError('Spotify auth not available');
        }
      }
    }

    // ============================================
    // PLAYBACK CONTROLS
    // ============================================
    async function playTestTrack() {
      showSuccess('Starting test track...');
      const success = await window.spotifyPlayer.play(TEST_TRACK_ID);
      if (success) {
        document.getElementById('nowPlaying').style.display = 'block';
        showSuccess('Playing test track!');
      } else {
        showError('Failed to play track');
      }
    }

    async function pausePlayback() {
      const success = await window.spotifyPlayer.pause();
      if (success) {
        document.getElementById('nowPlaying').style.display = 'none';
        showSuccess('Playback paused');
      } else {
        showError('Failed to pause');
      }
    }

    async function resumePlayback() {
      const success = await window.spotifyPlayer.resume();
      if (success) {
        document.getElementById('nowPlaying').style.display = 'block';
        showSuccess('Playback resumed');
      } else {
        showError('Failed to resume');
      }
    }

    async function skipTrack() {
      const success = await window.spotifyPlayer.next();
      if (success) {
        showSuccess('Skipped to next track');
      } else {
        showError('Failed to skip');
      }
    }

    // ============================================
    // MESSAGE HELPERS
    // ============================================
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 3000);
    }

    function showSuccess(message) {
      const successDiv = document.getElementById('successMessage');
      successDiv.textContent = message;
      successDiv.style.display = 'block';
      setTimeout(() => {
        successDiv.style.display = 'none';
      }, 3000);
    }

    // ============================================
    // FORMAT TIME
    // ============================================
    function formatTime(ms) {
      const seconds = Math.floor(ms / 1000);
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // ============================================
    // DEBUG FUNCTIONS
    // ============================================
    function refreshDebugInfo() {
      console.log('=== REFRESHING DEBUG INFO ===');

      if (!window.spotifyAuth || !window.spotifyAuth.getDebugInfo) {
        console.error('Spotify auth not available');
        showError('Spotify auth not available');
        return;
      }

      const debugInfo = window.spotifyAuth.getDebugInfo();
      console.log('Token Debug Info:', debugInfo);

      // Update UI
      const statusEl = document.getElementById('tokenStatus');
      statusEl.textContent = debugInfo.status.toUpperCase();

      if (debugInfo.status === 'valid') {
        statusEl.style.color = '#1DB954';
      } else if (debugInfo.status === 'expired') {
        statusEl.style.color = '#FFA500';
      } else {
        statusEl.style.color = '#E22134';
      }

      document.getElementById('tokenPreview').textContent = debugInfo.token_preview || 'No token';
      document.getElementById('refreshTokenPreview').textContent = debugInfo.refresh_preview || 'No refresh token';
      document.getElementById('tokenExpiry').textContent = debugInfo.expiry_date || '-';

      if (debugInfo.minutes_until_expiry !== null) {
        const mins = debugInfo.minutes_until_expiry;
        let expiryText = '';

        if (mins < 0) {
          expiryText = `Expired ${Math.abs(mins)} minutes ago`;
        } else if (mins < 5) {
          expiryText = `‚ö†Ô∏è Expires in ${mins} minutes (refresh soon!)`;
        } else {
          expiryText = `${mins} minutes`;
        }

        document.getElementById('timeUntilExpiry').textContent = expiryText;
        document.getElementById('timeUntilExpiry').style.color = mins < 5 ? '#FFA500' : '#fff';
      } else {
        document.getElementById('timeUntilExpiry').textContent = '-';
      }

      document.getElementById('currentTime').textContent = debugInfo.current_time || new Date().toLocaleString();

      showSuccess('Debug info refreshed');
    }

    function clearTokens() {
      if (confirm('Are you sure you want to clear all tokens? You will need to re-authenticate.')) {
        console.log('=== CLEARING ALL TOKENS ===');

        if (window.spotifyAuth) {
          window.spotifyAuth.logout();
        }

        if (window.spotifyPlayer) {
          window.spotifyPlayer.disconnect();
        }

        refreshDebugInfo();
        updateStatus();

        showSuccess('All tokens cleared');
        console.log('‚úÖ All tokens cleared');
      }
    }

    function viewFullDebug() {
      console.log('=== FULL DEBUG INFORMATION ===');

      if (!window.spotifyAuth) {
        console.error('Spotify auth not available');
        return;
      }

      const debugInfo = window.spotifyAuth.getDebugInfo();
      console.log('Token Debug Info:', debugInfo);

      console.log('\nLocalStorage Contents:');
      console.log('- spotify_access_token:', localStorage.getItem('spotify_access_token')?.substring(0, 20) + '...');
      console.log('- spotify_token_expiry:', localStorage.getItem('spotify_token_expiry'));
      console.log('- spotify_refresh_token:', localStorage.getItem('spotify_refresh_token')?.substring(0, 20) + '...');
      console.log('- spotify_code_verifier:', localStorage.getItem('spotify_code_verifier')?.substring(0, 20) + '...');

      console.log('\nAuthentication Status:');
      console.log('- Is Authenticated:', window.spotifyAuth.isAuthenticated());

      console.log('\nPlayer Status:');
      console.log('- Device ID:', window.spotifyPlayer?.getDeviceId());
      console.log('- Is Playing:', window.spotifyPlayer?.isPlaying());

      const state = window.spotifyPlayer?.getState();
      if (state) {
        console.log('- Player State:', {
          paused: state.paused,
          position: formatTime(state.position),
          duration: formatTime(state.duration)
        });
      }

      console.log('\n=== END DEBUG INFO ===');

      showSuccess('Full debug info printed to console');
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================

    // Listen for player ready
    window.addEventListener('spotifyPlayerReady', (e) => {
      console.log('Player ready event received');
      updateStatus();
      showSuccess('Spotify Player is ready!');
    });

    // Listen for state changes
    window.addEventListener('spotifyStateChanged', (e) => {
      const state = e.detail;

      document.getElementById('isPlaying').textContent = state.paused ? 'No' : 'Yes';
      document.getElementById('isPlaying').style.color = state.paused ? '#E22134' : '#1DB954';

      document.getElementById('position').textContent = formatTime(state.position);
      document.getElementById('duration').textContent = formatTime(state.duration);

      // Update now playing indicator
      if (!state.paused) {
        document.getElementById('nowPlaying').style.display = 'block';
      } else {
        document.getElementById('nowPlaying').style.display = 'none';
      }
    });

    // ============================================
    // HANDLE CALLBACK
    // ============================================
    async function handleCallback() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');

      if (code) {
        showSuccess('Authorization code received, exchanging for token...');
        const success = await window.spotifyAuth.handleCallback();

        if (success) {
          showSuccess('Successfully connected to Spotify!');

          // Check premium status
          const isPremium = await window.spotifyAuth.checkPremium();
          document.getElementById('premiumStatus').textContent = isPremium ? 'Yes ‚úì' : 'No';
          document.getElementById('premiumStatus').style.color = isPremium ? '#1DB954' : '#E22134';

          // Clean URL
          window.history.replaceState({}, document.title, window.location.pathname);

          // Wait for player to initialize
          setTimeout(() => {
            updateStatus();
          }, 2000);
        } else {
          showError('Failed to complete authentication');
        }
      }
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('=== SPOTIFY TEST PAGE INITIALIZED ===');

      updateStatus();
      refreshDebugInfo();
      await handleCallback();

      // If already authenticated, check premium status
      if (window.spotifyAuth && window.spotifyAuth.isAuthenticated()) {
        const isPremium = await window.spotifyAuth.checkPremium();
        document.getElementById('premiumStatus').textContent = isPremium ? 'Yes ‚úì' : 'No';
        document.getElementById('premiumStatus').style.color = isPremium ? '#1DB954' : '#E22134';
      }

      // Update status periodically
      setInterval(() => {
        updateStatus();
        refreshDebugInfo();
      }, 2000);

      console.log('‚úÖ Initialization complete');
    });
  </script>
</body>
</html>
