<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Adminpanel 0.1</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "DIN_API_KEY",
            authDomain: "DITT_AUTH_DOMAIN",
            databaseURL: "https://beatlinefirebase-default-rtdb.europe-west1.firebasedatabase.app", 
            projectId: "beatlinefirebase",
            storageBucket: "DITT_STORAGE_BUCKET",
            messagingSenderId: "DITT_MESSAGING_SENDER_ID",
            appId: "DITT_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        const ADMIN_EMAIL = "timmykarlsson@gmail.com"; // Din admin-mail!

        function checkAdminAccess(user) {
            if (!user || user.email !== ADMIN_EMAIL) {
                alert("Du har inte behörighet att använda denna sida.");
                window.location.href = "index.html"; // Skickas tillbaka till startsidan
            } else {
                document.getElementById("adminLoginForm").style.display = "none";
                document.getElementById("adminContent").style.display = "block";
            }
        }

        onAuthStateChanged(auth, (user) => {
            checkAdminAccess(user);
        });

        document.getElementById("adminLoginBtn").addEventListener("click", () => {
            const email = document.getElementById("adminEmail").value;
            const password = document.getElementById("adminPassword").value;

            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    checkAdminAccess(userCredential.user);
                })
                .catch((error) => {
                    alert("Fel vid inloggning: " + error.message);
                });
        });

        document.getElementById("addStandardPlaylistButton").addEventListener("click", async () => {
            const playlistName = document.getElementById("standardPlaylistName").value.trim();
            const playlistLink = document.getElementById("standardPlaylistLink").value.trim();
            if (!playlistName || !playlistLink) {
                alert("Fyll i både spellistans namn och länk!");
                return;
            }

            const tracks = await fetchSpotifyPlaylist(playlistLink);
            if (!tracks || Object.keys(tracks).length === 0) {
                alert("Ingen data hämtades från spellistan. Kontrollera att länken är korrekt!");
                return;
            }

            const standardListsRef = ref(db, `standardLists/${playlistName}`);
            await set(standardListsRef, { songs: tracks });

            alert(`Spellistan "${playlistName}" har lagts till i StandardLists!`);
        });

        async function fetchSpotifyPlaylist(playlistUrl) {
            const playlistId = playlistUrl.split("/playlist/")[1].split("?")[0];
            const token = await getBackendSpotifyToken();
            let tracks = {};
            let nextUrl = `https://api.spotify.com/v1/playlists/${playlistId}/tracks`;

            while (nextUrl) {
                const response = await fetch(nextUrl, {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                const data = await response.json();
                data.items.forEach(item => {
                    const trackId = item.track.id;
                    tracks[trackId] = {
                        title: item.track.name,
                        artist: item.track.artists.map(artist => artist.name).join(", "),
                        year: item.track.album.release_date ? item.track.album.release_date.substring(0, 4) : null
                    };
                });
                nextUrl = data.next;
            }
            return tracks;
        }

        async function getBackendSpotifyToken() {
            const response = await fetch('https://api-grl2mze3sa-uc.a.run.app/getSpotifyToken', { method: 'POST' });
            const data = await response.json();
            return data.access_token;
        }
    </script>
</head>
<body>
    <h2>Adminpanel – Lägg till spellistor i StandardLists</h2>

    <div id="adminLoginForm">
        <input type="email" id="adminEmail" placeholder="Admin-e-post">
        <input type="password" id="adminPassword" placeholder="Lösenord">
        <button id="adminLoginBtn">Logga in</button>
    </div>

    <div id="adminContent" style="display: none;">
        <h3>Lägg till spellista</h3>
        <input type="text" id="standardPlaylistName" placeholder="Spellistans namn">
        <input type="text" id="standardPlaylistLink" placeholder="Klistra in Spotify-länken">
        <button id="addStandardPlaylistButton">Lägg till</button>
    </div>
</body>
</html>
