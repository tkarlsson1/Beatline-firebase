<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NOTESTREAM</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: url('background.jpg') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: start;
      min-height: 100vh;
    }
    .container {
      padding: 2rem;
      max-width: 500px;
      width: 100%;
      margin: 2rem 1rem;
    }
    .logo {
      display: block;
      margin: 0 auto 1.5rem auto;
      max-width: 80%;
      height: auto;
    }
    select, button {
      width: 25%;
      padding: 0.5rem;
      font-size: 1rem;
      margin-bottom: 1rem;
      background: #333;
      color: #fff;
      border: 1px solid #333;
      border-radius: 4px;
    }
    button:hover {
      background: #555;
    }
    #song-display {
      text-align: center;
      margin: 1.5rem 0;
    }
    .qrcode {
      width: 160px;
      height: 160px;
      border: 5px solid black;
      border-radius: 10px;
      display: block;
      margin: 0 auto 1rem auto;
    }
    #result-page {
      display: none;
    }
    /* Styling för spellistsval (checkbox-pills) */
    #source-checkbox-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 2rem;
      margin-bottom: 1rem;
    }
    .checkbox-pill input[type="checkbox"] {
      display: none;
    }
    .checkbox-pill label {
      cursor: pointer;
      padding: 0.5rem 1rem;
      border: 2px solid #fff;
      border-radius: 8px;
      transition: background 0.3s, color 0.3s, border-color 0.3s;
      color: #fff;
      font-size: 1rem;
      user-select: none;
    }
    .checkbox-pill input[type="checkbox"]:checked + label {
      background-color: #337ab7;
      color: #fff;
      border-color: #337ab7;
    }
    #filter-page label {
      color: #fff;
    }
    /* Ny sektion för Spotify-spellisteimport */
    #spotify-import {
      margin-bottom: 2rem;
      text-align: center;
      background: rgba(255,255,255,0.8);
      padding: 1rem;
      border-radius: 8px;
    }
    #spotify-import input {
      width: 80%;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
    }
    #spotify-import button {
      width: 40%;
      padding: 0.5rem;
    }
  </style>
  <!-- Inkludera QRCodeJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "DIN_API_KEY",
      authDomain: "beatlinefirebase.firebaseapp.com",
      databaseURL: "https://beatlinefirebase-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "beatlinefirebase",
      storageBucket: "beatlinefirebase.firebasestorage.app",
      messagingSenderId: "196231817325",
      appId: "1:196231817325:web:d5603a36a9c2c5f247f764"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let songs = [];  
    let filteredSongs = [];
    let shownSongs = [];
    let currentSong = null;

    onValue(ref(db, 'songs'), (snapshot) => {
      if (snapshot.exists()) {
        songs = Object.values(snapshot.val());
        populateSourceCheckboxes();
      } else {
        console.error("❌ Inga låtar hittades.");
      }
    });

    function populateSourceCheckboxes() {
      const container = document.getElementById("source-checkbox-container");
      container.innerHTML = "";
      let uniqueSources = [...new Set(songs.map(song => song.source))];
      uniqueSources.sort();
      uniqueSources.forEach(source => {
        const div = document.createElement("div");
        div.classList.add("checkbox-pill");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.name = "source";
        checkbox.value = source;
        checkbox.id = `source-${source.replace(/\s+/g, '-').toLowerCase()}`;
        checkbox.addEventListener("change", filterSongs);
        const label = document.createElement("label");
        label.setAttribute("for", checkbox.id);
        label.textContent = source;
        div.appendChild(checkbox);
        div.appendChild(label);
        container.appendChild(div);
      });
    }

    window.filterSongs = function() {
      const checkedBoxes = document.querySelectorAll('input[name="source"]:checked');
      let selectedSources = Array.from(checkedBoxes).map(cb => cb.value);
      filteredSongs = songs.filter(song => selectedSources.includes(song.source));
      shownSongs = [];
      if (filteredSongs.length > 0) {
        nextSong();
      } else {
        alert("Inga låtar hittades.");
      }
    };

    window.nextSong = function() {
      const remainingSongs = filteredSongs.filter(song => !shownSongs.includes(song));
      if (remainingSongs.length === 0) {
        alert("Inga fler låtar.");
        return;
      }
      currentSong = remainingSongs[Math.floor(Math.random() * remainingSongs.length)];
      shownSongs.push(currentSong);
      displaySong(currentSong);
    };

    function displaySong(song) {
      const songDisplay = document.getElementById("song-display");
      songDisplay.innerHTML = `
        <div id="qrcode-${song.qr}" class="qrcode"></div>
        <button onclick="revealDetails()">Visa svar</button>
        <div id="song-details" style="display: none;">
          <div>${song.year} - ${song.title} - ${song.artist}</div>
        </div>
      `;
      generateQRCode(song.qr);
    }

    window.generateQRCode = function(qr) {
      const qrElement = document.getElementById(`qrcode-${qr}`);
      qrElement.innerHTML = "";
      new QRCode(qrElement, { text: `https://open.spotify.com/track/${qr}`, width: 160, height: 160 });
    };

    window.revealDetails = function() {
      document.getElementById("song-details").style.display = "block";
    };
  </script>
</head>
<body>
  <div class="container">
    <img src="logga.png" alt="Notestream-beta logo" class="logo">
    
    <div id="spotify-import">
      <h3>Lägg till Spotify-spellista</h3>
      <input type="text" id="playlistLinkInput" placeholder="Klistra in Spotify-länken">
      <button id="addPlaylistButton">Lägg till spellista</button>
    </div>

    <div id="filter-page">
      <div id="source-checkbox-container"></div>
      <button onclick="filterSongs()">Starta spel</button>
    </div>

    <div id="result-page">
      <div id="song-display"></div>
      <button onclick="nextSong()">Nästa låt</button>
    </div>
  </div>
</body>
</html>
