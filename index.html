<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NOTESTREAM</title>
  <!-- Ladda Manrope -->
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    /* Grundläggande sidstil */
    body {
      font-family: 'Manrope', sans-serif;
      background: url('background.jpg') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: start;
      min-height: 100vh;
    }
    .container {
      padding: 2rem;
      max-width: 500px;
      width: 100%;
      margin: 2rem 1rem;
      position: relative;
      z-index: 1;
    }
    .logo {
      display: block;
      margin: 0 auto 1.5rem auto;
      max-width: 80%;
      height: auto;
    }
    /* Standardknappar i filterformuläret */
    select, button {
      width: 25%;
      padding: 0.5rem;
      font-size: 1rem;
      margin-bottom: 1rem;
      background: #333;
      color: #fff;
      border: 1px solid #fff;
      border-radius: 4px;
      font-family: 'Manrope', sans-serif;
    }
    select, button {
      border: none !important;
    }
    button:hover,
    button:active,
    button:focus {
      background: #333;
    }
    /* Årtalsfältens bredd */
    #startYear, #endYear {
      width: 80px;
    }
    #song-display {
      text-align: center;
      margin: 1.5rem 0;
    }
    #song-display canvas, #song-display img {
      display: block;
      margin: 0 auto;
    }
    .qrcode {
      width: 160px;
      height: 160px;
      border: 5px solid black;
      border-radius: 10px;
      display: block;
      margin: 0 auto 1rem auto;
    }
    /* Resultatsida – med extra padding nedtill */
    #result-page {
      display: none;
      position: relative;
      padding-bottom: 80px;
    }
    /* Styling för checkbox-pills */
    #source-checkbox-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.6rem;
      row-gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .checkbox-pill {
      position: relative;
    }
    .checkbox-pill input[type="checkbox"] {
      display: none;
    }
    .checkbox-pill label {
      cursor: pointer;
      padding: 0.5rem 1rem;
      border: 2px solid #fff;
      border-radius: 8px;
      transition: background 0.3s, color 0.3s, border-color 0.3s;
      color: #fff;
      font-size: 1rem;
      user-select: none;
      font-family: 'Manrope', sans-serif;
    }
    .checkbox-pill input[type="checkbox"]:checked + label {
      background-color: #0b939c;
      color: #fff;
      border-color: #0b939c;
    }
    #filter-page label {
      color: #fff;
    }
    /* Spotify-spellisteimport */
    #spotify-import {
      margin-bottom: 2rem;
      text-align: center;
      padding: 1rem;
      border-radius: 8px;
      color: #fff;
    }
    #spotify-import input, #playlistTypeInput {
      width: 40%;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-family: 'Manrope', sans-serif;
    }
    #spotify-import button {
      width: 40%;
      padding: 0.5rem;
      font-family: 'Manrope', sans-serif;
    }
    /* Header för spellistor */
    .allHeader {
      position: relative;
      width: 100%;
      text-align: center;
      margin-bottom: 1rem;
    }
    .allHeader button#lasForstButton {
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      font-family: 'Manrope', sans-serif;
    }
    .divider {
      height: 2px;
      background-color: #fff;
      width: 100%;
      margin: 0.5rem 0;
    }
    .subheading {
      display: block;
      width: 100%;
      text-align: center;
      font-size: 0.8rem;
      color: #fff;
      margin: 0.5rem 0;
    }
    /* Modal för Readme */
    #readmeModal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.7);
    }
    #readmeContent {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 600px;
      border-radius: 8px;
      position: relative;
      font-family: 'Manrope', sans-serif;
    }
    .closeBtn {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      position: absolute;
      top: 10px;
      right: 20px;
      cursor: pointer;
    }
    .closeBtn:hover,
    .closeBtn:focus { color: black; text-decoration: none; }
    /* Inloggningsmodal och registreringsmodal */
    #loginModal, #registerModal {
      position: fixed;
      z-index: 2000;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #loginBox, #registerBox {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      width: 80%;
      max-width: 300px;
      font-family: 'Manrope', sans-serif;
    }
    #loginBox input, #registerBox input {
      width: 80%;
      padding: 0.5rem;
      margin: 1rem 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }
    #loginBox button, #registerBox button {
      padding: 0.4rem 0.8rem;
      font-size: 1rem;
      background-color: #0b939c;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Manrope', sans-serif;
    }
    /* Felmeddelanden får klassen .error, istället för att dölja alla <p> i modaler */
    .error {
      color: red;
      display: none;
      font-size: 0.9rem;
    }
    /* Se till att övrig text (t.ex. "Inget konto? Registrera dig här") inte har klassen .error */
    /* Feedback-knapp */
    #feedbackButton {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #0b939c;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 24px;
      cursor: pointer;
      z-index: 1100;
      font-family: 'Manrope', sans-serif;
    }
    /* Feedback-modal */
    #feedbackModal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.7);
    }
    #feedbackModal > div {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 400px;
      border-radius: 8px;
      position: relative;
      font-family: 'Manrope', sans-serif;
    }
    #closeFeedback {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: #aaa;
    }
    #closeFeedback:hover,
    #closeFeedback:focus { color: black; text-decoration: none; }
    #feedbackText {
      width: 100%;
      height: 150px;
      padding: 10px;
      font-size: 1rem;
      box-sizing: border-box;
      font-family: 'Manrope', sans-serif;
    }
    #submitFeedback {
      margin-top: 10px;
      padding: 0.5rem 1rem;
      background-color: #ff9800;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Manrope', sans-serif;
    }
    /* Fasta knappar i resultatsidan */
    .startpage-button {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1500;
      padding: 0.5rem 1rem;
      width: 128px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      display: none;
      font-family: 'Manrope', sans-serif;
    }
    .next-song-button {
      display: block;
      margin: 0 auto;
      margin-bottom: 5rem;
      width: 128px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      font-family: 'Manrope', sans-serif;
    }
    .answer-button {
      display: block;
      margin: 0 auto;
      width: 128px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      font-family: 'Manrope', sans-serif;
    }
    .answer-button:hover,
    .answer-button:active,
    .answer-button:focus { background: #333; }
  </style>
  
  <!-- Inkludera QRCodeJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <!-- Importera Firebase SDK:er (app, database, auth) i modulformat -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, push } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
    import { 
      getAuth, 
      signInWithEmailAndPassword, 
      createUserWithEmailAndPassword,
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    
    const firebaseConfig = {
      apiKey: "DIN_API_KEY",
      authDomain: "beatlinefirebase.firebaseapp.com",
      databaseURL: "https://beatlinefirebase-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "beatlinefirebase",
      storageBucket: "beatlinefirebase.firebasestorage.app",
      messagingSenderId: "196231817325",
      appId: "1:196231817325:web:d5603a36a9c2c5f247f764"
    };
    
    // Initiera app, database och auth
    const app = initializeApp(firebaseConfig);
    window.app = app;
    const db = getDatabase(app);
    const auth = getAuth(app);
    
    // Kör DOM-relaterad kod när innehållet är laddat
    document.addEventListener("DOMContentLoaded", () => {
      // Hantera autentiseringsstatus – visa login-/registreringsmodal om ingen är inloggad
      onAuthStateChanged(auth, (user) => {
        if (user) {
          console.log("Inloggad användare:", user.email);
          document.getElementById("loginModal").style.display = "none";
          document.getElementById("registerModal").style.display = "none";
        } else {
          console.log("Ingen användare inloggad.");
          document.getElementById("loginModal").style.display = "flex";
        }
      });
      
      // Inloggningsfunktion
      const loginButton = document.getElementById("loginButton");
      if (loginButton) {
        loginButton.addEventListener("click", () => {
          const email = document.getElementById("emailInput").value.trim();
          const password = document.getElementById("passwordInput").value;
          signInWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
              console.log("Inloggning lyckades:", userCredential.user.email);
              document.getElementById("loginError").style.display = "none";
            })
            .catch((error) => {
              console.error("Inloggningsfel:", error);
              document.getElementById("loginError").style.display = "block";
            });
        });
      }
      
      // Registreringsfunktion
      const registerButton = document.getElementById("registerButton");
      if (registerButton) {
        registerButton.addEventListener("click", () => {
          const email = document.getElementById("regEmail").value.trim();
          const password = document.getElementById("regPassword").value;
          createUserWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
              console.log("Registrering lyckades:", userCredential.user.email);
              document.getElementById("registerError").style.display = "none";
              document.getElementById("registerModal").style.display = "none";
            })
            .catch((error) => {
              console.error("Registreringsfel:", error);
              document.getElementById("registerError").style.display = "block";
              document.getElementById("registerError").textContent = error.message;
            });
        });
      }
      
      // Växla mellan modaler
      const showRegisterBtn = document.getElementById("showRegister");
      if (showRegisterBtn) {
        showRegisterBtn.addEventListener("click", () => {
          document.getElementById("loginModal").style.display = "none";
          document.getElementById("registerModal").style.display = "flex";
        });
      }
      const showLoginBtn = document.getElementById("showLogin");
      if (showLoginBtn) {
        showLoginBtn.addEventListener("click", () => {
          document.getElementById("registerModal").style.display = "none";
          document.getElementById("loginModal").style.display = "flex";
        });
      }
    });
    
    /* ----- Övrig kod för databashantering, spellistor osv. (oförändrad) ----- */
    let standardSongs = [];
    let userPlaylistSongs = [];
    let songs = [];
    let sourceFilteredSongs = [];
    let currentFilteredSongs = [];
    let shownSongs = [];
    let currentSong = null;
    
    onValue(ref(db, 'standardLists'), (snapshot) => {
      if (snapshot.exists()) {
        const rawPlaylists = snapshot.val();
        standardSongs = [];
        for (const playlistName in rawPlaylists) {
          const playlistData = rawPlaylists[playlistName];
          if (playlistData.songs) {
            const tracks = playlistData.songs;
            for (const trackId in tracks) {
              standardSongs.push({
                qr: trackId,
                ...tracks[trackId],
                source: [playlistName]
              });
            }
          }
        }
        mergeSongs();
      } else {
        console.error("? Inga standardspellistor hittades i 'standardLists'.");
        standardSongs = [];
        mergeSongs();
      }
    });
    
    onValue(ref(db, 'userPlaylists'), (snapshot) => {
      if (snapshot.exists()) {
        const rawPlaylists = snapshot.val();
        userPlaylistSongs = [];
        for (const playlistName in rawPlaylists) {
          const playlistData = rawPlaylists[playlistName];
          if (playlistData.songs) {
            const tracks = playlistData.songs;
            for (const trackId in tracks) {
              userPlaylistSongs.push({
                qr: trackId,
                ...tracks[trackId],
                source: [playlistName]
              });
            }
          }
        }
        mergeSongs();
      } else {
        console.error("? Inga användarspellistor hittades i 'userPlaylists'.");
        userPlaylistSongs = [];
        mergeSongs();
      }
    });
    
    function mergeSongs() {
      const merged = {};
      standardSongs.forEach(song => {
        merged[song.qr] = song;
      });
      userPlaylistSongs.forEach(song => {
        if (merged[song.qr]) {
          merged[song.qr].source = [...new Set([...merged[song.qr].source, ...song.source])];
        } else {
          merged[song.qr] = song;
        }
      });
      songs = Object.values(merged);
      console.log("? Sammankopplad låtsamling (unika spår):", songs.length);
      populateSourceCheckboxes();
    }
    
    function updateAllaCheckbox() {
      const nonAlla = document.querySelectorAll('input[name="source"]:not([value="alla"])');
      const allaBox = document.querySelector('input[name="source"][value="alla"]');
      let allChecked = true;
      nonAlla.forEach(chk => { if (!chk.checked) { allChecked = false; } });
      allaBox.checked = allChecked;
    }
    
    function populateSourceCheckboxes() {
      const container = document.getElementById("source-checkbox-container");
      container.innerHTML = "";
      
      const allHeader = document.createElement("div");
      allHeader.className = "allHeader";
      
      const allDiv = document.createElement("div");
      allDiv.classList.add("checkbox-pill");
      allDiv.style.display = "inline-block";
      const checkboxAll = document.createElement("input");
      checkboxAll.type = "checkbox";
      checkboxAll.name = "source";
      checkboxAll.value = "alla";
      checkboxAll.id = "source-alla";
      checkboxAll.addEventListener("change", function() {
          const allSourceCheckboxes = document.querySelectorAll('input[name="source"]');
          allSourceCheckboxes.forEach(chk => { chk.checked = this.checked; });
          updateYearSelection();
      });
      const labelAll = document.createElement("label");
      labelAll.setAttribute("for", "source-alla");
      labelAll.textContent = "Alla låtar";
      allDiv.appendChild(checkboxAll);
      allDiv.appendChild(labelAll);
      allHeader.appendChild(allDiv);
      container.appendChild(allHeader);
      
      const standardHeading = document.createElement("p");
      standardHeading.className = "subheading";
      standardHeading.textContent = "Standardlistor";
      container.appendChild(standardHeading);
      
      let standardSources = Array.from(new Set(standardSongs.map(song => song.source[0])));
      standardSources.sort();
      if (standardSources.length > 0) {
          standardSources.forEach(source => {
              const div = document.createElement("div");
              div.classList.add("checkbox-pill");
              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.name = "source";
              checkbox.value = source;
              const id = "standard-" + source.replace(/\s+/g, '-').toLowerCase();
              checkbox.id = id;
              checkbox.addEventListener("change", function() {
                  updateAllaCheckbox();
                  updateYearSelection();
              });
              const label = document.createElement("label");
              label.setAttribute("for", id);
              label.textContent = source;
              div.appendChild(checkbox);
              div.appendChild(label);
              container.appendChild(div);
          });
      }
      
      let divider = document.createElement("div");
      divider.className = "divider";
      container.appendChild(divider);
      
      const userHeading = document.createElement("p");
      userHeading.className = "subheading";
      userHeading.textContent = "Egna spellistor";
      container.appendChild(userHeading);
      
      let userSources = Array.from(new Set(userPlaylistSongs.map(song => song.source[0])));
      userSources = userSources.filter(src => !standardSources.includes(src));
      userSources.sort();
      if (userSources.length > 0) {
          userSources.forEach(source => {
              const div = document.createElement("div");
              div.classList.add("checkbox-pill");
              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.name = "source";
              checkbox.value = source;
              const id = "user-" + source.replace(/\s+/g, '-').toLowerCase();
              checkbox.id = id;
              checkbox.addEventListener("change", function() {
                  updateAllaCheckbox();
                  updateYearSelection();
              });
              const label = document.createElement("label");
              label.setAttribute("for", id);
              label.textContent = source;
              div.appendChild(checkbox);
              div.appendChild(label);
              container.appendChild(div);
          });
      }
    }
    
    window.updateYearSelection = function() {
      const checkedBoxes = document.querySelectorAll('input[name="source"]:checked');
      let selectedSources = Array.from(checkedBoxes).map(cb => cb.value);
      if (selectedSources.includes("alla")) {
        const allStandard = Array.from(new Set(standardSongs.map(song => song.source[0])));
        const allUser = Array.from(new Set(userPlaylistSongs.map(song => song.source[0])));
        selectedSources = [...new Set([...allStandard, ...allUser, "alla"])];
      }
      sourceFilteredSongs = songs.filter(song =>
        song.source.some(src => selectedSources.includes(src))
      );
      
      const startYearDropdown = document.getElementById("startYear");
      const endYearDropdown = document.getElementById("endYear");
      startYearDropdown.innerHTML = "";
      endYearDropdown.innerHTML = "";
      
      for (let year = 1950; year <= 2025; year++) {
        const optionStart = document.createElement("option");
        optionStart.value = year;
        optionStart.textContent = year;
        if (year === 1950) optionStart.selected = true;
        startYearDropdown.appendChild(optionStart);
        
        const optionEnd = document.createElement("option");
        optionEnd.value = year;
        optionEnd.textContent = year;
        if (year === 2025) optionEnd.selected = true;
        endYearDropdown.appendChild(optionEnd);
      }
    };
    
    window.filterSongs = function() {
      const startYear = parseInt(document.getElementById("startYear").value);
      const endYear = parseInt(document.getElementById("endYear").value);
      currentFilteredSongs = sourceFilteredSongs.filter(song =>
        parseInt(song.year) >= startYear && parseInt(song.year) <= endYear
      );
      shownSongs = [];
      if (currentFilteredSongs.length > 0) {
        nextSong();
        return true;
      } else {
        alert("Inga låtar hittades i den valda perioden.");
        document.getElementById("song-display").innerHTML = "";
        return false;
      }
    };
    
    window.applyFilter = function() {
      if (filterSongs()) {
        document.getElementById("filter-page").style.display = "none";
        document.getElementById("result-page").style.display = "block";
        document.getElementById("startpageButton").style.display = "block";
      }
    };
    
    window.nextSong = function() {
      const remainingSongs = currentFilteredSongs.filter(song => !shownSongs.includes(song));
      if (remainingSongs.length === 0) {
        alert("Inga fler låtar, tryck på Startsida för att börja om.");
        return;
      }
      const randomIndex = Math.floor(Math.random() * remainingSongs.length);
      currentSong = remainingSongs[randomIndex];
      shownSongs.push(currentSong);
      displaySong(currentSong);
    };
    
    window.restart = function() {
      shownSongs = [];
      currentSong = null;
      document.getElementById("song-display").innerHTML = "";
    };
    
    function displaySong(song) {
      const songDisplay = document.getElementById("song-display");
      songDisplay.innerHTML = `
        <div id="qrcode-${song.qr}" class="qrcode"></div>
        <button class="answer-button" onclick="revealDetails()">Visa svar</button>
        <div id="song-details" style="display: none; margin-top: 1rem; font-weight: bold;">
          <div class="year" style="font-size: 4em; color: #fff; text-shadow: 0 0 8px #000;">${song.year}</div>
          <div class="info" style="font-size: 1.4em; color: #fff; text-shadow: 0 0 8px #000;">
            ${song.artist}<br>${song.title}
          </div>
        </div>
      `;
      generateQRCode(song.qr);
    }
    
    window.generateQRCode = function(qr) {
      const spotifyUrl = `https://open.spotify.com/track/${qr}`;
      const qrElement = document.getElementById(`qrcode-${qr}`);
      qrElement.innerHTML = "";
      new QRCode(qrElement, { text: spotifyUrl, width: 160, height: 160 });
    };
    
    window.revealDetails = function() {
      document.getElementById("song-details").style.display = "block";
    };
    
    window.goToFilter = function() {
      const checkboxes = document.querySelectorAll('input[name="source"]');
      checkboxes.forEach(checkbox => { checkbox.checked = false; });
      updateYearSelection();
      restart();
      document.getElementById("result-page").style.display = "none";
      document.getElementById("filter-page").style.display = "block";
      document.getElementById("startpageButton").style.display = "none";
    };
    
    /***** NY SPOTIFY TOKEN OCH CACHING DEL *****/
    async function getBackendSpotifyToken() {
      console.log("getBackendSpotifyToken: Kontrollerar om cachat token finns...");
      const cachedToken = localStorage.getItem('spotifyToken');
      const tokenExpiry = localStorage.getItem('spotifyTokenExpiry');
      if (cachedToken && tokenExpiry && Date.now() < Number(tokenExpiry)) {
        console.log("Använder cachad token från backend:", cachedToken);
        return cachedToken;
      }
      try {
        console.log("Begär nytt token via backend...");
        const response = await fetch('https://api-grl2mze3sa-uc.a.run.app/getSpotifyToken', {
          method: 'POST'
        });
        if (!response.ok) {
          throw new Error(`HTTP-fel: ${response.status}`);
        }
        const data = await response.json();
        const token = data.access_token;
        const expiresIn = data.expires_in;
        const expiryTime = Date.now() + (expiresIn * 1000) - (60 * 1000);
        localStorage.setItem('spotifyToken', token);
        localStorage.setItem('spotifyTokenExpiry', expiryTime.toString());
        console.log("Hämtat nytt token via backend:", token);
        return token;
      } catch (error) {
        console.error("Fel vid hämtning av token via backend:", error);
        return null;
      }
    }
    
    async function fetchSpotifyPlaylist(playlistUrl) {
      console.log("fetchSpotifyPlaylist: Playlist URL mottagen:", playlistUrl);
      const playlistId = playlistUrl.split("/playlist/")[1].split("?")[0];
      console.log("fetchSpotifyPlaylist: Extraherat playlist-ID:", playlistId);
      
      const token = await getBackendSpotifyToken();
      let tracks = {};
      let nextUrl = `https://api.spotify.com/v1/playlists/${playlistId}/tracks`;
      while (nextUrl) {
        const response = await fetch(nextUrl, {
          headers: { "Authorization": `Bearer ${token}` }
        });
        const data = await response.json();
        data.items.forEach(item => {
          const trackId = item.track.id;
          tracks[trackId] = {
            title: item.track.name,
            artist: item.track.artists.map(artist => artist.name).join(", "),
            year: item.track.album.release_date ? item.track.album.release_date.substring(0,4) : null
          };
        });
        nextUrl = data.next;
      }
      return tracks;
    }
    
    async function addPlaylistToFirebase(playlistName, playlistUrl, playlistType) {
      try {
        console.log("addPlaylistToFirebase: Försöker hämta spellista med namn:", playlistName);
        console.log("addPlaylistToFirebase: Använder URL:", playlistUrl);
        const tracks = await fetchSpotifyPlaylist(playlistUrl);
        console.log("addPlaylistToFirebase: Hämtade spår:", tracks);
        if (playlistType === "standard") {
          const standardListsRef = ref(db, `standardLists/${playlistName}`);
          await set(standardListsRef, { songs: tracks });
          console.log("addPlaylistToFirebase: Spellista lagts till i StandardLists.");
          alert(`Spellistan "${playlistName}" har lagts till i StandardLists!`);
        } else {
          const userPlaylistsRef = ref(db, `userPlaylists/${playlistName}`);
          await set(userPlaylistsRef, { songs: tracks });
          console.log("addPlaylistToFirebase: Spellista lagts till i UserPlaylists.");
          alert(`Spellistan "${playlistName}" har lagts till i UserPlaylists!`);
        }
      } catch (error) {
        console.error("Fel vid hämtning av Spotify-spellista i addPlaylistToFirebase:", error);
        alert("Något gick fel vid hämtning av spellistan. Kontrollera att länken är korrekt.");
      }
    }
    
    document.getElementById("addPlaylistButton").addEventListener("click", () => {
      const playlistName = document.getElementById("playlistNameInput").value.trim();
      const playlistLink = document.getElementById("playlistLinkInput").value.trim();
      const playlistType = document.getElementById("playlistTypeInput").value;
      if (playlistName && playlistLink) {
        addPlaylistToFirebase(playlistName, playlistLink, playlistType);
      } else {
        alert("Fyll i både spellistans namn och länk!");
      }
    });
  </script>
  
</head>
<body>
  <!-- Inloggningsmodal -->
  <div id="loginModal">
    <div id="loginBox">
      <h2>Logga in</h2>
      <input type="email" id="emailInput" placeholder="Ange e-post" />
      <input type="password" id="passwordInput" placeholder="Ange lösenord" />
      <button id="loginButton">Logga in</button>
      <p id="loginError" class="error">Fel e-post eller lösenord!</p>
      <p>Inget konto? <button id="showRegister">Registrera dig här</button></p>
    </div>
  </div>
  
  <!-- Registreringsmodal -->
  <div id="registerModal" style="display:none;">
    <div id="registerBox">
      <h2>Registrera dig</h2>
      <input type="email" id="regEmail" placeholder="Ange din e-post" />
      <input type="password" id="regPassword" placeholder="Ange ditt lösenord" />
      <button id="registerButton">Registrera</button>
      <p id="registerError" class="error">Registrering misslyckades!</p>
      <p>Redan har du ett konto? <button id="showLogin">Logga in</button></p>
    </div>
  </div>
  
  <div class="container" id="mainContent">
    <img src="logga.png" alt="Notestream-beta logo" class="logo" />
    <!-- Filter-/Startsida -->
    <div id="filter-page">
      <div id="source-checkbox-container"></div>
      <div style="display: flex; flex-direction: column; align-items: center;">
        <label for="startYear">Från år:</label>
        <select id="startYear"></select>
        <label for="endYear" style="margin-top: 0.1rem;">Till år:</label>
        <select id="endYear"></select>
      </div>
      <!-- Spotify-spellisteimportsektionen -->
      <div id="spotify-import">
        <h3>Lägg till Spotify-spellista</h3>
        <input type="text" id="playlistNameInput" placeholder="Spellistans namn">
        <input type="text" id="playlistLinkInput" placeholder="Klistra in Spotify-länken">
        <select id="playlistTypeInput">
          <option value="standard">StandardLists</option>
          <option value="user" selected>UserPlaylists</option>
        </select>
        <button id="addPlaylistButton">Lägg till</button>
      </div>
      
      <button onclick="applyFilter()" style="display: block; margin: 0 auto;">Starta spel</button>
    </div>
    
    <!-- Resultatsida -->
    <div id="result-page">
      <div id="song-display"></div>
      <button onclick="nextSong()" class="next-song-button">Nästa låt</button>
    </div>
    
    <!-- Fasta "Startsida"-knappen -->
    <button id="startpageButton" class="startpage-button" onclick="goToFilter()">Startsida</button>
    
    <!-- Readme Modal -->
    <div id="readmeModal">
      <div id="readmeContent">
        <span class="closeBtn">&times;</span>
        <h2>NOTESTREAM-BETA</h2>
        <p>Test och säg vad du tycker!<br>
           Tankar kring allt från färg på text till funktioner uppskattas. Lämnas förslagsvis via knappen nere i högra hörnet.
        </p>
        <p>Tidigare har det funnits en funktion för att ändra årtal på låtar, den finns inte just nu men kommer att komma igen senare när man kan logga in som användare och då bara för dina egna uppladdade spellistor.</p>
        <p>För att förekomma det uppenbara, istället för att scanna QR-koder så borde knappen "Nästa låt" starta uppspelningen av låten direkt, men så verkar det inte vara möjligt i en webbversion.</p>
        <p>I webbversionen bygger spelet på att du i början gör ett antal val:<br>
           • Vilka förinställda spellistor vill du inkludera?<br>
           • Vilka årtal vill du inkludera låtar från, baserat på de spellistor du valt?<br>
           Utifrån dina val plockas sedan låtar inom de årtal du angivit.<br>
           Ingen låt ska kunna komma två gånger i samma spel, så länge du inte trycker på "Startsida" eller laddar om sidan.
        </p>
        <p>Du kan även välja att lägga till egna spellistor och kombinera dessa med de förinställda. Välj UserPlaylists innan du trycker Lägg till.</p>
        <p>Om du lägger till egna spellistor, tänk på att all data per låt (artist, titel, årtal) baseras på det unika spotify-id som finns i spellistan du lägger till.</p>
        <p>När du ska lägga till en lista, namnge den och klistra in länken i rätt fält. Länken hämtas genom att klicka "Dela" i Spotify och sedan kopiera länken.</p>
        <p>På sikt är målet att ha ett standardbibliotek med tusentals låtar samt användarspellistor som endast är synliga för respektive användare.<br>
           De listor som nu visas är exempeldata för att fylla upp databasen.
        </p>
      </div>
    </div>
    
    <!-- Feedback Button -->
    <button id="feedbackButton">??</button>
    
    <!-- Feedback Modal -->
    <div id="feedbackModal">
      <div>
        <span id="closeFeedback">&times;</span>
        <h2>Lämna feedback</h2>
        <textarea id="feedbackText" placeholder="Skriv din feedback här..."></textarea>
        <button id="submitFeedback">Skicka feedback</button>
      </div>
    </div>
  
  </div>
  
  <!-- Vanligt script för modal- och feedbackhantering -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Växla mellan logga in och registrera
      const showRegisterBtn = document.getElementById("showRegister");
      const showLoginBtn = document.getElementById("showLogin");
      
      if (showRegisterBtn) {
        showRegisterBtn.addEventListener("click", () => {
          document.getElementById("loginModal").style.display = "none";
          document.getElementById("registerModal").style.display = "flex";
        });
      }
      if (showLoginBtn) {
        showLoginBtn.addEventListener("click", () => {
          document.getElementById("registerModal").style.display = "none";
          document.getElementById("loginModal").style.display = "flex";
        });
      }
      
      // Readme Modal
      const readmeModal = document.getElementById("readmeModal");
      const closeBtn = document.querySelector(".closeBtn");
      closeBtn.addEventListener("click", function() {
        readmeModal.style.display = "none";
      });
      window.addEventListener("click", function(event) {
        if (event.target == readmeModal) {
          readmeModal.style.display = "none";
        }
      });
      
      // Feedback-hantering
      document.getElementById("feedbackButton").addEventListener("click", function() {
        document.getElementById("feedbackModal").style.display = "block";
      });
      document.getElementById("closeFeedback").addEventListener("click", function() {
        document.getElementById("feedbackModal").style.display = "none";
      });
      window.addEventListener("click", function(event) {
        if (event.target == document.getElementById("feedbackModal")) {
          document.getElementById("feedbackModal").style.display = "none";
        }
      });
      document.getElementById("submitFeedback").addEventListener("click", function() {
        alert("Tack för din feedback!");
        document.getElementById("feedbackText").value = "";
        document.getElementById("feedbackModal").style.display = "none";
      });
    });
  </script>
  
</body>
</html>
