<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Välj Källa & Generera QR-kod</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

    // Firebase-konfiguration
    const firebaseConfig = {
      apiKey: "DIN_API_KEY",
      authDomain: "beatlinefirebase.firebaseapp.com",
      databaseURL: "https://beatlinefirebase-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "beatlinefirebase",
      storageBucket: "beatlinefirebase.firebasestorage.app",
      messagingSenderId: "196231817325",
      appId: "1:196231817325:web:d5603a36a9c2c5f247f764"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const songsRef = ref(db, 'songs');

    let songs = [];
    let sourceFilteredSongs = [];   // Låtar filtrerade utifrån de valda källorna (flera alternativ)
    let currentFilteredSongs = [];  // Låtar filtrerade på både källa och årtal
    let shownSongs = [];            // Låtar som redan visats
    let currentSong = null;

    // Hämta data från Firebase
    onValue(songsRef, (snapshot) => {
      if (snapshot.exists()) {
        const rawSongs = snapshot.val();
        songs = Object.entries(rawSongs).map(([qr, data]) => ({ qr, ...data }));
        console.log("✅ Låtar uppdaterade från Firebase:", songs.length);
        populateSourceDropdown();
      } else {
        console.error("❌ Inga låtar hittades i Firebase.");
      }
    });

    // Fyll dropdownen med källor (spellistor)
    function populateSourceDropdown() {
      const sourceDropdown = document.getElementById("source");
      sourceDropdown.innerHTML = ""; // Rensa tidigare val

      // Lägg till alternativet "Alla källor" – förvalt markerat
      const optionAll = document.createElement("option");
      optionAll.value = "alla";
      optionAll.textContent = "Alla källor";
      optionAll.selected = true;
      sourceDropdown.appendChild(optionAll);

      // Lägg till övriga unika källor
      const uniqueSources = [...new Set(songs.map(song => song.source))];
      uniqueSources.forEach(source => {
        const option = document.createElement("option");
        option.value = source;
        option.textContent = source;
        sourceDropdown.appendChild(option);
      });
    }

    // Uppdatera årtalsdropdown baserat på de valda källorna
    window.updateYearSelection = function() {
      const sourceDropdown = document.getElementById("source");
      let selectedSources = Array.from(sourceDropdown.selectedOptions)
                                .map(option => option.value);
      
      // Om "alla" finns med, ersätt med alla unika källor från datan
      if (selectedSources.includes("alla")) {
        selectedSources = [...new Set(songs.map(song => song.source))];
      }
      
      // Filtrera låtar baserat på de aktiva källorna
      sourceFilteredSongs = songs.filter(song => selectedSources.includes(song.source));

      // Om inga låtar hittas, töm årtalsdropdownsen
      if (sourceFilteredSongs.length === 0) {
        document.getElementById("startYear").innerHTML = "";
        document.getElementById("endYear").innerHTML = "";
        return;
      }

      // Hämta årtalen och skapa dropdownsen
      const years = sourceFilteredSongs
                      .map(song => parseInt(song.year))
                      .filter(year => !isNaN(year))
                      .sort((a, b) => a - b);
      const minYear = Math.min(...years);
      const maxYear = Math.max(...years);

      const startYearDropdown = document.getElementById("startYear");
      const endYearDropdown = document.getElementById("endYear");
      startYearDropdown.innerHTML = "";
      endYearDropdown.innerHTML = "";

      for (let year = minYear; year <= maxYear; year++) {
        const optionStart = document.createElement("option");
        optionStart.value = year;
        optionStart.textContent = year;
        startYearDropdown.appendChild(optionStart);

        const optionEnd = document.createElement("option");
        optionEnd.value = year;
        optionEnd.textContent = year;
        endYearDropdown.appendChild(optionEnd);
      }
    };

    // Filtrera låtar baserat på valt årtal (använder sourceFilteredSongs)
    window.filterSongs = function() {
      const startYear = parseInt(document.getElementById("startYear").value);
      const endYear = parseInt(document.getElementById("endYear").value);

      currentFilteredSongs = sourceFilteredSongs.filter(song =>
        parseInt(song.year) >= startYear && parseInt(song.year) <= endYear
      );
      shownSongs = []; // Töm tidigare visade låtar

      if (currentFilteredSongs.length > 0) {
        nextSong();
      } else {
        alert("Inga låtar hittades i den valda perioden.");
        document.getElementById("song-display").innerHTML = "";
      }
    };

    // Visa en slumpad låt som ännu inte visats (på resultatsidan)
    window.nextSong = function() {
      const remainingSongs = currentFilteredSongs.filter(song => !shownSongs.includes(song));
      if (remainingSongs.length === 0) {
        alert("Inga fler låtar, tryck på Startsida för att börja om.");
        return;
      }
      const randomIndex = Math.floor(Math.random() * remainingSongs.length);
      currentSong = remainingSongs[randomIndex];
      shownSongs.push(currentSong);
      displaySong(currentSong);
    };

    // Återställ sessionen för visade låtar
    window.restart = function() {
      shownSongs = [];
      currentSong = null;
      document.getElementById("song-display").innerHTML = "";
    };

    // Visa vald låt – här visas endast QR-koden (ingen extra information)
    function displaySong(song) {
      const songDisplay = document.getElementById("song-display");
      songDisplay.innerHTML = `<div id="qrcode-${song.qr}"></div>`;
      generateQRCode(song.qr);
    }

    // Generera QR-kod för den aktuella låten
    window.generateQRCode = function(qr) {
      const spotifyUrl = `https://open.spotify.com/track/${qr}`;
      const qrElement = document.getElementById(`qrcode-${qr}`);
      qrElement.innerHTML = "";
      new QRCode(qrElement, spotifyUrl);
    };

    // Funktion som körs när användaren trycker på "Filtrera låtar" i startsidan
    window.applyFilter = function() {
      filterSongs();
      // Dölj filter-sidan och visa resultatsidan
      document.getElementById("filter-page").style.display = "none";
      document.getElementById("result-page").style.display = "block";
    };

    // Gå tillbaka till filter-sidan ("Startsida") på resultatsidan
    window.goToFilter = function() {
      restart();
      // Visa filter-sidan och dölj resultatsidan
      document.getElementById("result-page").style.display = "none";
      document.getElementById("filter-page").style.display = "block";
    };

  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <h1>Välj Källa & Generera QR-kod</h1>
  
  <!-- Filter-sida -->
  <div id="filter-page">
    <label for="source">Välj spellista/källa (flera kan väljas):</label>
    <select id="source" multiple onchange="updateYearSelection()"></select>
    <br><br>
    <label for="startYear">Välj lägsta år:</label>
    <select id="startYear"></select>
    <br><br>
    <label for="endYear">Välj högsta år:</label>
    <select id="endYear"></select>
    <br><br>
    <button onclick="applyFilter()">Filtrera låtar</button>
  </div>
  
  <!-- Resultatsida -->
  <div id="result-page" style="display: none;">
    <div id="song-display"></div>
    <br>
    <button onclick="nextSong()">Nästa låt</button>
    <button onclick="goToFilter()">Startsida</button>
  </div>
</body>
</html>
